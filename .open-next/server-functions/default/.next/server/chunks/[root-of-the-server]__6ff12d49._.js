module.exports=[146315,e=>{"use strict";e.i(423502);var t=e.i(249866);async function r(e){let r=JSON.stringify(e.body??{}),a={"content-type":"application/json",...e.headers??{}};if(e.secret){var n;let i,s,o,{timestamp:l,signature:u}=(i=(n={secret:e.secret,body:r}).timestamp??Math.floor(Date.now()/1e3),s=`t=${i}.${n.body}`,o=(0,t.hmacSha256Hex)(n.secret,s),{timestamp:i,signature:`t=${i},v1=${o}`});a["x-autlify-timestamp"]=String(l),a["x-autlify-signature"]=u}let i=new AbortController,s=setTimeout(()=>i.abort(),e.timeoutMs??15e3),o=Date.now();try{let t=await fetch(e.url,{method:"POST",headers:a,body:r,signal:i.signal}),n=Date.now()-o,s=await t.text().catch(()=>"");return{ok:t.ok,status:t.status,body:s,durationMs:n}}catch(t){let e=Date.now()-o;return{ok:!1,status:null,body:null,error:t?.message??String(t),durationMs:e}}finally{clearTimeout(s)}}e.s(["sendWebhookAttempt",()=>r])},774869,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),i=e.i(561916),s=e.i(174677),o=e.i(869741),l=e.i(316795),u=e.i(487718),d=e.i(995169),c=e.i(47587),p=e.i(666012),h=e.i(570101),v=e.i(626937),f=e.i(10372),g=e.i(193695);e.i(52474);var m=e.i(600220),w=e.i(89171),R=e.i(249866),y=e.i(569914),b=e.i(146315),x=e.i(843793);e.i(828189);var E=e.i(974389);async function _(e,t){try{let{provider:r,connectionId:a}=await t.params,n=await e.text(),i=Object.fromEntries(e.headers.entries()),s=await (0,y.getConnectionById)(a);if(!s||s.deletedAt)return w.NextResponse.json({error:"Connection not found"},{status:404});if(s.provider!==r)return w.NextResponse.json({error:"Provider mismatch"},{status:400});if("github"===r){let t=s.config?.webhookSecret;if(t&&!function(e){let t=e.signatureHeader||"";if(!t.startsWith("sha256="))return!1;let r=("sha256="+(0,R.hmacSha256Hex)(e.webhookSecret,e.rawBody)).replace("sha256=",""),a=t.replace("sha256=","");return(0,R.timingSafeEqualHex)(r,a)}({webhookSecret:t,rawBody:n,signatureHeader:e.headers.get("x-hub-signature-256")}))return w.NextResponse.json({error:"Invalid signature"},{status:401})}if("slack"===r){let t=s.config?.signingSecret;if(t&&!function(e){let t=Number(e.timestampHeader||"0");if(!t||!e.signatureHeader)return!1;let r=e.toleranceSeconds??300;if(Math.abs(Math.floor(Date.now()/1e3)-t)>r)return!1;let a=`v0:${t}:${"string"==typeof e.rawBody?e.rawBody:e.rawBody.toString("utf8")}`,n=(0,R.hmacSha256Hex)(e.signingSecret,a),i=`v0=${n}`,s=e.signatureHeader;return!!s.startsWith("v0=")&&(0,R.timingSafeEqualHex)(i.replace("v0=",""),s.replace("v0=",""))}({signingSecret:t,rawBody:n,timestampHeader:e.headers.get("x-slack-request-timestamp"),signatureHeader:e.headers.get("x-slack-signature")}))return w.NextResponse.json({error:"Invalid signature"},{status:401})}let o=null;try{o=n?JSON.parse(n):null}catch{o={raw:n}}if("slack"===r&&o?.type==="url_verification"&&o?.challenge)return w.NextResponse.json({challenge:o.challenge});let l=e.headers.get("x-github-delivery")||o?.event_id||o?.id||(0,R.sha256Hex)(n),u=await (0,y.createProviderEventIdempotent)({provider:r,connectionId:a,externalEventId:l,headers:i,payload:o}),d=function(e,t,r){if("github"===e){let e=t.get("x-github-event")||"github",a=r?.action;return a?[e,`${e}.${a}`]:[e]}if("slack"===e){let e=r?.type||"slack",t=r?.event?.type,a=[e];return t&&a.unshift(t),r?.event_id&&a.push(`event.${r.event_id}`),a}return[e]}(r,e.headers,o),c=(await x.db.$queryRaw(E.Prisma.sql`SELECT "id","url","events","isActive","secretHash"
                FROM "IntegrationWebhookSubscription"
                WHERE "connectionId" = ${a} AND "isActive" = true`)).filter(e=>{var t,a,n;let i;return t=e.events??[],a=d,n=r,!!((i=new Set(t)).has("*")||i.has(`${n}.*`))||a.some(e=>i.has(e))}),p=[];for(let e of c){let t=await (0,y.createDelivery)({subscriptionId:e.id,providerEventId:u?.id??null}),n={provider:r,connectionId:a,event:d[0]??r,receivedAt:new Date().toISOString(),data:o},i=await (0,b.sendWebhookAttempt)({url:e.url,secret:e.secretHash??null,body:n,headers:{"x-autlify-provider":r,"x-autlify-connection-id":a,"x-autlify-event":d[0]??r}});await (0,y.createAttempt)({deliveryId:t,statusCode:i.status??null,responseBody:i.body??null,error:i.error??null,durationMs:i.durationMs??null}),await (0,y.incrementDeliveryAttempt)(t,i.ok?"SUCCESS":"FAILED"),p.push({deliveryId:t,ok:i.ok,status:i.status})}return w.NextResponse.json({ok:!0,providerEventId:u?.id??null,matchedSubscriptions:c.length,deliveries:p})}catch(e){if(e instanceof Response)return e;return console.error(e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>_],834213);var S=e.i(834213);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/features/core/webhooks/providers/[provider]/ingest/[connectionId]/route",pathname:"/api/features/core/webhooks/providers/[provider]/ingest/[connectionId]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/features/core/webhooks/providers/[provider]/ingest/[connectionId]/route.ts",nextConfigOutput:"standalone",userland:S}),{workAsyncStorage:A,workUnitAsyncStorage:k,serverHooks:N}=C;function H(){return(0,a.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:k})}async function I(e,t,a){C.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/features/core/webhooks/providers/[provider]/ingest/[connectionId]/route";w=w.replace(/\/index$/,"")||"/";let R=await C.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:b,nextConfig:x,parsedUrl:E,isDraftMode:_,prerenderManifest:S,routerServerContext:A,isOnDemandRevalidate:k,revalidateOnlyGenerated:N,resolvedPathname:H,clientReferenceManifest:I,serverActionsManifest:P}=R,T=(0,o.normalizeAppPath)(w),O=!!(S.dynamicRoutes[T]||S.routes[H]),q=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!_){let e=!!S.routes[H],t=S.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await q();throw new g.NoFallbackError}}let D=null;!O||C.isDev||_||(D="/index"===(D=H)?"/":D);let $=!0===C.isDev||!O,j=O&&!$;P&&I&&(0,s.setManifestsSingleton)({page:w,clientReferenceManifest:I,serverActionsManifest:P});let M=e.method||"GET",U=(0,i.getTracer)(),B=U.getActiveScopeSpan(),F={params:b,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>C.onRequestError(e,t,a,n,A)},sharedContext:{buildId:y}},K=new l.NodeNextRequest(e),W=new l.NodeNextResponse(t),L=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let s=async e=>C.handle(L,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!o&&k&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=F.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(K,W,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:k})},!1,A),t}},d=await C.handleResponse({req:e,nextConfig:x,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:o});if(!O)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",k?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&O||g.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,v.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,W,new Response(d.value.body,{headers:g,status:d.value.status||200})),null};B?await l(B):await U.withPropagatedContext(e.headers,()=>U.trace(d.BaseServerSpan.handleRequest,{spanName:`${M} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:k})},!1,A),O)throw t;return await (0,p.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>H,"routeModule",()=>C,"serverHooks",()=>N,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>k],774869)},916005,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:buffer_00e2e67a._.js"].map(t=>e.l(t))).then(()=>t(951615)))},918707,e=>{e.v(t=>Promise.all(["server/chunks/2e4a4_@prisma_client_runtime_query_compiler_fast_bg_postgresql_mjs_35c4194d._.js"].map(t=>e.l(t))).then(()=>t(407142)))},480599,e=>{e.v(t=>Promise.all(["server/chunks/9c9c5_client_runtime_query_compiler_fast_bg_postgresql_wasm-base64_mjs_9e69af0b._.js"].map(t=>e.l(t))).then(()=>t(417734)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6ff12d49._.js.map