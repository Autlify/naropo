module.exports=[974389,e=>{"use strict";var t=e.i(67982);e.s(["Prisma",0,t])},312757,e=>{"use strict";async function t(e,t){return e.featureCreditBalance.findUnique({where:{scope_agencyId_subAccountId_featureKey:{scope:t.scope,agencyId:t.agencyId,subAccountId:t.subAccountId??"",featureKey:t.featureKey}}})}async function a(e,a){let n=await t(e,a);return n?n:e.featureCreditBalance.create({data:{scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId??"",featureKey:a.featureKey,balance:"0"}})}e.s(["getCreditBalance",()=>t,"getOrCreateCreditBalance",()=>a])},95927,e=>{"use strict";function t(e){return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()))}function a(e,t){let a=new Date(e);return a.setUTCDate(a.getUTCDate()+t),a}function n(e,r=new Date){let i=new Date(r);switch(e){case"DAILY":{let e=t(i),n=a(e,1);return{periodStart:e,periodEnd:n}}case"WEEKLY":{let e=i.getUTCDay(),n=a(t(i),-((e+6)%7)),r=a(n,7);return{periodStart:n,periodEnd:r}}case"YEARLY":return{periodStart:new Date(Date.UTC(i.getUTCFullYear(),0,1)),periodEnd:new Date(Date.UTC(i.getUTCFullYear()+1,0,1))};default:return{periodStart:new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth(),1)),periodEnd:new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth()+1,1))}}}function r(e,t,i=new Date){let o=Math.max(0,Math.floor(Number(t)||0));if(0===o)return n(e,i);let s=n(e,i);switch(e){case"DAILY":return{periodStart:a(s.periodStart,-o),periodEnd:a(s.periodEnd,-o)};case"WEEKLY":{let e=7*o;return{periodStart:a(s.periodStart,-e),periodEnd:a(s.periodEnd,-e)}}case"YEARLY":return{periodStart:new Date(Date.UTC(s.periodStart.getUTCFullYear()-o,0,1)),periodEnd:new Date(Date.UTC(s.periodEnd.getUTCFullYear()-o,0,1))};default:{let e=s.periodStart.getUTCFullYear(),t=s.periodStart.getUTCMonth();return{periodStart:new Date(Date.UTC(e,t-o,1)),periodEnd:new Date(Date.UTC(e,t-o+1,1))}}}}e.s(["getUsageWindow",()=>n,"getUsageWindowWithOffset",()=>r])},408401,e=>{"use strict";async function t(e,t){return e.featureCreditLedger.findUnique({where:{idempotencyKey:t}})}async function a(e,a){let n=await t(e,a.idempotencyKey);return n||e.featureCreditLedger.create({data:{scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId,featureKey:a.featureKey,type:a.type,delta:a.delta,reason:a.reason??null,periodStart:a.periodStart??null,periodEnd:a.periodEnd??null,stripePaymentIntentId:a.stripePaymentIntentId??null,stripeInvoiceId:a.stripeInvoiceId??null,idempotencyKey:a.idempotencyKey}})}e.s(["createCreditLedger",()=>a])},66569,e=>{"use strict";e.i(423502),e.i(828189);var t=e.i(974389),a=e.i(843793),n=e.i(307144),r=e.i(95927);async function i(e,t,a,n){let r=t.subAccountId??"",i=await e.usageTracking.findUnique({where:{scope_agencyId_subAccountId_featureKey_periodStart:{scope:t.scope,agencyId:t.agencyId,subAccountId:r,featureKey:t.featureKey,periodStart:t.periodStart}}});return i||e.usageTracking.create({data:{scope:t.scope,agencyId:t.agencyId,subAccountId:r,featureKey:t.featureKey,currentUsage:"0",period:n,periodStart:a.periodStart,periodEnd:a.periodEnd}})}async function o(e,t){return e.usageEvent.findUnique({where:{idempotencyKey:t}})}async function s(e,t){return e.usageEvent.create({data:t})}var u=e.i(312757),c=e.i(408401);async function d(e,a){let n=Math.max(0,Number(a.amount)||0);if(0===n||await e.featureCreditLedger.findUnique({where:{idempotencyKey:a.idempotencyKey}}))return{consumed:0,remaining:Number((await (0,u.getOrCreateCreditBalance)(e,{scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId,featureKey:a.featureKey})).balance.toString())};let r=await (0,u.getOrCreateCreditBalance)(e,{scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId,featureKey:a.featureKey}),i=Number(r.balance.toString()),o=i-n;return o<0?{consumed:0,remaining:i}:(await (0,c.createCreditLedger)(e,{scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId,featureKey:a.featureKey,type:"CONSUME",delta:new t.Prisma.Decimal(-n),reason:a.reason??"Usage consume",idempotencyKey:a.idempotencyKey}),{consumed:n,remaining:Number((await e.featureCreditBalance.update({where:{id:r.id},data:{balance:new t.Prisma.Decimal(o)}})).balance.toString())})}function l(e){if(null==e)return 0;let t=Number(e.toString?.()??e);return Number.isFinite(t)?t:0}async function p(e){let t=e.now??new Date,i=await (0,n.resolveEffectiveEntitlements)({scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId||null});if(!i.planId)return{allowed:!1,reason:"NO_SUBSCRIPTION",currentUsage:0,quantity:e.quantity,nextUsage:e.quantity};let o=i[e.featureKey];if(!o||!o.isEnabled)return{allowed:!1,reason:"FEATURE_DISABLED",currentUsage:0,quantity:e.quantity,nextUsage:e.quantity};let s=o.period??"MONTHLY",{periodStart:u}=(0,r.getUsageWindow)(s,t),c=await a.db.usageTracking.findUnique({where:{scope_agencyId_subAccountId_featureKey_periodStart:{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId||"",featureKey:e.featureKey,periodStart:u}}}),d=l(c?.currentUsage),p=Math.max(0,Number(e.quantity)||0),g=d+p,y=o.isUnlimited?null:null!=o.maxInt?Number(o.maxInt):null!=o.maxDec?Number(o.maxDec):null;if(null==y||g<=y)return{allowed:!0,overageMode:o.overageMode,currentUsage:d,quantity:p,nextUsage:g,maxAllowed:y};let f=g-y;if("INTERNAL_CREDITS"!==o.overageMode)return{allowed:!1,reason:"LIMIT_EXCEEDED",overageMode:o.overageMode,currentUsage:d,quantity:p,nextUsage:g,maxAllowed:y};let I=await a.db.featureCreditBalance.findUnique({where:{scope_agencyId_subAccountId_featureKey:{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId||"",featureKey:e.featureKey}}}),m=l(I?.balance);return m<f?{allowed:!1,reason:"INSUFFICIENT_CREDITS",overageMode:o.overageMode,currentUsage:d,quantity:p,nextUsage:g,maxAllowed:y,creditsAvailable:m,creditsRequired:f}:{allowed:!0,overageMode:o.overageMode,currentUsage:d,quantity:p,nextUsage:g,maxAllowed:y,creditsAvailable:m,creditsRequired:f}}async function g(e){let c=e.now??new Date;return a.db.$transaction(async a=>{let p=await o(a,e.idempotencyKey);if(p){let e=l(p.quantity);return{allowed:!0,currentUsage:0,quantity:e,nextUsage:e,creditsConsumed:0}}let g=await (0,n.resolveEffectiveEntitlements)({scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId??null});if(!g.planId)return{allowed:!1,reason:"NO_SUBSCRIPTION",currentUsage:0,quantity:e.quantity,nextUsage:e.quantity};let y=g[e.featureKey];if(!y||!y.isEnabled)return{allowed:!1,reason:"FEATURE_DISABLED",currentUsage:0,quantity:e.quantity,nextUsage:e.quantity};let f=y.period??"MONTHLY",{periodStart:I,periodEnd:m}=(0,r.getUsageWindow)(f,c),w=await i(a,{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId||"",featureKey:e.featureKey,periodStart:I},{periodStart:I,periodEnd:m},f),h=l(w.currentUsage),E=Math.max(0,Number(e.quantity)||0),b=h+E,A=y.isUnlimited?null:null!=y.maxInt?Number(y.maxInt):null!=y.maxDec?Number(y.maxDec):null,C=0;if(null!=A&&b>A){let t=b-A;if("INTERNAL_CREDITS"!==y.overageMode)return{allowed:!1,reason:"LIMIT_EXCEEDED",overageMode:y.overageMode,currentUsage:h,quantity:E,nextUsage:b,maxAllowed:A};let n=await (0,u.getCreditBalance)(a,{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId??null,featureKey:e.featureKey}),r=l(n?.balance);if(r<t)return{allowed:!1,reason:"INSUFFICIENT_CREDITS",overageMode:y.overageMode,currentUsage:h,quantity:E,nextUsage:b,maxAllowed:A,creditsAvailable:r,creditsRequired:t};C=t,await d(a,{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId??null,featureKey:e.featureKey,amount:t,idempotencyKey:`consume:${e.idempotencyKey}`,reason:`Usage overage for ${e.featureKey}`})}return await s(a,{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId??null,featureKey:e.featureKey,quantity:new t.Prisma.Decimal(E),actionKey:e.actionKey??null,idempotencyKey:e.idempotencyKey}),await a.usageTracking.update({where:{id:w.id},data:{currentUsage:new t.Prisma.Decimal(b),lastEventAt:c}}),{allowed:!0,overageMode:y.overageMode,currentUsage:h,quantity:E,nextUsage:b,maxAllowed:A,creditsConsumed:C}})}e.s(["checkUsage",()=>p,"consumeUsage",()=>g],66569)},340087,e=>{"use strict";var t=e.i(747909),a=e.i(174017),n=e.i(996250),r=e.i(759756),i=e.i(561916),o=e.i(174677),s=e.i(869741),u=e.i(316795),c=e.i(487718),d=e.i(995169),l=e.i(47587),p=e.i(666012),g=e.i(570101),y=e.i(626937),f=e.i(10372),I=e.i(193695);e.i(52474);var m=e.i(600220),w=e.i(89171),h=e.i(698902);e.i(423502);var E=e.i(843793),b=e.i(907117),A=e.i(73903),C=e.i(66569);let v=["core.billing.account.view","core.billing.account.manage"];async function T(e,t,a){return a?!!await E.db.subAccountMembership.findFirst({where:{userId:e,subAccountId:a,isActive:!0},select:{id:!0}}):!!await E.db.agencyMembership.findFirst({where:{userId:e,agencyId:t,isActive:!0},select:{id:!0}})}async function U(e,t,a,n){if(0===n.length)return!0;if(a){for(let e of n)if(!await (0,b.hasSubAccountPermission)(a,e))return!1;return!0}for(let e of n)if(!await (0,b.hasAgencyPermission)(t,e))return!1;return!0}async function R(e,t,a,n){for(let e of n?.length?n:v)if(await (0,b.hasAgencyPermission)(t,e))return!0;return!1}let _=async e=>{let{userId:t,agencyId:a,subAccountId:n=null,requiredPermissionKey:r,requiredPermissionKeys:i,requireActiveSubscription:o=!0,featureKey:s,quantity:u=1,actionKey:c,billingPermissionKeys:d}=e;if(!await T(t,a,n))return{allowed:!1,reason:"NO_MEMBERSHIP",message:"You do not have access to this workspace.",suggestion:"NONE"};let l=[...r?[r]:[],...i??[]].map(e=>e.trim()).filter(Boolean);if(!await U(t,a,n,l))return{allowed:!1,reason:"NO_PERMISSION",message:"You do not have permission to perform this action.",suggestion:"NONE"};let p=await (0,A.getAgencySubscriptionState)(a);if(o&&"ACTIVE"!==p&&"TRIAL"!==p){let e=await R(t,a,n,d);return{allowed:!1,reason:"NO_SUBSCRIPTION",message:"This workspace does not have an active subscription.",suggestion:e?"UPGRADE":"CONTACT_ADMIN",subscription:p,hasBillingAccess:e}}if(!s)return{allowed:!0,subscription:p,hasBillingAccess:await R(t,a,n,d)};let g=n?"SUBACCOUNT":"AGENCY",y=await (0,C.checkUsage)({scope:g,agencyId:a,subAccountId:n,featureKey:s,quantity:u,actionKey:c});if(y.allowed)return{allowed:!0,subscription:p,usage:y,hasBillingAccess:await R(t,a,n,d)};let f=await R(t,a,n,d);return"FEATURE_DISABLED"===y.reason?{allowed:!1,reason:"FEATURE_DISABLED",message:"This feature is not enabled for the current plan.",suggestion:f?"UPGRADE":"CONTACT_ADMIN",subscription:p,usage:y,hasBillingAccess:f}:"INSUFFICIENT_CREDITS"===y.reason?{allowed:!1,reason:"INSUFFICIENT_CREDITS",message:"You have insufficient credits to perform this action.",suggestion:f?"TOPUP":"CONTACT_ADMIN",subscription:p,usage:y,hasBillingAccess:f}:{allowed:!1,reason:"LIMIT_EXCEEDED",message:"You have exceeded the current plan limit.",suggestion:f?"UPGRADE":"CONTACT_ADMIN",subscription:p,usage:y,hasBillingAccess:f}};async function D(e){let t=await (0,h.auth)(),a=t?.user?.id;if(!a)return w.NextResponse.json({error:"Unauthenticated"},{status:401});let n=await e.json().catch(()=>null);if(!n||!n.agencyId||!n.featureKey)return w.NextResponse.json({error:"agencyId and featureKey are required"},{status:400});n.subAccountId;let r=n.quantity??1,i=await _({userId:a,agencyId:n.agencyId,subAccountId:n.subAccountId??null,requiredPermissionKey:n.requiredPermissionKey,requiredPermissionKeys:n.requiredPermissionKeys,billingPermissionKeys:n.billingPermissionKeys,featureKey:n.featureKey,quantity:r,actionKey:n.actionKey,requireActiveSubscription:n.requireActiveSubscription??!0});return w.NextResponse.json(i)}e.s(["POST",()=>D],830574);var N=e.i(830574);let S=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/features/core/billing/usage/check/route",pathname:"/api/features/core/billing/usage/check",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/features/core/billing/usage/check/route.ts",nextConfigOutput:"standalone",userland:N}),{workAsyncStorage:K,workUnitAsyncStorage:P,serverHooks:x}=S;function q(){return(0,n.patchFetch)({workAsyncStorage:K,workUnitAsyncStorage:P})}async function M(e,t,n){S.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/features/core/billing/usage/check/route";w=w.replace(/\/index$/,"")||"/";let h=await S.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!h)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:b,nextConfig:A,parsedUrl:C,isDraftMode:v,prerenderManifest:T,routerServerContext:U,isOnDemandRevalidate:R,revalidateOnlyGenerated:_,resolvedPathname:D,clientReferenceManifest:N,serverActionsManifest:K}=h,P=(0,s.normalizeAppPath)(w),x=!!(T.dynamicRoutes[P]||T.routes[D]),q=async()=>((null==U?void 0:U.render404)?await U.render404(e,t,C,!1):t.end("This page could not be found"),null);if(x&&!v){let e=!!T.routes[D],t=T.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await q();throw new I.NoFallbackError}}let M=null;!x||S.isDev||v||(M="/index"===(M=D)?"/":M);let O=!0===S.isDev||!x,F=x&&!O;K&&N&&(0,o.setManifestsSingleton)({page:w,clientReferenceManifest:N,serverActionsManifest:K});let k=e.method||"GET",L=(0,i.getTracer)(),B=L.getActiveScopeSpan(),Y={params:b,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>S.onRequestError(e,t,n,r,U)},sharedContext:{buildId:E}},H=new u.NodeNextRequest(e),j=new u.NodeNextResponse(t),$=c.NextRequestAdapter.fromNodeNextRequest(H,(0,c.signalFromNodeResponse)(t));try{let o=async e=>S.handle($,Y).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=L.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${k} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${w}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),u=async r=>{var i,u;let c=async({previousCacheEntry:a})=>{try{if(!s&&R&&_&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(r);e.fetchMetrics=Y.renderOpts.fetchMetrics;let u=Y.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let c=Y.renderOpts.collectedTags;if(!x)return await (0,p.sendResponse)(H,j,i,Y.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==Y.renderOpts.collectedRevalidate&&!(Y.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&Y.renderOpts.collectedRevalidate,n=void 0===Y.renderOpts.collectedExpire||Y.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:Y.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:R})},!1,U),t}},d=await S.handleResponse({req:e,nextConfig:A,cacheKey:M,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:R,revalidateOnlyGenerated:_,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:s});if(!x)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",R?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let I=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&x||I.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||I.get("Cache-Control")||I.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(H,j,new Response(d.value.body,{headers:I,status:d.value.status||200})),null};B?await u(B):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${k} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},u))}catch(t){if(t instanceof I.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:R})},!1,U),x)throw t;return await (0,p.sendResponse)(H,j,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>q,"routeModule",()=>S,"serverHooks",()=>x,"workAsyncStorage",()=>K,"workUnitAsyncStorage",()=>P],340087)},916005,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:buffer_00e2e67a._.js"].map(t=>e.l(t))).then(()=>t(951615)))},918707,e=>{e.v(t=>Promise.all(["server/chunks/2e4a4_@prisma_client_runtime_query_compiler_fast_bg_postgresql_mjs_35c4194d._.js"].map(t=>e.l(t))).then(()=>t(407142)))},480599,e=>{e.v(t=>Promise.all(["server/chunks/9c9c5_client_runtime_query_compiler_fast_bg_postgresql_wasm-base64_mjs_9e69af0b._.js"].map(t=>e.l(t))).then(()=>t(417734)))},642072,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__02f5c049._.js","server/chunks/_b96aa026._.js"].map(t=>e.l(t))).then(()=>t(485849)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__5bc497aa._.js.map