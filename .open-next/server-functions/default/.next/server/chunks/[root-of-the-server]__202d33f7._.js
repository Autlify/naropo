module.exports=[307144,e=>{"use strict";e.i(423502);var t=e.i(843793);function n(e){return null==e?null:"string"==typeof e?e:e.toString()}let r=new Set(["ACTIVE","TRIALING"]),a="false"!==process.env.ENTITLEMENTS_SUBACCOUNT_INHERIT_AGENCY;async function s(e){if("SUBACCOUNT"!==e.scope)return!1;if(null!=e.inheritAgencyEntitlements)return!!e.inheritAgencyEntitlements;if(e.subAccountId){let n=await t.db.subAccountSettings.findUnique({where:{subAccountId:e.subAccountId},select:{entitlementsInheritFromAgency:!0}});if(n?.entitlementsInheritFromAgency!=null)return!!n.entitlementsInheritFromAgency}let n=await t.db.agencySettings.findUnique({where:{agencyId:e.agencyId},select:{entitlementsInheritToSubaccounts:!0}});return n?.entitlementsInheritToSubaccounts??a}async function i(e,n=new Date){let a=await t.db.subscription.findFirst({where:{agencyId:e,status:{in:Array.from(r)},currentPeriodEndDate:{gt:n}},select:{priceId:!0}});return a?.priceId??null}async function o(e,n=new Date){return Array.from(new Set([await i(e,n),...(await t.db.addOns.findMany({where:{agencyId:e,active:!0},select:{priceId:!0}})).map(e=>e.priceId)].filter(Boolean)))}function c(e,t){let n=e??null,r=t??null;return null==n&&null==r?null:(n??0)+(r??0)}function u(e,t){return null==e&&null==t?null:null==e?t:null==t?e:e.plus?.(t)??e}async function d(e){let r=e.now??new Date,a=e.planId,i=a?[a]:await o(e.agencyId,r);if(!i.length)return{};let d=await t.db.planFeature.findMany({where:{planId:{in:i}},include:{EntitlementFeature:!0}}),l=new Map;for(let e of d){let t=l.get(e.featureKey)??[];t.push(e),l.set(e.featureKey,t)}let p=[];for(let[,e]of l)p.push(1===e.length?e[0]:function(e){let t=e[0];if(!t)throw Error("mergePlanFeatures called with empty list");return{...t,isEnabled:e.some(e=>e.isEnabled),isUnlimited:e.some(e=>e.isUnlimited),includedInt:e.reduce((e,t)=>c(e,t.includedInt),null),maxInt:e.reduce((e,t)=>c(e,t.maxInt),null),includedDec:e.reduce((e,t)=>u(e,t.includedDec),null),maxDec:e.reduce((e,t)=>u(e,t.maxDec),null),recurringCreditGrantInt:e.reduce((e,t)=>c(e,t.recurringCreditGrantInt),null),recurringCreditGrantDec:e.reduce((e,t)=>u(e,t.recurringCreditGrantDec),null),rolloverCredits:e.some(e=>e.rolloverCredits),topUpEnabled:e.some(e=>e.topUpEnabled),topUpPriceId:e.find(e=>e.topUpPriceId)?.topUpPriceId??t.topUpPriceId,enforcement:e.some(e=>"HARD"===e.enforcement)?"HARD":t.enforcement,overageMode:t.overageMode,overageFee:t.overageFee,stripeOveragePriceId:t.stripeOveragePriceId}}(e));let I=await s(e)?await t.db.entitlementOverride.findMany({where:{scope:"AGENCY",agencyId:e.agencyId,subAccountId:null,startsAt:{lte:r},OR:[{endsAt:null},{endsAt:{gte:r}}]}}):[],y=await t.db.entitlementOverride.findMany({where:{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId||null,startsAt:{lte:r},OR:[{endsAt:null},{endsAt:{gte:r}}]}}),g=[...I,...y],A=new Map;for(let e of I)A.set(e.featureKey,e);for(let e of y)A.set(e.featureKey,e);let m={};for(let e of p)m[e.featureKey]=function(e,t){let r=e.EntitlementFeature,a=(t?.isEnabled??!0)&&e.isEnabled,s=t?.isUnlimited??e.isUnlimited,i=e.maxInt??null,o=t?.maxOverrideInt!=null?t.maxOverrideInt:null!=i?i+(t?.maxDeltaInt??0):null,c=null!=e.maxDec?n(e.maxDec):null,u=t?.maxOverrideDec!=null?n(t.maxOverrideDec):null!=c?n(e.maxDec.plus?.(t?.maxDeltaDec??0)??e.maxDec):null;return{featureKey:e.featureKey,name:r.name,category:r.category,description:r.description,valueType:r.valueType,unit:r.unit,metering:r.metering,aggregation:r.aggregation,scope:r.scope,period:r.period,isEnabled:a,isUnlimited:s,includedInt:e.includedInt??null,maxInt:o,includedDec:null!=e.includedDec?n(e.includedDec):null,maxDec:u,enforcement:e.enforcement,overageMode:e.overageMode,creditEnabled:r.creditEnabled,creditUnit:r.creditUnit??null,creditExpires:r.creditExpires,creditPriority:r.creditPriority,recurringCreditGrantInt:e.recurringCreditGrantInt??null,recurringCreditGrantDec:null!=e.recurringCreditGrantDec?n(e.recurringCreditGrantDec):null,rolloverCredits:e.rolloverCredits,topUpEnabled:e.topUpEnabled,topUpPriceId:e.topUpPriceId??null}}(e,A.get(e.featureKey)||null);for(let e of g){if(m[e.featureKey])continue;let n=await t.db.entitlementFeature.findUnique({where:{key:e.featureKey}});n&&(m[e.featureKey]={featureKey:n.key,name:n.name,category:n.category,description:n.description,valueType:n.valueType,unit:n.unit,metering:n.metering,aggregation:n.aggregation,scope:n.scope,period:n.period,isEnabled:e.isEnabled??!1,isUnlimited:e.isUnlimited??!1,includedInt:0,maxInt:e.maxOverrideInt??e.maxDeltaInt??null,includedDec:"0",maxDec:e.maxOverrideDec?e.maxOverrideDec.toString():e.maxDeltaDec?e.maxDeltaDec.toString():null,enforcement:"HARD",overageMode:"NONE",creditEnabled:n.creditEnabled,creditUnit:n.creditUnit??null,creditExpires:n.creditExpires,creditPriority:n.creditPriority,recurringCreditGrantInt:null,recurringCreditGrantDec:null,rolloverCredits:!1,topUpEnabled:!1,topUpPriceId:null})}return m}function l(e){return e?"SUBACCOUNT":"AGENCY"}e.s(["inferScopeFromIds",()=>l,"resolveEffectiveEntitlements",()=>d],307144)},661418,e=>{"use strict";e.i(423502),e.i(551783);var t=e.i(379509),n=e.i(73903),r=e.i(698902),a=e.i(254799),s=e.i(843793);let i="autl_",o=async e=>{var t,n;let r,o,c,u=(e=>{let t=e.trim();if(!t)return null;if(t.startsWith(i)){let[e,n]=t.slice(i.length).split("_",2);return e&&n?{prefix:e,secret:n}:null}if(t.includes(".")){let[e,n]=t.split(".",2);return e&&n?{prefix:e,secret:n}:null}return null})(e.token);if(!u)return null;let d=await s.db.apiKey.findUnique({where:{prefix:u.prefix},select:{id:!0,kind:!0,ownerUserId:!0,agencyId:!0,subAccountId:!0,allowedSubAccountIds:!0,permissionKeys:!0,secretHash:!0,expiresAt:!0,revokedAt:!0}});return!d||d.revokedAt||d.expiresAt&&d.expiresAt.getTime()<=Date.now()?null:(r=u.secret,t=a.default.createHash("sha256").update(r,"utf8").digest("hex"),n=d.secretHash,o=Buffer.from(t,"hex"),c=Buffer.from(n,"hex"),o.length===c.length&&a.default.timingSafeEqual(o,c))?((e.touchLastUsedAt??!0)&&s.db.apiKey.update({where:{id:d.id},data:{lastUsedAt:new Date}}).catch(()=>null),{id:d.id,kind:d.kind,ownerUserId:d.ownerUserId,agencyId:d.agencyId,subAccountId:d.subAccountId,allowedSubAccountIds:d.allowedSubAccountIds??[],permissionKeys:d.permissionKeys??[],expiresAt:d.expiresAt,revokedAt:d.revokedAt}):null},c=(e,t)=>{let n=e.get(t);if(n)return n;let r=t.toLowerCase();if(r!==t){let t=e.get(r);if(t)return t}return null},u=async e=>{let t=(e=>{let t=e.get("authorization")||e.get("Authorization");if(!t)return null;let n=t.trim().split(/\s+/,2);return 2!==n.length||"bearer"!==n[0].toLowerCase()?null:n[1]})(e.headers)||c(e.headers,"x-autlify-api-key");if(t){let e=await o({token:t});return e?{kind:"apiKey",apiKeyId:e.id,apiKeyKind:e.kind,ownerUserId:e.ownerUserId,agencyId:e.agencyId,subAccountId:e.subAccountId,allowedSubAccountIds:e.allowedSubAccountIds,permissionKeys:e.permissionKeys}:null}let n=await (0,r.auth)(),a=n?.user?.id;return a?{kind:"user",userId:a}:null};class d extends Error{status;code;constructor(e){super(e.message),this.name="AutlifyContextError",this.status=e.status,this.code=e.code}}let l=async e=>{let t=await s.db.subAccount.findUnique({where:{id:e.subAccountId},select:{agencyId:!0}});return!!t&&t.agencyId===e.agencyId},p=async e=>{let t,r,a=c(t=e.headers,"x-autlify-agency-id")||c(t,"x-autlify-agency"),i=c(r=e.headers,"x-autlify-subaccount-id")||c(r,"x-autlify-subaccount"),o=async e=>{let t=await (0,n.resolveAgencyContextForUser)(e);if(!t)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"No agency membership for requested context"});return t},u=async e=>{let t=await (0,n.resolveSubAccountContextForUser)(e);if(!t)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"No subaccount membership for requested context"});return t};if("apiKey"===e.principal.kind){let t=e.principal;if("AGENCY"===t.apiKeyKind){if(!t.agencyId)throw new d({status:500,code:"CONTEXT_INVALID",message:"Agency api key missing agencyId"});if(a&&a!==t.agencyId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Agency header does not match api key scope"});if(i){if(!await l({subAccountId:i,agencyId:t.agencyId}))throw new d({status:404,code:"CONTEXT_INVALID",message:"Subaccount does not belong to agency"});if(t.allowedSubAccountIds?.length&&!t.allowedSubAccountIds.includes(i))throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Api key not allowed to access this subaccount"});return{kind:"subaccount",agencyId:t.agencyId,subAccountId:i}}return{kind:"agency",agencyId:t.agencyId}}if("SUBACCOUNT"===t.apiKeyKind){if(!t.subAccountId)throw new d({status:500,code:"CONTEXT_INVALID",message:"Subaccount api key missing subAccountId"});if(i&&i!==t.subAccountId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Subaccount header does not match api key scope"});let e=t.agencyId||(await s.db.subAccount.findUnique({where:{id:t.subAccountId},select:{agencyId:!0}}))?.agencyId;if(!e)throw new d({status:404,code:"CONTEXT_INVALID",message:"Subaccount not found for api key"});return{kind:"subaccount",agencyId:e,subAccountId:t.subAccountId}}if(!a&&!i)throw new d({status:400,code:"CONTEXT_MISSING",message:"Missing x-autlify-agency or x-autlify-subaccount header"});if(i){let e=await u({userId:t.ownerUserId,subAccountId:i});if(a&&a!==e.agencyId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Agency header does not match subaccount agency"});return{kind:"subaccount",agencyId:e.agencyId,subAccountId:i}}return await o({userId:t.ownerUserId,agencyId:a}),{kind:"agency",agencyId:a}}if(!a&&!i)throw new d({status:400,code:"CONTEXT_MISSING",message:"Missing x-autlify-agency or x-autlify-subaccount header"});if(i){let t=await u({userId:e.principal.userId,subAccountId:i});if(a&&a!==t.agencyId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Agency header does not match subaccount agency"});return{kind:"subaccount",agencyId:t.agencyId,subAccountId:i}}return await o({userId:e.principal.userId,agencyId:a}),{kind:"agency",agencyId:a}};class I extends Error{status;code;constructor(e){super(e.message),this.name="ApiAuthzError",this.status=e.status,this.code=e.code}}class y extends Error{constructor(e){super(e),this.name="AuthzError"}}let g=e=>e.trim(),A=async e=>{let n=e.failMode??"redirect",r=e.redirectTo??"/",a=e.permissionKeys.map(g),s=e.requiredKeys.map(g).filter(Boolean);s.every(e=>a.includes(e))||((e,n,r)=>{if("notFound"===e&&(0,t.notFound)(),"throw"===e)throw new y(r);(0,t.redirect)(n)})(n,r,`Missing permissions: ${s.join(", ")}`)},m=async e=>{let t,r=await u(e.req);if(!r)throw new I({status:401,code:"UNAUTHENTICATED",message:"Unauthenticated"});try{t=await p({principal:r,headers:e.req.headers})}catch(a){if(a instanceof d&&"CONTEXT_MISSING"===a.code&&"user"===r.kind){let a=new URL(e.req.url),s=a.searchParams.get("agencyId")||void 0,i=a.searchParams.get("subAccountId")||void 0;if(i){let e=await (0,n.resolveSubAccountContextForUser)({userId:r.userId,subAccountId:i});if(!e)throw new I({status:403,code:"FORBIDDEN",message:"No subaccount membership for requested context"});t={kind:"subaccount",agencyId:e.agencyId,subAccountId:i}}else if(s){if(!await (0,n.resolveAgencyContextForUser)({userId:r.userId,agencyId:s}))throw new I({status:403,code:"FORBIDDEN",message:"No agency membership for requested context"});t={kind:"agency",agencyId:s}}else throw new I({status:400,code:"INVALID_REQUEST",message:"Missing scope: provide x-autlify-agency-id / x-autlify-subaccount-id headers (SDK) or agencyId/subAccountId query (UI)"})}else if(a instanceof d)throw new I({status:a.status,code:400===a.status?"INVALID_REQUEST":"FORBIDDEN",message:a.message});throw a}if("user"===r.kind){let a="agency"===t.kind?await (0,n.resolveAgencyContextForUser)({userId:r.userId,agencyId:t.agencyId}):await (0,n.resolveSubAccountContextForUser)({userId:r.userId,subAccountId:t.subAccountId});if(!a)throw new I({status:403,code:"FORBIDDEN",message:"No membership"});if(await A({permissionKeys:a.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"}),(e.requireActiveSubscription??!0)&&"agency"===t.kind&&"ACTIVE"!==await (0,n.getAgencySubscriptionState)(a.agencyId)||(e.requireActiveSubscription??!0)&&"subaccount"===t.kind&&"ACTIVE"!==await (0,n.getAgencySubscriptionState)(t.agencyId))throw new I({status:402,code:"FORBIDDEN",message:"Inactive subscription"});return{scope:t,principal:{kind:"user",userId:r.userId,permissionKeys:a.permissionKeys}}}if("USER"===r.apiKeyKind){let a="agency"===t.kind?await (0,n.resolveAgencyContextForUser)({userId:r.ownerUserId,agencyId:t.agencyId}):await (0,n.resolveSubAccountContextForUser)({userId:r.ownerUserId,subAccountId:t.subAccountId});if(!a)throw new I({status:403,code:"FORBIDDEN",message:"No membership"});await A({permissionKeys:r.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"}),await A({permissionKeys:a.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"})}else await A({permissionKeys:r.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"});if((e.requireActiveSubscription??!0)&&"agency"===t.kind&&"ACTIVE"!==await (0,n.getAgencySubscriptionState)(t.agencyId)||(e.requireActiveSubscription??!0)&&"subaccount"===t.kind&&"ACTIVE"!==await (0,n.getAgencySubscriptionState)(t.agencyId))throw new I({status:402,code:"FORBIDDEN",message:"Inactive subscription"});return{scope:t,principal:{kind:"apiKey",apiKeyId:r.apiKeyId,apiKeyKind:r.apiKeyKind,ownerUserId:r.ownerUserId,permissionKeys:r.permissionKeys}}};e.s(["ApiAuthzError",()=>I,"requirePermission",0,A,"requireRequestAccess",0,m],661418)},974389,e=>{"use strict";var t=e.i(67982);e.s(["Prisma",0,t])},747826,e=>{"use strict";e.i(423502);var t=e.i(254799);e.i(828189);var n=e.i(974389),r=e.i(843793),a=e.i(307144);let s=[{key:"support",label:"Support Center",description:"Guided troubleshooting, diagnostics, and support tickets.",isCore:!0},{key:"integrations",label:"Integrations",description:"Connect providers, manage API keys, and configure outbound webhooks.",isCore:!0},{key:"webhooks",label:"Webhooks",description:"Outbound webhook subscriptions, deliveries, and replay tooling.",isCore:!0}];class i extends Error{status;code;constructor(e){super(e.message),this.name="AppServiceError",this.status=e.status,this.code=e.code}}let o=e=>s.find(t=>t.key===e)??null;async function c(e){return e.subAccountId?await r.db.$queryRaw(n.Prisma.sql`SELECT "appKey","status","installedAt","updatedAt"
                FROM "AppInstallation"
                WHERE "agencyId" = ${e.agencyId} AND "subAccountId" = ${e.subAccountId}`):await r.db.$queryRaw(n.Prisma.sql`SELECT "appKey","status","installedAt","updatedAt"
              FROM "AppInstallation"
              WHERE "agencyId" = ${e.agencyId} AND "subAccountId" IS NULL`)}async function u(e){let t=e.item.requiredFeatureKeys??[];if(0===t.length)return!0;let n=await (0,a.resolveEffectiveEntitlements)({agencyId:e.agencyId,subAccountId:e.subAccountId??null,scope:e.scope,planId:null,now:null}),r=Object.values(n);if(!n||0===r.length)return!1;let s=new Set(r.filter(e=>e.isEnabled).map(e=>e.featureKey));return!!t.some(e=>r.some(t=>t.featureKey===e))&&t.some(e=>s.has(e))}async function d(e){let t=new Map;try{let n=await c({agencyId:e.agencyId,subAccountId:e.subAccountId??null});t=new Map(n.map(e=>[String(e.appKey),e]))}catch{t=new Map}let n=[];for(let a of s){var r;let s=t.get(a.key);if(a.isCore){n.push({...a,state:"INSTALLED",installedAt:s?.installedAt??null,entitled:!0,canInstall:!1,canUninstall:!1});continue}let i=!1;try{i=await u({item:a,agencyId:e.agencyId,subAccountId:e.subAccountId??null,scope:e.meteringScope})}catch{i=!1}let o=s?.status??("integrations"===(r=a.key)||"webhooks"===r?"INSTALLED":"AVAILABLE");i&&s||(o="AVAILABLE"),n.push({...a,state:o,installedAt:s?.installedAt??null,entitled:i,canInstall:i&&"INSTALLED"!==o,canUninstall:"INSTALLED"===o})}return n}async function l(e){let a=o(e.appKey);if(!a)throw new i({status:404,code:"UNKNOWN_APP",message:`Unknown appKey: ${e.appKey}`});if(a.isCore)return{appKey:e.appKey,status:"INSTALLED"};if(await I(),!await u({item:a,agencyId:e.agencyId,subAccountId:e.subAccountId??null,scope:{subAccountId:e.subAccountId??null}.subAccountId?"SUBACCOUNT":"AGENCY"}))throw new i({status:402,code:"NOT_ENTITLED",message:"App is not included in current plan entitlements"});let s=t.default.randomUUID(),c=new Date,d="INSTALLED",l=e.subAccountId?n.Prisma.sql`"subAccountId" = ${e.subAccountId}`:n.Prisma.sql`"subAccountId" IS NULL`;return await r.db.$executeRaw(n.Prisma.sql`INSERT INTO "AppInstallation" ("id","appKey","agencyId","subAccountId","status","installedAt","createdAt","updatedAt")
              VALUES (${s}, ${e.appKey}, ${e.agencyId}, ${e.subAccountId??null}, ${d}, ${c}, ${c}, ${c})
              ON CONFLICT DO NOTHING`),await r.db.$executeRaw(n.Prisma.sql`UPDATE "AppInstallation"
              SET "status" = ${d},
                  "installedAt" = COALESCE("installedAt", ${c}),
                  "uninstalledAt" = NULL,
                  "updatedAt" = ${c}
              WHERE "agencyId" = ${e.agencyId}
                AND "appKey" = ${e.appKey}
                AND ${l}`),{appKey:e.appKey,status:"INSTALLED"}}async function p(e){let t=o(e.appKey);if(!t)throw new i({status:404,code:"UNKNOWN_APP",message:`Unknown appKey: ${e.appKey}`});if(t.isCore)throw new i({status:400,code:"CORE_APP",message:"Core apps cannot be uninstalled"});await I();let a=new Date,s=e.subAccountId?n.Prisma.sql`"subAccountId" = ${e.subAccountId}`:n.Prisma.sql`"subAccountId" IS NULL`;return await r.db.$executeRaw(n.Prisma.sql`UPDATE "AppInstallation"
              SET "status" = 'AVAILABLE',
                  "uninstalledAt" = ${a},
                  "updatedAt" = ${a}
              WHERE "agencyId" = ${e.agencyId}
                AND "appKey" = ${e.appKey}
                AND ${s}`),{appKey:e.appKey,status:"AVAILABLE"}}async function I(){let e=await r.db.$queryRaw(n.Prisma.sql`SELECT to_regclass('public."AppInstallation"') AS "reg"`);if(!(e?.[0]?.reg??e?.[0]?.Reg??e?.[0]?.REG))throw new i({status:500,code:"MIGRATION_MISSING",message:"AppInstallation table is not present. Apply migrations (prisma migrate) first."})}e.s(["installApp",()=>l,"listAppsWithState",()=>d,"uninstallApp",()=>p],747826)},374809,e=>{"use strict";var t=e.i(747909),n=e.i(174017),r=e.i(996250),a=e.i(759756),s=e.i(561916),i=e.i(174677),o=e.i(869741),c=e.i(316795),u=e.i(487718),d=e.i(995169),l=e.i(47587),p=e.i(666012),I=e.i(570101),y=e.i(626937),g=e.i(10372),A=e.i(193695);e.i(52474);var m=e.i(600220),f=e.i(89171),w=e.i(883406),h=e.i(661418),b=e.i(747826);async function E(e){try{var t;let n=await (0,h.requireRequestAccess)({req:e,requiredKeys:[w.KEYS.core.apps.app.view],requireActiveSubscription:!0}),r=await (0,b.listAppsWithState)({agencyId:n.scope.agencyId,subAccountId:"subaccount"===n.scope.kind?n.scope.subAccountId:null,meteringScope:(t=n.scope,"agency"===t.kind?"AGENCY":"SUBACCOUNT")});return f.NextResponse.json({apps:r})}catch(e){if(e?.status)return f.NextResponse.json({error:e.message,code:e.code},{status:e.status});return console.error(e),f.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>E],735521);var v=e.i(735521);let N=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/features/core/apps/route",pathname:"/api/features/core/apps",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/features/core/apps/route.ts",nextConfigOutput:"standalone",userland:v}),{workAsyncStorage:C,workUnitAsyncStorage:D,serverHooks:T}=N;function S(){return(0,r.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:D})}async function R(e,t,r){N.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/features/core/apps/route";f=f.replace(/\/index$/,"")||"/";let w=await N.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:h,params:b,nextConfig:E,parsedUrl:v,isDraftMode:C,prerenderManifest:D,routerServerContext:T,isOnDemandRevalidate:S,revalidateOnlyGenerated:R,resolvedPathname:x,clientReferenceManifest:U,serverActionsManifest:K}=w,O=(0,o.normalizeAppPath)(f),_=!!(D.dynamicRoutes[O]||D.routes[x]),k=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,v,!1):t.end("This page could not be found"),null);if(_&&!C){let e=!!D.routes[x],t=D.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await k();throw new A.NoFallbackError}}let q=null;!_||N.isDev||C||(q="/index"===(q=x)?"/":q);let P=!0===N.isDev||!_,L=_&&!P;K&&U&&(0,i.setManifestsSingleton)({page:f,clientReferenceManifest:U,serverActionsManifest:K});let F=e.method||"GET",M=(0,s.getTracer)(),$=M.getActiveScopeSpan(),B={params:b,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:P,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,a)=>N.onRequestError(e,t,r,a,T)},sharedContext:{buildId:h}},G=new c.NodeNextRequest(e),H=new c.NodeNextResponse(t),j=u.NextRequestAdapter.fromNodeNextRequest(G,(0,u.signalFromNodeResponse)(t));try{let i=async e=>N.handle(j,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=M.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${F} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${f}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var s,c;let u=async({previousCacheEntry:n})=>{try{if(!o&&S&&R&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=B.renderOpts.fetchMetrics;let c=B.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let u=B.renderOpts.collectedTags;if(!_)return await (0,p.sendResponse)(G,H,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,I.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:S})},!1,T),t}},d=await N.handleResponse({req:e,nextConfig:E,cacheKey:q,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:R,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:o});if(!_)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let A=(0,I.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&_||A.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||A.get("Cache-Control")||A.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(G,H,new Response(d.value.body,{headers:A,status:d.value.status||200})),null};$?await c($):await M.withPropagatedContext(e.headers,()=>M.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${f}`,kind:s.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},c))}catch(t){if(t instanceof A.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:S})},!1,T),_)throw t;return await (0,p.sendResponse)(G,H,new Response(null,{status:500})),null}}e.s(["handler",()=>R,"patchFetch",()=>S,"routeModule",()=>N,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>D],374809)},916005,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_node:buffer_00e2e67a._.js"].map(t=>e.l(t))).then(()=>t(951615)))},918707,e=>{e.v(t=>Promise.all(["server/chunks/2e4a4_@prisma_client_runtime_query_compiler_fast_bg_postgresql_mjs_35c4194d._.js"].map(t=>e.l(t))).then(()=>t(407142)))},480599,e=>{e.v(t=>Promise.all(["server/chunks/9c9c5_client_runtime_query_compiler_fast_bg_postgresql_wasm-base64_mjs_9e69af0b._.js"].map(t=>e.l(t))).then(()=>t(417734)))},642072,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__eb6269cd._.js","server/chunks/_b96aa026._.js"].map(t=>e.l(t))).then(()=>t(485849)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__202d33f7._.js.map