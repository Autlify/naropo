module.exports=[951743,e=>{"use strict";var t=e.i(747909),a=e.i(174017),o=e.i(996250),n=e.i(759756),r=e.i(561916),i=e.i(174677),s=e.i(869741),c=e.i(316795),d=e.i(487718),u=e.i(995169),l=e.i(47587),p=e.i(666012),h=e.i(570101),b=e.i(626937),m=e.i(10372),g=e.i(193695);e.i(52474);var w=e.i(600220),f=e.i(89171),E=e.i(493458),y=e.i(445147),R=e.i(745015),v=e.i(843793),C=e.i(821695),S=e.i(195975);let _=async(e,t)=>{try{let a=e.metadata?.agencyId;if(!a)throw console.error("ðŸ”´ No agencyId in subscription metadata:",e.id),Error("Subscription metadata missing agencyId");let o=await v.db.agency.findUnique({where:{id:a},include:{SubAccount:!0,Subscription:!0}});if(!o)throw Error(`Could not find agency with id: ${a}`);if(o.customerId!==t)throw Error(`Agency ${a} does not belong to customer ${t}`);let n="trialing"===e.status,r="active"===e.status||n,i=n&&e.trial_end?new Date(1e3*e.trial_end):o.Subscription?.trialEndedAt,s=e.items?.data?.[0];if(!s)throw Error(`Subscription ${e.id} has no items`);let c=s.price?.id||s.plan?.id,d=s.current_period_end;if(!c||!d)throw Error(`Missing price or period info in subscription ${e.id}`);let u={active:r,agencyId:o.id,customerId:t,status:e.status.toUpperCase(),trialEndedAt:i,currentPeriodEndDate:new Date(1e3*d),priceId:c,subscritiptionId:e.id,plan:c};if(await v.db.subscription.upsert({where:{agencyId:o.id},create:u,update:u}),n||r){let e=await v.db.user.findFirst({where:{AgencyMemberships:{some:{agencyId:o.id,Role:{name:"AGENCY_OWNER"}}}}});e?.trialEligible&&(await v.db.user.update({where:{id:e.id},data:{trialEligible:!1}}),console.log("ðŸ”„ Updated user trialEligible to false:",e.id))}console.log(`ðŸŸ¢ Created/Updated Subscription`,{subscriptionId:e.id,status:e.status,active:r,trialEnd:e.trial_end?new Date(1e3*e.trial_end).toISOString():null})}catch(e){console.log("ðŸ”´ Error from subscriptionCreated action",e)}},A=async(e,t)=>{try{let a=e.metadata?.agencyId,o=e.metadata?.featureKey,n=e.metadata?.scope||"AGENCY",r=e.metadata?.subAccountId||null,i=Number(e.metadata?.credits||e.metadata?.quantity||0);if(!a||!o||!n||i<=0)throw console.error("ðŸ”´ Missing agencyId or featureKey in checkout session metadata:",e.id),Error("Checkout session metadata missing agencyId or featureKey");let s=await v.db.agency.findUnique({where:{id:a},include:{SubAccount:!0}}),c=s?.SubAccount.find(e=>e.id===r)||null;if(!s&&!c)throw Error(`Could not find agency with id: ${a}`);if(s?.customerId!==t&&c?.connectAccountId!==t)throw Error(`Could not find agency with id: ${t}`);await (0,C.applyTopUpCreditsFromCheckout)({scope:n,agencyId:a,subAccountId:r,featureKey:o,credits:i,stripeCheckoutSessionId:`topup:${e.id}`}),console.log(`ðŸŸ¢ Processed Credit Top-Up`,{agencyId:a,featureKey:o,credits:i,scope:n,subAccountId:r,stripeCheckoutSessionId:`topup:${e.id}`})}catch(e){console.log("ðŸ”´ Error from creditTopUpCreated action",e)}},I=async e=>(await y.stripe.products.list({limit:50,expand:["data.default_price"]},{stripeAccount:e})).data;(0,S.ensureServerEntryExports)([_,A,I]),(0,R.registerServerReference)(_,"608cb00f5d7dae49ac57a86bbd6c9dcf0721243795",null),(0,R.registerServerReference)(A,"60e57a94e552bca8f1b8034ec39a4ccb275e965c26",null),(0,R.registerServerReference)(I,"4099f2e22535df0c2f82c0130519ff8dd2a892c385",null);let k=new Set(["product.created","product.updated","price.created","price.updated","checkout.session.completed","customer.subscription.created","customer.subscription.updated","customer.subscription.deleted","customer.subscription.trial_will_end","invoice.payment_succeeded","invoice.payment_failed","setup_intent.succeeded","account.application.authorized","account.application.deauthorized"]);async function x(e){let t,a=await e.text(),o=(await (0,E.headers)()).get("Stripe-Signature"),n=process.env.STRIPE_WEBHOOK_SECRET_LIVE??process.env.STRIPE_WEBHOOK_SECRET;try{if(!o||!n)return void console.log("ðŸ”´ Error Stripe webhook secret or the signature does not exist.");t=y.stripe.webhooks.constructEvent(a,o,n)}catch(e){return console.log(`ðŸ”´ Error ${e.message}`),new f.NextResponse(`Webhook Error: ${e.message}`,{status:400})}try{if(k.has(t.type))switch(t.type){case"customer.subscription.created":case"customer.subscription.updated":{let e=t.data.object;if(e.metadata.connectAccountPayments||e.metadata.connectAccountSubscriptions){console.log("SKIPPED FROM WEBHOOK ðŸ’³ because subscription was from a connected account",e.id);break}"active"===e.status||"trialing"===e.status?(await _(e,e.customer),console.log(`âœ… Subscription ${e.status.toUpperCase()} ðŸ’³`,{id:e.id,status:e.status,trialEnd:e.trial_end})):console.log(`â­ï¸  Skipped subscription (status: ${e.status})`,e.id);break}case"setup_intent.succeeded":{let e=t.data.object;console.log("âœ… SetupIntent succeeded ðŸ’³",{id:e.id,customer:e.customer,paymentMethod:e.payment_method});break}case"customer.subscription.trial_will_end":{let e=t.data.object;console.log("â° Trial ending soon",{subscriptionId:e.id,trialEnd:e.trial_end});break}case"customer.subscription.deleted":{let e=t.data.object,a=e.metadata?.agencyId;console.log("ðŸš« Subscription deleted",{subscriptionId:e.id,agencyId:a,status:e.status}),a&&(await v.db.subscription.update({where:{agencyId:a},data:{active:!1,status:"CANCELED",cancelAtPeriodEnd:!1}}),console.log("âœ… Database subscription marked as cancelled for agency:",a));break}case"invoice.payment_failed":{let e=t.data.object,a=e.customer;console.log("âŒ Invoice payment failed",{invoiceId:e.id,customerId:a,amount:e.amount_due,attemptCount:e.attempt_count});let o=await v.db.agency.findFirst({where:{customerId:a},include:{Subscription:!0}});o?.Subscription&&(await v.db.subscription.update({where:{agencyId:o.id},data:{status:"PAST_DUE"}}),console.log("âš ï¸ Subscription marked as PAST_DUE for agency:",o.id,"attempt:",e.attempt_count));break}case"checkout.session.completed":{let e=t.data.object;"payment"===e.mode&&"paid"===e.payment_status&&(await A(e,e.customer),console.log("âœ… Checkout Session completed and paid ðŸ’³",{id:e.id,customer:e.customer,payment_intent:e.payment_intent}));break}case"account.application.authorized":{let e=t.data.object;console.log("âœ… Connect account authorized",{applicationId:e.id,name:e.name});break}case"account.application.deauthorized":{let e=t.data.object,a=t.account;console.log("ðŸš« Connect account deauthorized",{applicationId:e.id,accountId:a}),a&&(await v.db.agency.updateMany({where:{connectAccountId:a},data:{connectAccountId:""}}),await v.db.subAccount.updateMany({where:{connectAccountId:a},data:{connectAccountId:""}}),console.log("âœ… Cleared deauthorized connectAccountId:",a));break}default:console.log("ðŸ‘‰ Unhandled event type:",t.type)}}catch(e){return console.log(e),new f.NextResponse("ðŸ”´ Webhook Error",{status:400})}return f.NextResponse.json({webhookActionReceived:!0},{status:200})}e.s(["POST",()=>x],250842);var T=e.i(250842);let P=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/stripe/webhook/route.ts",nextConfigOutput:"standalone",userland:T}),{workAsyncStorage:N,workUnitAsyncStorage:O,serverHooks:U}=P;function D(){return(0,o.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:O})}async function $(e,t,o){P.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/stripe/webhook/route";f=f.replace(/\/index$/,"")||"/";let E=await P.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:y,params:R,nextConfig:v,parsedUrl:C,isDraftMode:S,prerenderManifest:_,routerServerContext:A,isOnDemandRevalidate:I,revalidateOnlyGenerated:k,resolvedPathname:x,clientReferenceManifest:T,serverActionsManifest:N}=E,O=(0,s.normalizeAppPath)(f),U=!!(_.dynamicRoutes[O]||_.routes[x]),D=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,C,!1):t.end("This page could not be found"),null);if(U&&!S){let e=!!_.routes[x],t=_.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await D();throw new g.NoFallbackError}}let $=null;!U||P.isDev||S||($="/index"===($=x)?"/":$);let H=!0===P.isDev||!U,M=U&&!H;N&&T&&(0,i.setManifestsSingleton)({page:f,clientReferenceManifest:T,serverActionsManifest:N});let q=e.method||"GET",j=(0,r.getTracer)(),K=j.getActiveScopeSpan(),F={params:R,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,o,n)=>P.onRequestError(e,t,o,n,A)},sharedContext:{buildId:y}},z=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(z,(0,d.signalFromNodeResponse)(t));try{let i=async e=>P.handle(W,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=a.get("next.route");if(o){let t=`${q} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${f}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var r,c;let d=async({previousCacheEntry:a})=>{try{if(!s&&I&&k&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let c=F.renderOpts.pendingWaitUntil;c&&o.waitUntil&&(o.waitUntil(c),c=void 0);let d=F.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(z,B,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,o=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:o}}}}catch(t){throw(null==a?void 0:a.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:I})},!1,A),t}},u=await P.handleResponse({req:e,nextConfig:v,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:k,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:s});if(!U)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&U||g.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,b.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(z,B,new Response(u.value.body,{headers:g,status:u.value.status||200})),null};K?await c(K):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${f}`,kind:r.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},c))}catch(t){if(t instanceof g.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:I})},!1,A),U)throw t;return await (0,p.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>D,"routeModule",()=>P,"serverHooks",()=>U,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>O],951743)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_c857e04d.js.map