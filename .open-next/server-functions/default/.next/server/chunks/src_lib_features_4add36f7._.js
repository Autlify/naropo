module.exports=[307144,e=>{"use strict";e.i(423502);var r=e.i(843793);function n(e){return null==e?null:"string"==typeof e?e:e.toString()}let t=new Set(["ACTIVE","TRIALING"]),i="false"!==process.env.ENTITLEMENTS_SUBACCOUNT_INHERIT_AGENCY;async function c(e){if("SUBACCOUNT"!==e.scope)return!1;if(null!=e.inheritAgencyEntitlements)return!!e.inheritAgencyEntitlements;if(e.subAccountId){let n=await r.db.subAccountSettings.findUnique({where:{subAccountId:e.subAccountId},select:{entitlementsInheritFromAgency:!0}});if(n?.entitlementsInheritFromAgency!=null)return!!n.entitlementsInheritFromAgency}let n=await r.db.agencySettings.findUnique({where:{agencyId:e.agencyId},select:{entitlementsInheritToSubaccounts:!0}});return n?.entitlementsInheritToSubaccounts??i}async function l(e,n=new Date){let i=await r.db.subscription.findFirst({where:{agencyId:e,status:{in:Array.from(t)},currentPeriodEndDate:{gt:n}},select:{priceId:!0}});return i?.priceId??null}async function a(e,n=new Date){return Array.from(new Set([await l(e,n),...(await r.db.addOns.findMany({where:{agencyId:e,active:!0},select:{priceId:!0}})).map(e=>e.priceId)].filter(Boolean)))}function s(e,r){let n=e??null,t=r??null;return null==n&&null==t?null:(n??0)+(t??0)}function o(e,r){return null==e&&null==r?null:null==e?r:null==r?e:e.plus?.(r)??e}async function u(e){let t=e.now??new Date,i=e.planId,l=i?[i]:await a(e.agencyId,t);if(!l.length)return{};let u=await r.db.planFeature.findMany({where:{planId:{in:l}},include:{EntitlementFeature:!0}}),d=new Map;for(let e of u){let r=d.get(e.featureKey)??[];r.push(e),d.set(e.featureKey,r)}let p=[];for(let[,e]of d)p.push(1===e.length?e[0]:function(e){let r=e[0];if(!r)throw Error("mergePlanFeatures called with empty list");return{...r,isEnabled:e.some(e=>e.isEnabled),isUnlimited:e.some(e=>e.isUnlimited),includedInt:e.reduce((e,r)=>s(e,r.includedInt),null),maxInt:e.reduce((e,r)=>s(e,r.maxInt),null),includedDec:e.reduce((e,r)=>o(e,r.includedDec),null),maxDec:e.reduce((e,r)=>o(e,r.maxDec),null),recurringCreditGrantInt:e.reduce((e,r)=>s(e,r.recurringCreditGrantInt),null),recurringCreditGrantDec:e.reduce((e,r)=>o(e,r.recurringCreditGrantDec),null),rolloverCredits:e.some(e=>e.rolloverCredits),topUpEnabled:e.some(e=>e.topUpEnabled),topUpPriceId:e.find(e=>e.topUpPriceId)?.topUpPriceId??r.topUpPriceId,enforcement:e.some(e=>"HARD"===e.enforcement)?"HARD":r.enforcement,overageMode:r.overageMode,overageFee:r.overageFee,stripeOveragePriceId:r.stripeOveragePriceId}}(e));let f=await c(e)?await r.db.entitlementOverride.findMany({where:{scope:"AGENCY",agencyId:e.agencyId,subAccountId:null,startsAt:{lte:t},OR:[{endsAt:null},{endsAt:{gte:t}}]}}):[],m=await r.db.entitlementOverride.findMany({where:{scope:e.scope,agencyId:e.agencyId,subAccountId:e.subAccountId||null,startsAt:{lte:t},OR:[{endsAt:null},{endsAt:{gte:t}}]}}),y=[...f,...m],g=new Map;for(let e of f)g.set(e.featureKey,e);for(let e of m)g.set(e.featureKey,e);let b={};for(let e of p)b[e.featureKey]=function(e,r){let t=e.EntitlementFeature,i=(r?.isEnabled??!0)&&e.isEnabled,c=r?.isUnlimited??e.isUnlimited,l=e.maxInt??null,a=r?.maxOverrideInt!=null?r.maxOverrideInt:null!=l?l+(r?.maxDeltaInt??0):null,s=null!=e.maxDec?n(e.maxDec):null,o=r?.maxOverrideDec!=null?n(r.maxOverrideDec):null!=s?n(e.maxDec.plus?.(r?.maxDeltaDec??0)??e.maxDec):null;return{featureKey:e.featureKey,name:t.name,category:t.category,description:t.description,valueType:t.valueType,unit:t.unit,metering:t.metering,aggregation:t.aggregation,scope:t.scope,period:t.period,isEnabled:i,isUnlimited:c,includedInt:e.includedInt??null,maxInt:a,includedDec:null!=e.includedDec?n(e.includedDec):null,maxDec:o,enforcement:e.enforcement,overageMode:e.overageMode,creditEnabled:t.creditEnabled,creditUnit:t.creditUnit??null,creditExpires:t.creditExpires,creditPriority:t.creditPriority,recurringCreditGrantInt:e.recurringCreditGrantInt??null,recurringCreditGrantDec:null!=e.recurringCreditGrantDec?n(e.recurringCreditGrantDec):null,rolloverCredits:e.rolloverCredits,topUpEnabled:e.topUpEnabled,topUpPriceId:e.topUpPriceId??null}}(e,g.get(e.featureKey)||null);for(let e of y){if(b[e.featureKey])continue;let n=await r.db.entitlementFeature.findUnique({where:{key:e.featureKey}});n&&(b[e.featureKey]={featureKey:n.key,name:n.name,category:n.category,description:n.description,valueType:n.valueType,unit:n.unit,metering:n.metering,aggregation:n.aggregation,scope:n.scope,period:n.period,isEnabled:e.isEnabled??!1,isUnlimited:e.isUnlimited??!1,includedInt:0,maxInt:e.maxOverrideInt??e.maxDeltaInt??null,includedDec:"0",maxDec:e.maxOverrideDec?e.maxOverrideDec.toString():e.maxDeltaDec?e.maxDeltaDec.toString():null,enforcement:"HARD",overageMode:"NONE",creditEnabled:n.creditEnabled,creditUnit:n.creditUnit??null,creditExpires:n.creditExpires,creditPriority:n.creditPriority,recurringCreditGrantInt:null,recurringCreditGrantDec:null,rolloverCredits:!1,topUpEnabled:!1,topUpPriceId:null})}return b}function d(e){return e?"SUBACCOUNT":"AGENCY"}e.s(["inferScopeFromIds",()=>d,"resolveEffectiveEntitlements",()=>u],307144)},907117,e=>{"use strict";e.i(423502);var r=e.i(698902),n=e.i(843793),t=e.i(307144),i=e.i(883406);let c=[{prefix:"core.agency.",requireAny:["core.agency.account"]},{prefix:"core.billing.",requireAll:["core.agency.account"]},{prefix:"iam.authZ.",requireAnyAll:[["core.agency.account"],["core.subaccount.account"]]},{prefix:"core.subaccount.",requireAny:["core.agency.subaccounts","core.subaccount.account"]},{prefix:"core.apps.",requireAny:["core.apps.api_keys","core.apps.app","core.apps.webhooks"]},{prefix:"core.billing.priority_support.",requireAny:["core.billing.priority_support"]},{prefix:"core.billing.rebilling.",requireAny:["crm.customers.billing"]},{prefix:"crm.customers.contact.",requireAny:["crm.customers.contact"]},{prefix:"crm.customers.billing.",requireAny:["crm.customers.billing"]},{prefix:"crm.funnels.content.",requireAny:["crm.funnels.content"]},{prefix:"crm.pipelines.lane.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.pipelines.ticket.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.pipelines.tag.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.media.file.",requireAny:["crm.media.file"]},{prefix:"fi.configuration.",requireAny:["fi.general_ledger.settings","fi.accounts_receivable.subledgers","fi.accounts_payable.subledgers","fi.bank_ledger.bank_accounts","fi.controlling.cost_centers","fi.advanced_reporting.financial_statements"]},{prefix:"fi.general_ledger.",requireAny:["fi.general_ledger.settings"]},{prefix:"fi.accounts_receivable.",requireAny:["fi.accounts_receivable.subledgers"]},{prefix:"fi.accounts_payable.",requireAny:["fi.accounts_payable.subledgers"]},{prefix:"fi.bank_ledger.",requireAny:["fi.bank_ledger.bank_accounts"]},{prefix:"fi.controlling.",requireAny:["fi.controlling.cost_centers"]},{prefix:"fi.advanced_reporting.",requireAny:["fi.advanced_reporting.financial_statements"]},{prefix:"co.cost_centers.",requireAny:["co.cost_centers.master_data"]},{prefix:"co.profit_centers.",requireAny:["co.profit_centers.master_data"]},{prefix:"co.internal_orders.",requireAny:["co.internal_orders.master_data"]},{prefix:"co.profitability.",requireAny:["co.profitability.segments"]},{prefix:"co.budgets.",requireAny:["co.budgets.planning"]}];function l(e){if(!e)return!1;if("BOOLEAN"===e.valueType)return e.isEnabled;if(!e.isEnabled)return!1;if(e.isUnlimited||(e.maxInt??e.includedInt??0)>0)return!0;let r=parseFloat(e.maxDec??e.includedDec??"0");return Number.isFinite(r)&&r>0}let a=async()=>{let e=await (0,r.auth)(),t=e?.user?.id;return t?n.db.user.findUnique({where:{id:t},include:{AgencyMemberships:{where:{isActive:!0},include:{Agency:!0,Role:{include:{Permissions:{where:{granted:!0},include:{Permission:!0}}}}}},SubAccountMemberships:{where:{isActive:!0},include:{SubAccount:!0,Role:{include:{Permissions:{where:{granted:!0},include:{Permission:!0}}}}}}}}):null},s=async()=>{let e=await a();if(!e)return[];let r=e.AgencyMemberships.flatMap(e=>e.Role.Permissions.map(e=>e.Permission)),n=e.SubAccountMemberships.flatMap(e=>e.Role.Permissions.map(e=>e.Permission)),t={};for(let e of[...r,...n])t[e.key]=e;return Object.keys(t).map(e=>t[e])},o=async()=>(await s()).map(e=>e.key),u=async e=>{let r=e.trim();return(await o()).includes(r)},d=async e=>{let r=await a();if(!r)return[];let n=r.AgencyMemberships.find(r=>r.agencyId===e);return n?n.Role.Permissions.map(e=>e.Permission.key):[]},p=async e=>{let r=await a();if(!r)return[];let n=r.SubAccountMemberships.find(r=>r.subAccountId===e);return n?n.Role.Permissions.map(e=>e.Permission.key):[]},f=async(e,r)=>{let n=r.trim();return(await d(e)).includes(n)},m=async(e,r)=>{let n=r.trim();return(await p(e)).includes(n)},y=async(e,r)=>{let a,s=await (0,t.resolveEffectiveEntitlements)({scope:"SUBACCOUNT"===r?"SUBACCOUNT":"AGENCY",agencyId:e,subAccountId:null}),o="AGENCY"===r?["core.agency.","core.billing.","core.apps.","core.experimental.","crm.","fi."]:["core.subaccount.","crm.","fi."],u=(a=[],!function e(r,n){if(r&&"object"==typeof r)for(let t of Object.values(r))"string"==typeof t?n.push(t):t&&"object"==typeof t&&e(t,n)}(i.KEYS,a),Array.from(new Set(a)).sort((e,r)=>e.localeCompare(r)).map(e=>{var r;let n,t,i;return{key:e,name:(t=(n=(r=e).split("."))[n.length-1]??r,i=n[n.length-2]??"",`${i} ${t}`.trim().replace(/[-_]/g," ").replace(/\b\w/g,e=>e.toUpperCase())),description:null,category:e.split(".").slice(0,2).join("."),isSystem:!0}})).filter(e=>o.some(r=>e.key.startsWith(r))).filter(e=>(function(e,r){let n=function(e){let r=null;for(let n of c)e.startsWith(n.prefix)&&(!r||n.prefix.length>r.prefix.length)&&(r=n);return r}(e);if(!n)return!(e.startsWith("fi.")||e.startsWith("co."));if(n.requireAll?.length){for(let e of n.requireAll)if(!l(r[e]))return!1}return(!n.requireAnyAll?.length||!!n.requireAnyAll.some(e=>e.every(e=>l(r[e]))))&&(!n.requireAny?.length||n.requireAny.some(e=>l(r[e])))})(e.key,s));await n.db.permission.createMany({data:u.map(e=>({key:e.key,name:e.name,description:e.description,category:e.category,isSystem:e.isSystem})),skipDuplicates:!0});let d=await n.db.permission.findMany({where:{key:{in:u.map(e=>e.key)}},orderBy:[{category:"asc"},{key:"asc"}]}),p={};for(let e of d)p[e.category]||(p[e.category]=[]),p[e.category].push(e);return p},g=async(e,r)=>Object.values(await y(e,r)).flat().map(e=>e.key),b=async(e,r,n)=>{let t=new Set(await g(e,r)),i=n.filter(e=>!t.has(e));return{valid:0===i.length,invalidKeys:i}},A=async()=>{let e=await a();if(!e)return[];let r=[],n=new Map;for(let r of e.SubAccountMemberships){let e=r.SubAccount,t=e.agencyId,i={id:e.id,name:e.name,logo:e.subAccountLogo||void 0,type:"subaccount"};n.has(t)||n.set(t,[]),n.get(t).push(i)}for(let t of e.AgencyMemberships){let e=t.Agency,i=n.get(e.id)||[];r.push({id:e.id,name:e.name,logo:e.agencyLogo||void 0,type:"agency",subaccounts:i.length>0?i:void 0})}return r};e.s(["getAgencyPermissionKeys",0,d,"getAuthUserMemberships",0,a,"getEntitledPermissionKeys",0,g,"getEntitledPermissions",0,y,"getSubAccountPermissionKeys",0,p,"getUserAccessibleTeams",0,A,"getUserPermissionKeys",0,o,"getUserPermissions",0,s,"hasAgencyPermission",0,f,"hasPermission",0,u,"hasSubAccountPermission",0,m,"validatePermissionKeys",0,b],907117)}];

//# sourceMappingURL=src_lib_features_4add36f7._.js.map