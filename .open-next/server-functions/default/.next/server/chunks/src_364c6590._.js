module.exports=[661418,e=>{"use strict";e.i(423502),e.i(551783);var t=e.i(379509),s=e.i(73903),n=e.i(698902),r=e.i(254799),i=e.i(843793);let a="autl_",u=async e=>{var t,s;let n,u,c,o=(e=>{let t=e.trim();if(!t)return null;if(t.startsWith(a)){let[e,s]=t.slice(a.length).split("_",2);return e&&s?{prefix:e,secret:s}:null}if(t.includes(".")){let[e,s]=t.split(".",2);return e&&s?{prefix:e,secret:s}:null}return null})(e.token);if(!o)return null;let d=await i.db.apiKey.findUnique({where:{prefix:o.prefix},select:{id:!0,kind:!0,ownerUserId:!0,agencyId:!0,subAccountId:!0,allowedSubAccountIds:!0,permissionKeys:!0,secretHash:!0,expiresAt:!0,revokedAt:!0}});return!d||d.revokedAt||d.expiresAt&&d.expiresAt.getTime()<=Date.now()?null:(n=o.secret,t=r.default.createHash("sha256").update(n,"utf8").digest("hex"),s=d.secretHash,u=Buffer.from(t,"hex"),c=Buffer.from(s,"hex"),u.length===c.length&&r.default.timingSafeEqual(u,c))?((e.touchLastUsedAt??!0)&&i.db.apiKey.update({where:{id:d.id},data:{lastUsedAt:new Date}}).catch(()=>null),{id:d.id,kind:d.kind,ownerUserId:d.ownerUserId,agencyId:d.agencyId,subAccountId:d.subAccountId,allowedSubAccountIds:d.allowedSubAccountIds??[],permissionKeys:d.permissionKeys??[],expiresAt:d.expiresAt,revokedAt:d.revokedAt}):null},c=(e,t)=>{let s=e.get(t);if(s)return s;let n=t.toLowerCase();if(n!==t){let t=e.get(n);if(t)return t}return null},o=async e=>{let t=(e=>{let t=e.get("authorization")||e.get("Authorization");if(!t)return null;let s=t.trim().split(/\s+/,2);return 2!==s.length||"bearer"!==s[0].toLowerCase()?null:s[1]})(e.headers)||c(e.headers,"x-autlify-api-key");if(t){let e=await u({token:t});return e?{kind:"apiKey",apiKeyId:e.id,apiKeyKind:e.kind,ownerUserId:e.ownerUserId,agencyId:e.agencyId,subAccountId:e.subAccountId,allowedSubAccountIds:e.allowedSubAccountIds,permissionKeys:e.permissionKeys}:null}let s=await (0,n.auth)(),r=s?.user?.id;return r?{kind:"user",userId:r}:null};class d extends Error{status;code;constructor(e){super(e.message),this.name="AutlifyContextError",this.status=e.status,this.code=e.code}}let l=async e=>{let t=await i.db.subAccount.findUnique({where:{id:e.subAccountId},select:{agencyId:!0}});return!!t&&t.agencyId===e.agencyId},y=async e=>{let t,n,r=c(t=e.headers,"x-autlify-agency-id")||c(t,"x-autlify-agency"),a=c(n=e.headers,"x-autlify-subaccount-id")||c(n,"x-autlify-subaccount"),u=async e=>{let t=await (0,s.resolveAgencyContextForUser)(e);if(!t)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"No agency membership for requested context"});return t},o=async e=>{let t=await (0,s.resolveSubAccountContextForUser)(e);if(!t)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"No subaccount membership for requested context"});return t};if("apiKey"===e.principal.kind){let t=e.principal;if("AGENCY"===t.apiKeyKind){if(!t.agencyId)throw new d({status:500,code:"CONTEXT_INVALID",message:"Agency api key missing agencyId"});if(r&&r!==t.agencyId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Agency header does not match api key scope"});if(a){if(!await l({subAccountId:a,agencyId:t.agencyId}))throw new d({status:404,code:"CONTEXT_INVALID",message:"Subaccount does not belong to agency"});if(t.allowedSubAccountIds?.length&&!t.allowedSubAccountIds.includes(a))throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Api key not allowed to access this subaccount"});return{kind:"subaccount",agencyId:t.agencyId,subAccountId:a}}return{kind:"agency",agencyId:t.agencyId}}if("SUBACCOUNT"===t.apiKeyKind){if(!t.subAccountId)throw new d({status:500,code:"CONTEXT_INVALID",message:"Subaccount api key missing subAccountId"});if(a&&a!==t.subAccountId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Subaccount header does not match api key scope"});let e=t.agencyId||(await i.db.subAccount.findUnique({where:{id:t.subAccountId},select:{agencyId:!0}}))?.agencyId;if(!e)throw new d({status:404,code:"CONTEXT_INVALID",message:"Subaccount not found for api key"});return{kind:"subaccount",agencyId:e,subAccountId:t.subAccountId}}if(!r&&!a)throw new d({status:400,code:"CONTEXT_MISSING",message:"Missing x-autlify-agency or x-autlify-subaccount header"});if(a){let e=await o({userId:t.ownerUserId,subAccountId:a});if(r&&r!==e.agencyId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Agency header does not match subaccount agency"});return{kind:"subaccount",agencyId:e.agencyId,subAccountId:a}}return await u({userId:t.ownerUserId,agencyId:r}),{kind:"agency",agencyId:r}}if(!r&&!a)throw new d({status:400,code:"CONTEXT_MISSING",message:"Missing x-autlify-agency or x-autlify-subaccount header"});if(a){let t=await o({userId:e.principal.userId,subAccountId:a});if(r&&r!==t.agencyId)throw new d({status:403,code:"CONTEXT_FORBIDDEN",message:"Agency header does not match subaccount agency"});return{kind:"subaccount",agencyId:t.agencyId,subAccountId:a}}return await u({userId:e.principal.userId,agencyId:r}),{kind:"agency",agencyId:r}};class I extends Error{status;code;constructor(e){super(e.message),this.name="ApiAuthzError",this.status=e.status,this.code=e.code}}class g extends Error{constructor(e){super(e),this.name="AuthzError"}}let f=e=>e.trim(),h=async e=>{let s=e.failMode??"redirect",n=e.redirectTo??"/",r=e.permissionKeys.map(f),i=e.requiredKeys.map(f).filter(Boolean);i.every(e=>r.includes(e))||((e,s,n)=>{if("notFound"===e&&(0,t.notFound)(),"throw"===e)throw new g(n);(0,t.redirect)(s)})(s,n,`Missing permissions: ${i.join(", ")}`)},p=async e=>{let t,n=await o(e.req);if(!n)throw new I({status:401,code:"UNAUTHENTICATED",message:"Unauthenticated"});try{t=await y({principal:n,headers:e.req.headers})}catch(r){if(r instanceof d&&"CONTEXT_MISSING"===r.code&&"user"===n.kind){let r=new URL(e.req.url),i=r.searchParams.get("agencyId")||void 0,a=r.searchParams.get("subAccountId")||void 0;if(a){let e=await (0,s.resolveSubAccountContextForUser)({userId:n.userId,subAccountId:a});if(!e)throw new I({status:403,code:"FORBIDDEN",message:"No subaccount membership for requested context"});t={kind:"subaccount",agencyId:e.agencyId,subAccountId:a}}else if(i){if(!await (0,s.resolveAgencyContextForUser)({userId:n.userId,agencyId:i}))throw new I({status:403,code:"FORBIDDEN",message:"No agency membership for requested context"});t={kind:"agency",agencyId:i}}else throw new I({status:400,code:"INVALID_REQUEST",message:"Missing scope: provide x-autlify-agency-id / x-autlify-subaccount-id headers (SDK) or agencyId/subAccountId query (UI)"})}else if(r instanceof d)throw new I({status:r.status,code:400===r.status?"INVALID_REQUEST":"FORBIDDEN",message:r.message});throw r}if("user"===n.kind){let r="agency"===t.kind?await (0,s.resolveAgencyContextForUser)({userId:n.userId,agencyId:t.agencyId}):await (0,s.resolveSubAccountContextForUser)({userId:n.userId,subAccountId:t.subAccountId});if(!r)throw new I({status:403,code:"FORBIDDEN",message:"No membership"});if(await h({permissionKeys:r.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"}),(e.requireActiveSubscription??!0)&&"agency"===t.kind&&"ACTIVE"!==await (0,s.getAgencySubscriptionState)(r.agencyId)||(e.requireActiveSubscription??!0)&&"subaccount"===t.kind&&"ACTIVE"!==await (0,s.getAgencySubscriptionState)(t.agencyId))throw new I({status:402,code:"FORBIDDEN",message:"Inactive subscription"});return{scope:t,principal:{kind:"user",userId:n.userId,permissionKeys:r.permissionKeys}}}if("USER"===n.apiKeyKind){let r="agency"===t.kind?await (0,s.resolveAgencyContextForUser)({userId:n.ownerUserId,agencyId:t.agencyId}):await (0,s.resolveSubAccountContextForUser)({userId:n.ownerUserId,subAccountId:t.subAccountId});if(!r)throw new I({status:403,code:"FORBIDDEN",message:"No membership"});await h({permissionKeys:n.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"}),await h({permissionKeys:r.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"})}else await h({permissionKeys:n.permissionKeys,requiredKeys:e.requiredKeys,failMode:"throw",redirectTo:"/"});if((e.requireActiveSubscription??!0)&&"agency"===t.kind&&"ACTIVE"!==await (0,s.getAgencySubscriptionState)(t.agencyId)||(e.requireActiveSubscription??!0)&&"subaccount"===t.kind&&"ACTIVE"!==await (0,s.getAgencySubscriptionState)(t.agencyId))throw new I({status:402,code:"FORBIDDEN",message:"Inactive subscription"});return{scope:t,principal:{kind:"apiKey",apiKeyId:n.apiKeyId,apiKeyKind:n.apiKeyKind,ownerUserId:n.ownerUserId,permissionKeys:n.permissionKeys}}};e.s(["ApiAuthzError",()=>I,"requirePermission",0,h,"requireRequestAccess",0,p],661418)},974389,e=>{"use strict";var t=e.i(67982);e.s(["Prisma",0,t])},192345,249866,e=>{"use strict";var t=e.i(254799);function s(e=32){return t.default.randomBytes(e).toString("hex")}function n(e){return t.default.createHash("sha256").update(e).digest("hex")}function r(e,s){return t.default.createHmac("sha256",e).update(s).digest("hex")}function i(e,s){let n=Buffer.from(e,"hex"),r=Buffer.from(s,"hex");return n.length===r.length&&t.default.timingSafeEqual(n,r)}function a(){let e=process.env.AUTLIFY_ENCRYPTION_KEY;if(!e)return null;if(/^[0-9a-fA-F]{64}$/.test(e))return Buffer.from(e,"hex");try{let t=Buffer.from(e,"base64");if(32===t.length)return t}catch{}return null}function u(e){let s=a();if(!s)return null;let n=t.default.randomBytes(12),r=t.default.createCipheriv("aes-256-gcm",s,n),i=Buffer.concat([r.update(e,"utf8"),r.final()]),u=r.getAuthTag(),c=e=>e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");return`v1.${c(n)}.${c(i)}.${c(u)}`}function c(e){let s=a();if(!s)return null;let n=String(e).split(".");if(4!==n.length||"v1"!==n[0])return null;let r=e=>{let t="=".repeat((4-e.length%4)%4),s=e.replace(/-/g,"+").replace(/_/g,"/")+t;return Buffer.from(s,"base64")},i=r(n[1]),u=r(n[2]),c=r(n[3]);try{let e=t.default.createDecipheriv("aes-256-gcm",s,i);return e.setAuthTag(c),Buffer.concat([e.update(u),e.final()]).toString("utf8")}catch{return null}}function o(){let e=`ak_${s(4)}`,t=s(32);return{apiKey:`${e}.${t}`,keyPrefix:e,keyHash:n(t)}}function d(e){let[t,s]=e.apiKey.split(".",2);return!!t&&!!s&&t===e.storedPrefix&&i(n(s),e.storedHash)}e.s(["decryptStringGcm",()=>c,"encryptStringGcm",()=>u,"hmacSha256Hex",()=>r,"randomToken",()=>s,"sha256Hex",()=>n,"timingSafeEqualHex",()=>i],249866),e.s(["generateIntegrationApiKey",()=>o,"verifyIntegrationApiKey",()=>d],192345)},735721,e=>{"use strict";e.i(423502);var t=e.i(698902),s=e.i(843793);e.i(828189);var n=e.i(974389),r=e.i(192345),i=e.i(661418),a=e.i(73903);async function u(e,t){let s=function(e){let t=e.headers.get("x-autlify-api-key");if(t)return t.trim();let s=e.headers.get("authorization")||"";return s.toLowerCase().startsWith("bearer ")?s.slice(7).trim():null}(e);return s?c(s,{hintedAgencyId:e.headers.get("x-autlify-agency-id")||void 0,hintedSubAccountId:e.headers.get("x-autlify-subaccount-id")||void 0,requireActiveSubscription:t?.requireActiveSubscription}):o(e,t)}async function c(e,t){let[i]=e.split(".",2);if(!i)throw new Response("Unauthorized",{status:401});let u=await s.db.$queryRaw(n.Prisma.sql`SELECT "id","keyPrefix","keyHash","agencyId","subAccountId","revokedAt"
              FROM "IntegrationApiKey"
              WHERE "keyPrefix" = ${i}
              LIMIT 1`),c=u?.[0];if(!c||c.revokedAt||!(0,r.verifyIntegrationApiKey)({apiKey:e,storedHash:c.keyHash,storedPrefix:c.keyPrefix}))throw new Response("Unauthorized",{status:401});if(c.agencyId&&t.hintedAgencyId&&t.hintedAgencyId!==c.agencyId||c.subAccountId&&t.hintedSubAccountId&&t.hintedSubAccountId!==c.subAccountId)throw new Response("Forbidden",{status:403});if(await s.db.$executeRaw(n.Prisma.sql`UPDATE "IntegrationApiKey" SET "lastUsedAt" = now() WHERE "id" = ${c.id}`),t.requireActiveSubscription??!0){let e=c.agencyId;if(!e&&c.subAccountId){let t=await s.db.subAccount.findUnique({where:{id:c.subAccountId},select:{agencyId:!0}});e=t?.agencyId??null}if(!e)throw new Response("Forbidden",{status:403});let t=await (0,a.getAgencySubscriptionState)(e);if(!t||"ACTIVE"!==t&&"TRIAL"!==t)throw new Response("Payment Required",{status:402})}let o=c.subAccountId?{type:"SUBACCOUNT",subAccountId:c.subAccountId,agencyId:c.agencyId??void 0}:{type:"AGENCY",agencyId:c.agencyId};return{actor:{kind:"apiKey",apiKeyId:c.id},scope:o}}async function o(e,s){let n=await (0,t.auth)(),r=n?.user?.id;if(!r)throw new Response("Unauthorized",{status:401});let u=new URL(e.url),c=e.headers.get("x-autlify-agency-id")||u.searchParams.get("agencyId")||void 0,o=e.headers.get("x-autlify-subaccount-id")||u.searchParams.get("subAccountId")||void 0,d=s?.requiredKeys??[],l=s?.requireActiveSubscription??!0;if(o){let e=await (0,a.resolveSubAccountContextForUser)({userId:r,subAccountId:o});if(!e)throw new Response("Forbidden",{status:403});if(await (0,i.requirePermission)({permissionKeys:e.permissionKeys,requiredKeys:d,failMode:"throw",redirectTo:"/"}),l){let t=await (0,a.getAgencySubscriptionState)(e.agencyId);if(!t||"ACTIVE"!==t&&"TRIAL"!==t)throw new Response("Payment Required",{status:402})}return{actor:{kind:"session",userId:r},scope:{type:"SUBACCOUNT",subAccountId:o,agencyId:e.agencyId}}}if(c){let e=await (0,a.resolveAgencyContextForUser)({userId:r,agencyId:c});if(!e)throw new Response("Forbidden",{status:403});if(await (0,i.requirePermission)({permissionKeys:e.permissionKeys,requiredKeys:d,failMode:"throw",redirectTo:"/"}),l&&"ACTIVE"!==e.subscriptionState&&"TRIAL"!==e.subscriptionState)throw new Response("Payment Required",{status:402});return{actor:{kind:"session",userId:r},scope:{type:"AGENCY",agencyId:c}}}throw new Response("Bad Request: missing agencyId/subAccountId",{status:400})}e.s(["requireIntegrationAuth",()=>u])}];

//# sourceMappingURL=src_364c6590._.js.map