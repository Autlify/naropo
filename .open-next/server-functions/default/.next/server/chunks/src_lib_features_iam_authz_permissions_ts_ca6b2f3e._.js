module.exports=[907117,e=>{"use strict";e.i(423502);var r=e.i(698902),i=e.i(843793),n=e.i(307144),t=e.i(883406);let s=[{prefix:"core.agency.",requireAny:["core.agency.account"]},{prefix:"core.billing.",requireAll:["core.agency.account"]},{prefix:"iam.authZ.",requireAnyAll:[["core.agency.account"],["core.subaccount.account"]]},{prefix:"core.subaccount.",requireAny:["core.agency.subaccounts","core.subaccount.account"]},{prefix:"core.apps.",requireAny:["core.apps.api_keys","core.apps.app","core.apps.webhooks"]},{prefix:"core.billing.priority_support.",requireAny:["core.billing.priority_support"]},{prefix:"core.billing.rebilling.",requireAny:["crm.customers.billing"]},{prefix:"crm.customers.contact.",requireAny:["crm.customers.contact"]},{prefix:"crm.customers.billing.",requireAny:["crm.customers.billing"]},{prefix:"crm.funnels.content.",requireAny:["crm.funnels.content"]},{prefix:"crm.pipelines.lane.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.pipelines.ticket.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.pipelines.tag.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.media.file.",requireAny:["crm.media.file"]},{prefix:"fi.configuration.",requireAny:["fi.general_ledger.settings","fi.accounts_receivable.subledgers","fi.accounts_payable.subledgers","fi.bank_ledger.bank_accounts","fi.controlling.cost_centers","fi.advanced_reporting.financial_statements"]},{prefix:"fi.general_ledger.",requireAny:["fi.general_ledger.settings"]},{prefix:"fi.accounts_receivable.",requireAny:["fi.accounts_receivable.subledgers"]},{prefix:"fi.accounts_payable.",requireAny:["fi.accounts_payable.subledgers"]},{prefix:"fi.bank_ledger.",requireAny:["fi.bank_ledger.bank_accounts"]},{prefix:"fi.controlling.",requireAny:["fi.controlling.cost_centers"]},{prefix:"fi.advanced_reporting.",requireAny:["fi.advanced_reporting.financial_statements"]},{prefix:"co.cost_centers.",requireAny:["co.cost_centers.master_data"]},{prefix:"co.profit_centers.",requireAny:["co.profit_centers.master_data"]},{prefix:"co.internal_orders.",requireAny:["co.internal_orders.master_data"]},{prefix:"co.profitability.",requireAny:["co.profitability.segments"]},{prefix:"co.budgets.",requireAny:["co.budgets.planning"]}];function c(e){if(!e)return!1;if("BOOLEAN"===e.valueType)return e.isEnabled;if(!e.isEnabled)return!1;if(e.isUnlimited||(e.maxInt??e.includedInt??0)>0)return!0;let r=parseFloat(e.maxDec??e.includedDec??"0");return Number.isFinite(r)&&r>0}let a=async()=>{let e=await (0,r.auth)(),n=e?.user?.id;return n?i.db.user.findUnique({where:{id:n},include:{AgencyMemberships:{where:{isActive:!0},include:{Agency:!0,Role:{include:{Permissions:{where:{granted:!0},include:{Permission:!0}}}}}},SubAccountMemberships:{where:{isActive:!0},include:{SubAccount:!0,Role:{include:{Permissions:{where:{granted:!0},include:{Permission:!0}}}}}}}}):null},o=async()=>{let e=await a();if(!e)return[];let r=e.AgencyMemberships.flatMap(e=>e.Role.Permissions.map(e=>e.Permission)),i=e.SubAccountMemberships.flatMap(e=>e.Role.Permissions.map(e=>e.Permission)),n={};for(let e of[...r,...i])n[e.key]=e;return Object.keys(n).map(e=>n[e])},l=async()=>(await o()).map(e=>e.key),u=async e=>{let r=e.trim();return(await l()).includes(r)},p=async e=>{let r=await a();if(!r)return[];let i=r.AgencyMemberships.find(r=>r.agencyId===e);return i?i.Role.Permissions.map(e=>e.Permission.key):[]},f=async e=>{let r=await a();if(!r)return[];let i=r.SubAccountMemberships.find(r=>r.subAccountId===e);return i?i.Role.Permissions.map(e=>e.Permission.key):[]},y=async(e,r)=>{let i=r.trim();return(await p(e)).includes(i)},m=async(e,r)=>{let i=r.trim();return(await f(e)).includes(i)},g=async(e,r)=>{let a,o=await (0,n.resolveEffectiveEntitlements)({scope:"SUBACCOUNT"===r?"SUBACCOUNT":"AGENCY",agencyId:e,subAccountId:null}),l="AGENCY"===r?["core.agency.","core.billing.","core.apps.","core.experimental.","crm.","fi."]:["core.subaccount.","crm.","fi."],u=(a=[],!function e(r,i){if(r&&"object"==typeof r)for(let n of Object.values(r))"string"==typeof n?i.push(n):n&&"object"==typeof n&&e(n,i)}(t.KEYS,a),Array.from(new Set(a)).sort((e,r)=>e.localeCompare(r)).map(e=>{var r;let i,n,t;return{key:e,name:(n=(i=(r=e).split("."))[i.length-1]??r,t=i[i.length-2]??"",`${t} ${n}`.trim().replace(/[-_]/g," ").replace(/\b\w/g,e=>e.toUpperCase())),description:null,category:e.split(".").slice(0,2).join("."),isSystem:!0}})).filter(e=>l.some(r=>e.key.startsWith(r))).filter(e=>(function(e,r){let i=function(e){let r=null;for(let i of s)e.startsWith(i.prefix)&&(!r||i.prefix.length>r.prefix.length)&&(r=i);return r}(e);if(!i)return!(e.startsWith("fi.")||e.startsWith("co."));if(i.requireAll?.length){for(let e of i.requireAll)if(!c(r[e]))return!1}return(!i.requireAnyAll?.length||!!i.requireAnyAll.some(e=>e.every(e=>c(r[e]))))&&(!i.requireAny?.length||i.requireAny.some(e=>c(r[e])))})(e.key,o));await i.db.permission.createMany({data:u.map(e=>({key:e.key,name:e.name,description:e.description,category:e.category,isSystem:e.isSystem})),skipDuplicates:!0});let p=await i.db.permission.findMany({where:{key:{in:u.map(e=>e.key)}},orderBy:[{category:"asc"},{key:"asc"}]}),f={};for(let e of p)f[e.category]||(f[e.category]=[]),f[e.category].push(e);return f},d=async(e,r)=>Object.values(await g(e,r)).flat().map(e=>e.key),b=async(e,r,i)=>{let n=new Set(await d(e,r)),t=i.filter(e=>!n.has(e));return{valid:0===t.length,invalidKeys:t}},A=async()=>{let e=await a();if(!e)return[];let r=[],i=new Map;for(let r of e.SubAccountMemberships){let e=r.SubAccount,n=e.agencyId,t={id:e.id,name:e.name,logo:e.subAccountLogo||void 0,type:"subaccount"};i.has(n)||i.set(n,[]),i.get(n).push(t)}for(let n of e.AgencyMemberships){let e=n.Agency,t=i.get(e.id)||[];r.push({id:e.id,name:e.name,logo:e.agencyLogo||void 0,type:"agency",subaccounts:t.length>0?t:void 0})}return r};e.s(["getAgencyPermissionKeys",0,p,"getAuthUserMemberships",0,a,"getEntitledPermissionKeys",0,d,"getEntitledPermissions",0,g,"getSubAccountPermissionKeys",0,f,"getUserAccessibleTeams",0,A,"getUserPermissionKeys",0,l,"getUserPermissions",0,o,"hasAgencyPermission",0,y,"hasPermission",0,u,"hasSubAccountPermission",0,m,"validatePermissionKeys",0,b],907117)}];

//# sourceMappingURL=src_lib_features_iam_authz_permissions_ts_ca6b2f3e._.js.map