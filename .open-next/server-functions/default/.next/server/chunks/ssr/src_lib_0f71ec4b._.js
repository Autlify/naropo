module.exports=[903581,a=>{"use strict";var b=a.i(53112);let c=a=>.01>Math.abs(a.reduce((a,b)=>a+(b.debitAmount||0),0)-a.reduce((a,b)=>a+(b.creditAmount||0),0)),d=b.z.object({lineNumber:b.z.number().int().min(1),accountId:b.z.uuid(),description:b.z.string().max(500).optional(),debitAmount:b.z.number().min(0).default(0),creditAmount:b.z.number().min(0).default(0),debitAmountBase:b.z.number().min(0).optional(),creditAmountBase:b.z.number().min(0).optional(),exchangeRate:b.z.number().positive().optional(),subledgerType:b.z.enum(["NONE","ACCOUNTS_RECEIVABLE","ACCOUNTS_PAYABLE","INVENTORY","FIXED_ASSETS","PAYROLL","BANK"]).default("NONE"),subledgerReference:b.z.string().max(100).optional(),taxCode:b.z.string().max(20).optional(),taxAmount:b.z.number().optional(),dimension1:b.z.string().max(50).optional(),dimension2:b.z.string().max(50).optional(),dimension3:b.z.string().max(50).optional(),dimension4:b.z.string().max(50).optional(),isIntercompany:b.z.boolean().default(!1),intercompanySubAccountId:b.z.string().uuid().optional()}).refine(a=>a.debitAmount>0||a.creditAmount>0,{message:"Each line must have either a debit or credit amount"}).refine(a=>!(a.debitAmount>0&&a.creditAmount>0),{message:"A line cannot have both debit and credit amounts"}),e=b.z.object({periodId:b.z.uuid(),entryDate:b.z.coerce.date(),entryType:b.z.enum(["NORMAL","OPENING","CLOSING","CARRY_FORWARD","BROUGHT_FORWARD","YEAR_END_CLOSING","ADJUSTMENT","REVERSAL","CONSOLIDATION","ELIMINATION"]).default("NORMAL"),sourceModule:b.z.enum(["MANUAL","INVOICE","PAYMENT","EXPENSE","PAYROLL","ASSET","INVENTORY","BANK","ADJUSTMENT","CONSOLIDATION","INTERCOMPANY","REVERSAL","YEAR_END","OPENING_BALANCE"]).default("MANUAL"),sourceId:b.z.string().uuid().optional(),sourceReference:b.z.string().max(100).optional(),description:b.z.string().min(1,"Description is required").max(1e3),notes:b.z.string().max(2e3).optional(),currencyCode:b.z.string().length(3).default("USD"),exchangeRate:b.z.number().positive().default(1),totalDebit:b.z.number().min(0).optional(),totalCredit:b.z.number().min(0).optional(),totalDebitBase:b.z.number().min(0).optional(),totalCreditBase:b.z.number().min(0).optional(),lines:b.z.array(d).min(2,"At least 2 lines are required for double-entry").max(100,"Maximum 100 lines per entry")}).refine(a=>c(a.lines),{message:"Total debits must equal total credits (double-entry)"}),f=e.extend({id:b.z.uuid()});b.z.object({id:b.z.uuid()}),b.z.object({id:b.z.uuid(),notes:b.z.string().max(500).optional()}),b.z.object({id:b.z.uuid(),reason:b.z.string().min(1,"Rejection reason is required").max(500)}),b.z.object({id:b.z.uuid()}),b.z.object({id:b.z.uuid(),reversalDate:b.z.coerce.date(),reason:b.z.string().min(1,"Reversal reason is required").max(500)}),b.z.object({id:b.z.uuid(),reason:b.z.string().min(1,"Void reason is required").max(500)});let g=b.z.object({id:b.z.uuid(),journalEntryId:b.z.uuid(),lineNumber:b.z.number().int(),accountId:b.z.uuid(),description:b.z.string().nullable(),debitAmount:b.z.number(),creditAmount:b.z.number(),debitAmountBase:b.z.number(),creditAmountBase:b.z.number(),exchangeRate:b.z.number().nullable(),subledgerType:b.z.string(),subledgerReference:b.z.string().nullable(),taxCode:b.z.string().nullable(),taxAmount:b.z.number().nullable(),dimension1:b.z.string().nullable(),dimension2:b.z.string().nullable(),dimension3:b.z.string().nullable(),dimension4:b.z.string().nullable(),isIntercompany:b.z.boolean(),intercompanySubAccountId:b.z.string().nullable(),createdAt:b.z.date()});b.z.object({id:b.z.uuid(),agencyId:b.z.string().nullable(),subAccountId:b.z.string().nullable(),entryNumber:b.z.string(),reference:b.z.string().nullable(),periodId:b.z.uuid(),entryDate:b.z.date(),entryType:b.z.string(),sourceModule:b.z.string(),sourceId:b.z.string().nullable(),sourceReference:b.z.string().nullable(),description:b.z.string(),notes:b.z.string().nullable(),currencyCode:b.z.string(),exchangeRate:b.z.number(),totalDebit:b.z.number(),totalCredit:b.z.number(),totalDebitBase:b.z.number(),totalCreditBase:b.z.number(),status:b.z.string(),submittedAt:b.z.date().nullable(),submittedBy:b.z.string().nullable(),approvedAt:b.z.date().nullable(),approvedBy:b.z.string().nullable(),rejectedAt:b.z.date().nullable(),rejectedBy:b.z.string().nullable(),rejectionReason:b.z.string().nullable(),postedAt:b.z.date().nullable(),postedBy:b.z.string().nullable(),createdAt:b.z.date(),createdBy:b.z.string(),updatedAt:b.z.date(),updatedBy:b.z.string().nullable(),lines:b.z.array(g).optional()}),a.s(["createJournalEntrySchema",0,e,"updateJournalEntrySchema",0,f])},213915,127179,832090,751830,377088,227310,487206,906708,378217,__turbopack_context__=>{"use strict";var __TURBOPACK__imported__module__137936__=__turbopack_context__.i(137936),__TURBOPACK__imported__module__761469__=__turbopack_context__.i(761469),__TURBOPACK__imported__module__577607__=__turbopack_context__.i(577607),__TURBOPACK__imported__module__713095__=__turbopack_context__.i(713095);async function logGLAudit(a){try{let b=await (0,__TURBOPACK__imported__module__577607__.auth)();if(!b?.user?.id)return;let c=await __TURBOPACK__imported__module__761469__.db.user.findUnique({where:{id:b.user.id},select:{id:!0,email:!0,name:!0}});if(!c)return;let d=await __TURBOPACK__imported__module__761469__.db.session.findFirst({where:{userId:b.user.id},select:{ipAddress:!0,userAgent:!0,id:!0}});await __TURBOPACK__imported__module__761469__.db.gLAuditTrail.create({data:{action:a.action,entityType:a.entityType,entityId:a.entityId,agencyId:a.agencyId,subAccountId:a.subAccountId,userId:c.id,userEmail:c.email,userName:c.name,previousValues:a.previousValues||null,newValues:a.newValues||null,reason:a.reason,ipAddress:d?.ipAddress||null,userAgent:d?.userAgent||null,sessionId:d?.id||null}})}catch(a){console.error("Failed to log GL audit trail:",a)}}async function getEntityAuditTrail(a,b){try{let c=await (0,__TURBOPACK__imported__module__577607__.auth)();if(!c?.user?.id)return[];return await __TURBOPACK__imported__module__761469__.db.gLAuditTrail.findMany({where:{entityType:a,entityId:b},orderBy:{timestamp:"desc"},take:100})}catch(a){return console.error("Failed to get audit trail:",a),[]}}async function searchAuditTrail(a){try{let b=await (0,__TURBOPACK__imported__module__577607__.auth)();if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let{page:c=1,pageSize:d=50,startDate:e,endDate:f,entityType:g,action:h,userId:i,search:j,agencyId:k,subAccountId:l}=a,m={};k&&(m.agencyId=k),l&&(m.subAccountId=l),g&&(m.entityType=g),h&&(m.action=h),i&&(m.userId=i),(e||f)&&(m.timestamp={},e&&(m.timestamp.gte=e),f&&(m.timestamp.lte=f)),j&&(m.OR=[{entityId:{contains:j,mode:"insensitive"}},{userEmail:{contains:j,mode:"insensitive"}},{userName:{contains:j,mode:"insensitive"}},{reason:{contains:j,mode:"insensitive"}}]);let[n,o]=await Promise.all([__TURBOPACK__imported__module__761469__.db.gLAuditTrail.findMany({where:m,orderBy:{timestamp:"desc"},skip:(c-1)*d,take:d,select:{id:!0,entityType:!0,entityId:!0,action:!0,userId:!0,userEmail:!0,userName:!0,timestamp:!0,previousValues:!0,newValues:!0,reason:!0,ipAddress:!0}}),__TURBOPACK__imported__module__761469__.db.gLAuditTrail.count({where:m})]);return{success:!0,data:{items:n,total:o}}}catch(a){return console.error("Failed to search audit trail:",a),{success:!1,error:"Failed to search audit trail"}}}async function getAuditEntityTypes(a){try{let b=await (0,__TURBOPACK__imported__module__577607__.auth)();if(!b?.user?.id)return[];return(await __TURBOPACK__imported__module__761469__.db.gLAuditTrail.findMany({where:{agencyId:a},select:{entityType:!0},distinct:["entityType"]})).map(a=>a.entityType)}catch{return[]}}(0,__TURBOPACK__imported__module__713095__.ensureServerEntryExports)([logGLAudit,getEntityAuditTrail,searchAuditTrail,getAuditEntityTypes]),(0,__TURBOPACK__imported__module__137936__.registerServerReference)(logGLAudit,"409d163f8f7755c4c51ce13a5109c51d096b6394d0",null),(0,__TURBOPACK__imported__module__137936__.registerServerReference)(getEntityAuditTrail,"60b08361fa2d702709b29e0e12fbd1da0d428dc9f3",null),(0,__TURBOPACK__imported__module__137936__.registerServerReference)(searchAuditTrail,"40a98229cb3511534b217e290203e86f927b0f9f2e",null),(0,__TURBOPACK__imported__module__137936__.registerServerReference)(getAuditEntityTypes,"4032d39a3e2d8f07b23271ffa0ad4f43caa01fe123",null),__turbopack_context__.s(["getAuditEntityTypes",()=>getAuditEntityTypes,"getEntityAuditTrail",()=>getEntityAuditTrail,"logGLAudit",()=>logGLAudit,"searchAuditTrail",()=>searchAuditTrail],213915);var __TURBOPACK__imported__module__137936__1=__TURBOPACK__imported__module__137936__,__TURBOPACK__imported__module__761469__1=__TURBOPACK__imported__module__761469__,__TURBOPACK__imported__module__118558__=__turbopack_context__.i(118558),__TURBOPACK__imported__module__53112__=__turbopack_context__.i(53112),__TURBOPACK__imported__module__137936__2=__TURBOPACK__imported__module__137936__,__TURBOPACK__imported__module__577607__1=__TURBOPACK__imported__module__577607__,__TURBOPACK__imported__module__761469__2=__TURBOPACK__imported__module__761469__,__TURBOPACK__imported__module__713095__1=__TURBOPACK__imported__module__713095__;let getGLContext=async()=>{let a=await (0,__TURBOPACK__imported__module__577607__1.auth)();if(!a?.user?.id)return{success:!1,error:{error:"Unauthorized: No session found",code:"NO_SESSION"}};let b=await __TURBOPACK__imported__module__761469__2.db.session.findFirst({where:{userId:a.user.id},orderBy:{lastActiveAt:"desc"},select:{activeAgencyId:!0,activeSubAccountId:!0}});if(!b?.activeAgencyId&&!b?.activeSubAccountId)return{success:!1,error:{error:"No active agency or subaccount context",code:"NO_CONTEXT"}};let c=b.activeSubAccountId?"SUBACCOUNT":"AGENCY";return{success:!0,context:{userId:a.user.id,agencyId:b.activeAgencyId??void 0,subAccountId:b.activeSubAccountId??void 0,contextType:c}}},requireAgencyContext=async()=>{let a=await getGLContext();if(!a.success)throw Error(a.error.error);if(!a.context.agencyId)throw Error("Agency context required for this operation");if(a.context.subAccountId&&"SUBACCOUNT"===a.context.contextType)throw Error("This feature is only available at Agency level");return a.context},requireAnyContext=async()=>{let a=await getGLContext();if(!a.success)throw Error(a.error.error);if(!a.context.agencyId&&!a.context.subAccountId)throw Error("Agency or SubAccount context required");return a.context};(0,__TURBOPACK__imported__module__713095__1.ensureServerEntryExports)([getGLContext,requireAgencyContext,requireAnyContext]),(0,__TURBOPACK__imported__module__137936__2.registerServerReference)(getGLContext,"00489a67608e242755bb7fb8cebc6f608098134fcc",null),(0,__TURBOPACK__imported__module__137936__2.registerServerReference)(requireAgencyContext,"00c46e3fa5f6d3ce2dec9246a5f9acf768c19c37cd",null),(0,__TURBOPACK__imported__module__137936__2.registerServerReference)(requireAnyContext,"0078fa97282c448dc8c80b2e25f8ab213778e11215",null),__turbopack_context__.s(["getGLContext",0,getGLContext,"requireAgencyContext",0,requireAgencyContext,"requireAnyContext",0,requireAnyContext],127179);let GL_ERROR_CODES={UNAUTHORIZED:"GL_UNAUTHORIZED",PERMISSION_DENIED:"GL_PERMISSION_DENIED",AGENCY_ONLY:"GL_AGENCY_ONLY",VALIDATION_FAILED:"GL_VALIDATION_FAILED",INVALID_DOUBLE_ENTRY:"GL_INVALID_DOUBLE_ENTRY",PERIOD_CLOSED:"GL_PERIOD_CLOSED",PERIOD_LOCKED:"GL_PERIOD_LOCKED",NOT_FOUND:"GL_NOT_FOUND",UNKNOWN_ERROR:"GL_UNKNOWN_ERROR"};class GLError extends Error{code;userMessage;details;constructor(a,b,c,d){super(c||b),this.name="GLError",this.code=a,this.userMessage=b,this.details=d}toResult(){return{success:!1,error:this.userMessage,code:this.code}}}class GLUnauthorizedError extends GLError{constructor(a="You are not authorized to perform this action"){super(GL_ERROR_CODES.UNAUTHORIZED,a),this.name="GLUnauthorizedError"}}class GLPermissionError extends GLError{constructor(a){super(GL_ERROR_CODES.PERMISSION_DENIED,"You don't have permission to perform this action",`Missing permission: ${a}`,{permission:a}),this.name="GLPermissionError"}}class GLAgencyOnlyError extends GLError{constructor(a){super(GL_ERROR_CODES.AGENCY_ONLY,`${a} is only available at Agency level`,`Attempted to access agency-only feature: ${a}`,{feature:a}),this.name="GLAgencyOnlyError"}}class GLValidationError extends GLError{constructor(a,b){super(GL_ERROR_CODES.VALIDATION_FAILED,a,void 0,b?{field:b}:void 0),this.name="GLValidationError"}}class GLDoubleEntryError extends GLError{constructor(a,b){super(GL_ERROR_CODES.INVALID_DOUBLE_ENTRY,"Debits and credits must balance",`Imbalance: debits=${a}, credits=${b}`,{debits:a,credits:b}),this.name="GLDoubleEntryError"}}class GLPeriodClosedError extends GLError{constructor(a){super(GL_ERROR_CODES.PERIOD_CLOSED,`Cannot modify entries in ${a||"closed"} period`,void 0,{periodName:a}),this.name="GLPeriodClosedError"}}class GLPeriodLockedError extends GLError{constructor(a){super(GL_ERROR_CODES.PERIOD_LOCKED,`Period ${a||""} is locked and cannot be modified`,void 0,{periodName:a}),this.name="GLPeriodLockedError"}}class GLNotFoundError extends GLError{constructor(a,b){super(GL_ERROR_CODES.NOT_FOUND,`${a} not found`,`${a} with ID ${b} not found`,{entity:a,id:b}),this.name="GLNotFoundError"}}let successResult=a=>({success:!0,data:a}),errorResult=(a,b)=>a instanceof GLError?a.toResult():{success:!1,error:"string"==typeof a?a:"An error occurred",code:b},withGLErrorHandling=async(a,b="An error occurred")=>{try{let b=await a();return successResult(b)}catch(a){if(a instanceof GLError)return a.toResult();return console.error("GL Action Error:",a),errorResult(a instanceof Error?a.message:b,GL_ERROR_CODES.UNKNOWN_ERROR)}};__turbopack_context__.s(["errorResult",0,errorResult,"successResult",0,successResult],832090);var __TURBOPACK__imported__module__137936__3=__TURBOPACK__imported__module__137936__,__TURBOPACK__imported__module__351728__=__turbopack_context__.i(351728),__TURBOPACK__imported__module__537150__=__turbopack_context__.i(537150);let GL_PERMISSION_KEYS=__TURBOPACK__imported__module__537150__.KEYS.fi.general_ledger,FI_CONFIG_KEYS=__TURBOPACK__imported__module__537150__.KEYS.fi.configuration,FI_MASTER_DATA_KEYS=__TURBOPACK__imported__module__537150__.KEYS.fi.master_data,getContextWhereClause=a=>"SUBACCOUNT"===a.contextType&&a.subAccountId?{subAccountId:a.subAccountId}:{agencyId:a.agencyId,subAccountId:null},getContextCreateData=a=>"SUBACCOUNT"===a.contextType&&a.subAccountId?{agencyId:null,subAccountId:a.subAccountId}:{agencyId:a.agencyId??null,subAccountId:null},isAgencyOnlyFeature=(a,b)=>"SUBACCOUNT"===a.contextType,requireAgencyOnlyFeature=(a,b)=>{if("SUBACCOUNT"===a.contextType)throw Error(`${b} is only available at Agency level`);if(!a.agencyId)throw Error(`Agency context required for ${b}`)};__turbopack_context__.s(["FI_CONFIG_KEYS",0,FI_CONFIG_KEYS,"FI_MASTER_DATA_KEYS",0,FI_MASTER_DATA_KEYS,"GL_PERMISSION_KEYS",0,GL_PERMISSION_KEYS,"getContextCreateData",0,getContextCreateData],751830);var __TURBOPACK__imported__module__713095__2=__TURBOPACK__imported__module__713095__;let checkGLPermission=async(a,b)=>"SUBACCOUNT"===a.contextType&&a.subAccountId?(0,__TURBOPACK__imported__module__351728__.hasSubAccountPermission)(a.subAccountId,b):!!a.agencyId&&(0,__TURBOPACK__imported__module__351728__.hasAgencyPermission)(a.agencyId,b),checkGLPermissionWithReason=async(a,b)=>await checkGLPermission(a,b)?{allowed:!0}:{allowed:!1,reason:`Missing permission: ${b}`},requireGLPermission=async(a,b)=>{if(!await checkGLPermission(a,b))throw Error(`Unauthorized: Missing permission ${b}`)},checkGLPermissions=async(a,b)=>(await Promise.all(b.map(b=>checkGLPermission(a,b)))).every(Boolean),canViewAccounts=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.accounts.view),canManageAccounts=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.accounts.manage),canViewCustomers=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.customers.view),canManageCustomers=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.customers.manage),canViewVendors=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.vendors.view),canManageVendors=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.vendors.manage),canViewBanks=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.banks.view),canManageBanks=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.banks.manage),canViewCOAConfig=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.accounts.view),canManageCOAConfig=async a=>checkGLPermission(a,FI_MASTER_DATA_KEYS.accounts.manage),canViewFiscalYears=async a=>checkGLPermission(a,FI_CONFIG_KEYS.fiscal_years.view),canManageFiscalYears=async a=>checkGLPermission(a,FI_CONFIG_KEYS.fiscal_years.manage),canViewCurrencies=async a=>checkGLPermission(a,FI_CONFIG_KEYS.currencies.view),canManageCurrencies=async a=>checkGLPermission(a,FI_CONFIG_KEYS.currencies.manage),canViewTaxSettings=async a=>checkGLPermission(a,FI_CONFIG_KEYS.tax_settings.view),canManageTaxSettings=async a=>checkGLPermission(a,FI_CONFIG_KEYS.tax_settings.manage),canViewTolerances=async a=>checkGLPermission(a,FI_CONFIG_KEYS.tolerances.view),canManageTolerances=async a=>checkGLPermission(a,FI_CONFIG_KEYS.tolerances.manage),canViewNumberRanges=async a=>checkGLPermission(a,FI_CONFIG_KEYS.number_ranges.view),canManageNumberRanges=async a=>checkGLPermission(a,FI_CONFIG_KEYS.number_ranges.manage),canViewPostingRules=async a=>checkGLPermission(a,FI_CONFIG_KEYS.posting_rules.view),canManagePostingRules=async a=>checkGLPermission(a,FI_CONFIG_KEYS.posting_rules.manage),canViewSettings=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.settings.view),canManageSettings=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.settings.manage),canViewJournals=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.journal_entries.read),canCreateJournals=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.journal_entries.create),canApproveJournals=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.journal_entries.approve),canViewReports=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.reports.view),canGenerateReports=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.reports.generate),canApproveReports=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.reports.approve),canViewConsolidation=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.consolidation.view),canManageConsolidation=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.consolidation.manage),canViewYearEnd=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.year_end.view),canManageYearEnd=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.year_end.manage),canCloseYearEnd=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.year_end.close),canViewReconciliation=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.reconciliation.view),canManageReconciliation=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.reconciliation.manage),canClearReconciliation=async a=>checkGLPermission(a,GL_PERMISSION_KEYS.reconciliation.clear);(0,__TURBOPACK__imported__module__713095__2.ensureServerEntryExports)([checkGLPermission,checkGLPermissionWithReason,requireGLPermission,checkGLPermissions,canViewAccounts,canManageAccounts,canViewCustomers,canManageCustomers,canViewVendors,canManageVendors,canViewBanks,canManageBanks,canViewCOAConfig,canManageCOAConfig,canViewFiscalYears,canManageFiscalYears,canViewCurrencies,canManageCurrencies,canViewTaxSettings,canManageTaxSettings,canViewTolerances,canManageTolerances,canViewNumberRanges,canManageNumberRanges,canViewPostingRules,canManagePostingRules,canViewSettings,canManageSettings,canViewJournals,canCreateJournals,canApproveJournals,canViewReports,canGenerateReports,canApproveReports,canViewConsolidation,canManageConsolidation,canViewYearEnd,canManageYearEnd,canCloseYearEnd,canViewReconciliation,canManageReconciliation,canClearReconciliation]),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(checkGLPermission,"6008884c57b41d783ebdfb59c32ef017bad40ba3ca",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(checkGLPermissionWithReason,"600c57bb3bbb89453d7734c4279bba97eda659441b",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(requireGLPermission,"6032ab7eafcdeb5f3bd404d4f6e8262054270153f9",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(checkGLPermissions,"6071b5ec9255fa848d5c09e64d3b7f5dd00469ff3e",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewAccounts,"40e7ed183b623a3970fd4dbe6ba24ed52771b380ee",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageAccounts,"4094b517c270e87072e010ab41bea61ba8bffa2d12",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewCustomers,"4046d3a30431e8568af665331b7d27449c0ea8cf6f",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageCustomers,"40a05e657f3ca530cef2f59edcc1296459c1fc883d",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewVendors,"4089558de812e56f9734a1337ce3c45262771ae380",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageVendors,"40edba71c9219814406a8cca4c5cf7b869d5c9d763",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewBanks,"406daf806750e18cbd911bf7450e347048c738ae76",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageBanks,"40a4f796ded27e11055b1c38cb0925091b171e244b",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewCOAConfig,"40d1e75025c38f39ce985e50cbb4a3a2511bec5922",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageCOAConfig,"40946c382779df7461968071e554622e91d5800eb6",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewFiscalYears,"400b3e3a1444691a8f474f11b8d784d36057585194",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageFiscalYears,"401b6a9601bde468caf5d038bf859c19f1fc869d59",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewCurrencies,"4055e61262daa6b2990b1f96266703f9559186f67f",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageCurrencies,"40233486143fc4507ba0fefa8d472e46e09bd06d0f",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewTaxSettings,"405486df6acbaa9a732a1397eecf5b3471989d2b77",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageTaxSettings,"40a6c9f4fe95fbe4524958e5e1563d836944459706",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewTolerances,"40dc30f442500afcb4d9cedd865336c8a9235e8c77",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageTolerances,"40bbcff69a12e6e797db2379c043880f1350caa6bf",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewNumberRanges,"40549de3e406a355938e839f6e5a39a49f6f001703",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageNumberRanges,"4060434f35113f79a870eefc6e3702fd828f123e61",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewPostingRules,"40bf6edcd65701ab5d3552d479951d212e85bd6715",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManagePostingRules,"4007fc861d6f8294ec9a8ae8965c10c65304234f37",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewSettings,"40b60ddc960d1ebebaea228b682e90d6f50d2538ac",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageSettings,"405ebb6b40f8f8fcf2600bf7189fb7a61d1081d288",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewJournals,"40ccc9e77d6218b0029e352b79c31def8b38219470",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canCreateJournals,"405acf5029431308e2e39b7b9539c8b80821ff4bba",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canApproveJournals,"4044e166d73d7352b142f3153c6fe85ae23049443a",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewReports,"40d6c166b91319accd894714cf8ea502cde3136b3b",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canGenerateReports,"40f344b4de265f4499b7ae5651084186037d1a5a72",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canApproveReports,"40cd066a6b2df96b8092e907c2eb66da5d9716bf4e",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewConsolidation,"40da6df7306a3dff8a56569c83ba733ad2b62b0bd3",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageConsolidation,"40ae0707a7fd4edfba2092b96993db83eaa55bf314",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewYearEnd,"40c8f2c9ec53a1ab42467f3fd9277680daccaa6812",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageYearEnd,"40245fe28f8380608e26a9906e28759a793212f46a",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canCloseYearEnd,"407314ecf3f24b52c8444aa8a4c4eeb915aa10986f",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canViewReconciliation,"40172e6bcff699c20e6c3ae2ca66e917d2a1dd1cda",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canManageReconciliation,"40e309d212a8c7a7f74fd81dcf5d2ffbdc6ab7a04b",null),(0,__TURBOPACK__imported__module__137936__3.registerServerReference)(canClearReconciliation,"4086f6f0c379de4c2df2bf6198c46fb11e5e9ff5ab",null),__turbopack_context__.s(["canApproveJournals",0,canApproveJournals,"canApproveReports",0,canApproveReports,"canClearReconciliation",0,canClearReconciliation,"canCloseYearEnd",0,canCloseYearEnd,"canCreateJournals",0,canCreateJournals,"canGenerateReports",0,canGenerateReports,"canManageAccounts",0,canManageAccounts,"canManageBanks",0,canManageBanks,"canManageCOAConfig",0,canManageCOAConfig,"canManageConsolidation",0,canManageConsolidation,"canManageCurrencies",0,canManageCurrencies,"canManageCustomers",0,canManageCustomers,"canManageFiscalYears",0,canManageFiscalYears,"canManageNumberRanges",0,canManageNumberRanges,"canManagePostingRules",0,canManagePostingRules,"canManageReconciliation",0,canManageReconciliation,"canManageSettings",0,canManageSettings,"canManageTaxSettings",0,canManageTaxSettings,"canManageTolerances",0,canManageTolerances,"canManageVendors",0,canManageVendors,"canManageYearEnd",0,canManageYearEnd,"canViewAccounts",0,canViewAccounts,"canViewBanks",0,canViewBanks,"canViewCOAConfig",0,canViewCOAConfig,"canViewConsolidation",0,canViewConsolidation,"canViewCurrencies",0,canViewCurrencies,"canViewCustomers",0,canViewCustomers,"canViewFiscalYears",0,canViewFiscalYears,"canViewJournals",0,canViewJournals,"canViewNumberRanges",0,canViewNumberRanges,"canViewPostingRules",0,canViewPostingRules,"canViewReconciliation",0,canViewReconciliation,"canViewReports",0,canViewReports,"canViewSettings",0,canViewSettings,"canViewTaxSettings",0,canViewTaxSettings,"canViewTolerances",0,canViewTolerances,"canViewVendors",0,canViewVendors,"canViewYearEnd",0,canViewYearEnd,"checkGLPermission",0,checkGLPermission,"checkGLPermissionWithReason",0,checkGLPermissionWithReason,"checkGLPermissions",0,checkGLPermissions,"requireGLPermission",0,requireGLPermission],377088);var __TURBOPACK__imported__module__137936__4=__TURBOPACK__imported__module__137936__,__TURBOPACK__imported__module__761469__3=__TURBOPACK__imported__module__761469__,__TURBOPACK__imported__module__577607__2=__TURBOPACK__imported__module__577607__,__TURBOPACK__imported__module__118558__1=__TURBOPACK__imported__module__118558__,__TURBOPACK__imported__module__351728__1=__TURBOPACK__imported__module__351728__,__TURBOPACK__imported__module__53112__1=__TURBOPACK__imported__module__53112__;let postingRuleCategoryEnum=__TURBOPACK__imported__module__53112__1.z.enum(["FOREX","ROUNDING","DISCREPANCY","TAX","CLEARING","ALLOCATION","CUSTOM"]),sourceModuleEnum=__TURBOPACK__imported__module__53112__1.z.enum(["MANUAL","INVOICE","PAYMENT","EXPENSE","PAYROLL","ASSET","INVENTORY","BANK","ADJUSTMENT","CONSOLIDATION","INTERCOMPANY","REVERSAL","YEAR_END","OPENING_BALANCE"]),toleranceConfigSchema=__TURBOPACK__imported__module__53112__1.z.object({minAmount:__TURBOPACK__imported__module__53112__1.z.number().min(0).optional(),maxAmount:__TURBOPACK__imported__module__53112__1.z.number().positive().optional(),tolerancePercent:__TURBOPACK__imported__module__53112__1.z.number().min(0).max(100).optional(),toleranceFixed:__TURBOPACK__imported__module__53112__1.z.number().min(0).optional()}),forexSideConfigSchema=__TURBOPACK__imported__module__53112__1.z.object({gainAccountId:__TURBOPACK__imported__module__53112__1.z.uuid(),lossAccountId:__TURBOPACK__imported__module__53112__1.z.uuid(),realizedOnly:__TURBOPACK__imported__module__53112__1.z.boolean().default(!1),unrealizedAccountId:__TURBOPACK__imported__module__53112__1.z.string().uuid().optional()}),ruleConditionsSchema=__TURBOPACK__imported__module__53112__1.z.object({documentTypes:__TURBOPACK__imported__module__53112__1.z.array(__TURBOPACK__imported__module__53112__1.z.string()).optional(),currencies:__TURBOPACK__imported__module__53112__1.z.array(__TURBOPACK__imported__module__53112__1.z.string()).optional(),accountTypes:__TURBOPACK__imported__module__53112__1.z.array(__TURBOPACK__imported__module__53112__1.z.string()).optional(),dimensions:__TURBOPACK__imported__module__53112__1.z.record(__TURBOPACK__imported__module__53112__1.z.string(),__TURBOPACK__imported__module__53112__1.z.array(__TURBOPACK__imported__module__53112__1.z.string())).optional(),customExpression:__TURBOPACK__imported__module__53112__1.z.string().optional()}),postingRuleSchema=__TURBOPACK__imported__module__53112__1.z.object({code:__TURBOPACK__imported__module__53112__1.z.string().min(1,"Code is required").max(50),name:__TURBOPACK__imported__module__53112__1.z.string().min(1,"Name is required").max(100),description:__TURBOPACK__imported__module__53112__1.z.string().max(500).optional(),category:postingRuleCategoryEnum.default("CUSTOM"),sourceModule:sourceModuleEnum,debitAccountId:__TURBOPACK__imported__module__53112__1.z.string().uuid("Invalid debit account"),creditAccountId:__TURBOPACK__imported__module__53112__1.z.string().uuid("Invalid credit account"),amountType:__TURBOPACK__imported__module__53112__1.z.enum(["FULL","PERCENTAGE","FIXED"]),percentage:__TURBOPACK__imported__module__53112__1.z.number().min(0).max(100).optional(),fixedAmount:__TURBOPACK__imported__module__53112__1.z.number().optional(),tolerance:toleranceConfigSchema.optional(),forexConfig:forexSideConfigSchema.optional(),conditions:ruleConditionsSchema.optional(),isActive:__TURBOPACK__imported__module__53112__1.z.boolean().default(!0),priority:__TURBOPACK__imported__module__53112__1.z.number().int().min(0).max(999).default(100),autoPost:__TURBOPACK__imported__module__53112__1.z.boolean().default(!1),effectiveFrom:__TURBOPACK__imported__module__53112__1.z.coerce.date().optional(),effectiveTo:__TURBOPACK__imported__module__53112__1.z.coerce.date().optional()}),updatePostingRuleSchema=postingRuleSchema.partial().extend({id:__TURBOPACK__imported__module__53112__1.z.uuid()}),createPostingRuleSchema=postingRuleSchema,POSTING_RULE_TEMPLATES={FOREX_REALIZED:{code:"FOREX_REALIZED",name:"Realized Forex Gain/Loss",description:"Automatically post exchange differences on payment settlement",category:"FOREX",sourceModule:"PAYMENT",amountType:"FULL",priority:10,autoPost:!0},FOREX_UNREALIZED:{code:"FOREX_UNREALIZED",name:"Unrealized Forex Gain/Loss",description:"Period-end exchange rate revaluation",category:"FOREX",sourceModule:"ADJUSTMENT",amountType:"FULL",priority:20,autoPost:!0},PAYMENT_DISCREPANCY:{code:"PAY_DISC",name:"Payment Discrepancy",description:"Write off small payment differences under threshold",category:"DISCREPANCY",sourceModule:"PAYMENT",amountType:"FULL",priority:50,autoPost:!0,tolerance:{maxAmount:10,toleranceFixed:10}},ROUNDING:{code:"ROUNDING",name:"Rounding Adjustment",description:"Adjust for cent/decimal rounding differences",category:"ROUNDING",sourceModule:"ADJUSTMENT",amountType:"FULL",priority:100,autoPost:!0,tolerance:{maxAmount:.99}},CASH_CLEARING:{code:"CASH_CLEAR",name:"Cash Clearing",description:"Clear petty cash to main cash account",category:"CLEARING",sourceModule:"BANK",amountType:"FULL",priority:30,autoPost:!1},TAX_CLEARING:{code:"TAX_CLEAR",name:"Tax Clearing",description:"Clear VAT/GST accounts to tax payable",category:"TAX",sourceModule:"ADJUSTMENT",amountType:"FULL",priority:40,autoPost:!1}};__turbopack_context__.s(["POSTING_RULE_TEMPLATES",0,POSTING_RULE_TEMPLATES,"postingRuleSchema",0,postingRuleSchema,"updatePostingRuleSchema",0,updatePostingRuleSchema],227310);var __TURBOPACK__imported__module__713095__3=__TURBOPACK__imported__module__713095__;let getContext=async()=>{let a=await (0,__TURBOPACK__imported__module__577607__2.auth)();if(!a?.user?.id)return null;let b=await __TURBOPACK__imported__module__761469__3.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},checkPermission=async(a,b)=>a.subAccountId?(0,__TURBOPACK__imported__module__351728__1.hasSubAccountPermission)(a.subAccountId,b):!!a.agencyId&&(0,__TURBOPACK__imported__module__351728__1.hasAgencyPermission)(a.agencyId,b),getPostingRule=async a=>{try{let b=await getContext();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await checkPermission(b,"fi.configuration.posting_rules.view"))return{success:!1,error:"Unauthorized: Missing permission"};let c=await __TURBOPACK__imported__module__761469__3.db.postingRule.findUnique({where:{id:a},include:{DebitAccount:{select:{id:!0,code:!0,name:!0}},CreditAccount:{select:{id:!0,code:!0,name:!0}}}});if(!c)return{success:!1,error:"Posting rule not found"};if(!(b.subAccountId?c.subAccountId===b.subAccountId:c.agencyId===b.agencyId))return{success:!1,error:"Unauthorized: Access denied"};return{success:!0,data:c}}catch(a){return console.error("Error fetching posting rule:",a),{success:!1,error:"Failed to fetch posting rule"}}},listPostingRules=async a=>{try{let b=await getContext();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await checkPermission(b,"fi.configuration.posting_rules.view"))return{success:!1,error:"Unauthorized: Missing permission"};let c=a?.page??1,d=a?.pageSize??50,e=(c-1)*d,f=b.subAccountId?{subAccountId:b.subAccountId}:{agencyId:b.agencyId,subAccountId:null};a?.isActive!==void 0&&(f.isActive=a.isActive),a?.triggerType&&(f.sourceModule=a.triggerType);let[g,h]=await Promise.all([__TURBOPACK__imported__module__761469__3.db.postingRule.findMany({where:f,include:{DebitAccount:{select:{id:!0,code:!0,name:!0}},CreditAccount:{select:{id:!0,code:!0,name:!0}}},orderBy:[{priority:"asc"},{name:"asc"}],skip:e,take:d}),__TURBOPACK__imported__module__761469__3.db.postingRule.count({where:f})]);return{success:!0,data:{rules:g,total:h}}}catch(a){return console.error("Error listing posting rules:",a),{success:!1,error:"Failed to list posting rules"}}},createPostingRule=async a=>{try{let b=await getContext();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await checkPermission(b,"fi.configuration.posting_rules.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let c=postingRuleSchema.safeParse(a);if(!c.success)return{success:!1,error:c.error.issues[0]?.message??"Validation failed"};let{conditions:d,...e}=c.data,f=await __TURBOPACK__imported__module__761469__3.db.postingRule.create({data:{...e,conditions:d??{},agencyId:b.agencyId??null,subAccountId:b.subAccountId??null,createdBy:b.userId},include:{DebitAccount:{select:{id:!0,code:!0,name:!0}},CreditAccount:{select:{id:!0,code:!0,name:!0}}}});return await logGLAudit({action:"CREATE",entityType:"PostingRule",entityId:f.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Created posting rule: ${f.name}`}),(0,__TURBOPACK__imported__module__118558__1.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/posting-rules`),{success:!0,data:f}}catch(a){return console.error("Error creating posting rule:",a),{success:!1,error:"Failed to create posting rule"}}},updatePostingRule=async a=>{try{let b=await getContext();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await checkPermission(b,"fi.configuration.posting_rules.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let c=updatePostingRuleSchema.safeParse(a);if(!c.success)return{success:!1,error:c.error.issues[0]?.message??"Validation failed"};let{id:d,conditions:e,debitAccountId:f,creditAccountId:g,...h}=c.data,i=await __TURBOPACK__imported__module__761469__3.db.postingRule.findUnique({where:{id:d}});if(!i)return{success:!1,error:"Posting rule not found"};if(!(b.subAccountId?i.subAccountId===b.subAccountId:i.agencyId===b.agencyId))return{success:!1,error:"Unauthorized: Access denied"};let j=await __TURBOPACK__imported__module__761469__3.db.postingRule.update({where:{id:d},data:{...h,...f&&{debitAccountId:f},...g&&{creditAccountId:g},...void 0!==e&&{conditions:e},updatedBy:b.userId},include:{DebitAccount:{select:{id:!0,code:!0,name:!0}},CreditAccount:{select:{id:!0,code:!0,name:!0}}}});return await logGLAudit({action:"UPDATE",entityType:"PostingRule",entityId:j.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Updated posting rule: ${j.name}`,previousValues:i,newValues:j}),(0,__TURBOPACK__imported__module__118558__1.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/posting-rules`),{success:!0,data:j}}catch(a){return console.error("Error updating posting rule:",a),{success:!1,error:"Failed to update posting rule"}}},deletePostingRule=async a=>{try{let b=await getContext();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await checkPermission(b,"fi.configuration.posting_rules.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let c=await __TURBOPACK__imported__module__761469__3.db.postingRule.findUnique({where:{id:a}});if(!c)return{success:!1,error:"Posting rule not found"};if(!(b.subAccountId?c.subAccountId===b.subAccountId:c.agencyId===b.agencyId))return{success:!1,error:"Unauthorized: Access denied"};return await __TURBOPACK__imported__module__761469__3.db.postingRule.delete({where:{id:a}}),await logGLAudit({action:"DELETE",entityType:"PostingRule",entityId:a,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Deleted posting rule: ${c.name}`}),(0,__TURBOPACK__imported__module__118558__1.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/posting-rules`),{success:!0}}catch(a){return console.error("Error deleting posting rule:",a),{success:!1,error:"Failed to delete posting rule"}}},togglePostingRuleStatus=async(a,b)=>updatePostingRule({id:a,isActive:b}),executePostingRules=async(a,b)=>{try{let c=await getContext();if(!c)return{success:!1,error:"Unauthorized: No session found"};if(!await checkPermission(c,"fi.configuration.posting_rules.simulate"))return{success:!1,error:"Unauthorized: Missing permission"};let d=c.subAccountId?{subAccountId:c.subAccountId}:{agencyId:c.agencyId,subAccountId:null},e=await __TURBOPACK__imported__module__761469__3.db.postingRule.findMany({where:{...d,sourceModule:a,isActive:!0},orderBy:{priority:"asc"}}),f=0,g=[];for(let a of e)try{if(!evaluateConditions(a.conditions,b))continue;let d=calculateAmount(a,b);if(d<=0)continue;let e=await __TURBOPACK__imported__module__761469__3.db.financialPeriod.findFirst({where:{agencyId:c.agencyId,startDate:{lte:new Date},endDate:{gte:new Date}}});if(!e){g.push(`Rule ${a.name}: No open period found`);continue}await __TURBOPACK__imported__module__761469__3.db.journalEntry.create({data:{agencyId:c?.agencyId??null,subAccountId:c?.subAccountId??null,periodId:e.id,entryNumber:await generateEntryNumber(c),entryDate:new Date,description:`Auto-post: ${a.name}`,reference:`RULE-${a.id}`,status:"POSTED",createdBy:c.userId,postedBy:c.userId,postedAt:new Date,Lines:{create:[{lineNumber:1,accountId:a.debitAccountId,debitAmount:d,creditAmount:0,debitAmountBase:d,creditAmountBase:0,description:a.description??a.name},{lineNumber:2,accountId:a.creditAccountId,debitAmount:0,creditAmount:d,debitAmountBase:0,creditAmountBase:d,description:a.description??a.name}]}}}),f++}catch(b){g.push(`Rule ${a.name}: ${b.message}`)}return{success:!0,data:{entriesCreated:f,errors:g}}}catch(a){return console.error("Error executing posting rules:",a),{success:!1,error:"Failed to execute posting rules"}}};function evaluateConditions(a,b){return!a||0===a.length||a.every(a=>{let c=b[a.field];switch(a.operator){case"EQUALS":return c===a.value;case"NOT_EQUALS":return c!==a.value;case"GREATER_THAN":return Number(c)>Number(a.value);case"LESS_THAN":return Number(c)<Number(a.value);case"CONTAINS":return String(c).includes(String(a.value));case"IN":return Array.isArray(a.value)&&a.value.includes(c);default:return!1}})}function calculateAmount(rule,data){switch(rule.amountType){case"FIXED":return Number(rule.amountValue)||0;case"PERCENTAGE":let baseAmount=Number(data.amount)||0;return baseAmount*(Number(rule.amountValue)/100);case"FORMULA":try{let formula=rule.amountFormula?.replace(/\{(\w+)\}/g,(a,b)=>String(data[b]||0));return eval(formula)||0}catch{return 0}default:return 0}}async function generateEntryNumber(a){let b=a.subAccountId?{subAccountId:a.subAccountId}:{agencyId:a.agencyId,subAccountId:null},c=await __TURBOPACK__imported__module__761469__3.db.journalEntry.count({where:b}),d=new Date().getFullYear();return`JE-${d}-${String(c+1).padStart(6,"0")}`}async function generateLineNumber(a){let b=a.subAccountId?{subAccountId:a.subAccountId}:{agencyId:a.agencyId,subAccountId:null};return await __TURBOPACK__imported__module__761469__3.db.journalEntryLine.count({where:b})+1}(0,__TURBOPACK__imported__module__713095__3.ensureServerEntryExports)([getPostingRule,listPostingRules,createPostingRule,updatePostingRule,deletePostingRule,togglePostingRuleStatus,executePostingRules]),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(getPostingRule,"40fe045a9e4fc825e77c849c40c2cabe33f1cf80f7",null),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(listPostingRules,"4043d8eb96afbf2bce9f524945a41980021046d477",null),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(createPostingRule,"401d2ad340b8ac068a1d905fba52b595d84054daf8",null),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(updatePostingRule,"40ccf4ceb1932729c606fdbaa618b2f24c34d813b8",null),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(deletePostingRule,"407a09f403e9d8b83a61c2f9aadf2e6a9763960c8b",null),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(togglePostingRuleStatus,"60ca4be5624eb95270c8d4116b4ecbb25724a67c07",null),(0,__TURBOPACK__imported__module__137936__4.registerServerReference)(executePostingRules,"603c9d095c244f3d8448548e485782885d1951207f",null),__turbopack_context__.s(["createPostingRule",0,createPostingRule,"deletePostingRule",0,deletePostingRule,"executePostingRules",0,executePostingRules,"getPostingRule",0,getPostingRule,"listPostingRules",0,listPostingRules,"togglePostingRuleStatus",0,togglePostingRuleStatus,"updatePostingRule",0,updatePostingRule],487206);let EVENT_KEYS={fi:{general_ledger:{accounts:{created:"fi.general_ledger.accounts.created",updated:"fi.general_ledger.accounts.updated",deleted:"fi.general_ledger.accounts.deleted",archived:"fi.general_ledger.accounts.archived",restored:"fi.general_ledger.accounts.restored"},journal_entries:{created:"fi.general_ledger.journal_entries.created",drafted:"fi.general_ledger.journal_entries.drafted",submitted:"fi.general_ledger.journal_entries.submitted",approved:"fi.general_ledger.journal_entries.approved",rejected:"fi.general_ledger.journal_entries.rejected",posted:"fi.general_ledger.journal_entries.posted",reversed:"fi.general_ledger.journal_entries.reversed",voided:"fi.general_ledger.journal_entries.voided",imported:"fi.general_ledger.journal_entries.imported"},periods:{created:"fi.general_ledger.periods.created",opened:"fi.general_ledger.periods.opened",closed:"fi.general_ledger.periods.closed",locked:"fi.general_ledger.periods.locked",unlocked:"fi.general_ledger.periods.unlocked",reopened:"fi.general_ledger.periods.reopened"},balances:{updated:"fi.general_ledger.balances.updated",snapshot:"fi.general_ledger.balances.snapshot",recalculated:"fi.general_ledger.balances.recalculated"},reconciliation:{started:"fi.general_ledger.reconciliation.started",completed:"fi.general_ledger.reconciliation.completed",matched:"fi.general_ledger.reconciliation.matched",unmatched:"fi.general_ledger.reconciliation.unmatched",cleared:"fi.general_ledger.reconciliation.cleared"},year_end:{initiated:"fi.general_ledger.year_end.initiated",completed:"fi.general_ledger.year_end.completed",reversed:"fi.general_ledger.year_end.reversed"},carry_forward:{created:"fi.general_ledger.carry_forward.created",processed:"fi.general_ledger.carry_forward.processed"},consolidation:{started:"fi.general_ledger.consolidation.started",completed:"fi.general_ledger.consolidation.completed",failed:"fi.general_ledger.consolidation.failed"},reports:{generated:"fi.general_ledger.reports.generated",exported:"fi.general_ledger.reports.exported",scheduled:"fi.general_ledger.reports.scheduled"},posting_rules:{executed:"fi.general_ledger.posting_rules.executed",failed:"fi.general_ledger.posting_rules.failed",skipped:"fi.general_ledger.posting_rules.skipped"},forex:{revalued:"fi.general_ledger.forex.revalued",gain_posted:"fi.general_ledger.forex.gain_posted",loss_posted:"fi.general_ledger.forex.loss_posted"},adjustments:{posted:"fi.general_ledger.adjustments.posted",reversed:"fi.general_ledger.adjustments.reversed"},fanout:{received:"fi.general_ledger.fanout.received",processed:"fi.general_ledger.fanout.processed",failed:"fi.general_ledger.fanout.failed"}},accounts_payable:{invoices:{created:"fi.accounts_payable.invoices.created",received:"fi.accounts_payable.invoices.received",verified:"fi.accounts_payable.invoices.verified",approved:"fi.accounts_payable.invoices.approved",rejected:"fi.accounts_payable.invoices.rejected",posted:"fi.accounts_payable.invoices.posted",cancelled:"fi.accounts_payable.invoices.cancelled"},payments:{scheduled:"fi.accounts_payable.payments.scheduled",approved:"fi.accounts_payable.payments.approved",executed:"fi.accounts_payable.payments.executed",completed:"fi.accounts_payable.payments.completed",failed:"fi.accounts_payable.payments.failed",reversed:"fi.accounts_payable.payments.reversed"},credit_memos:{created:"fi.accounts_payable.credit_memos.created",applied:"fi.accounts_payable.credit_memos.applied",posted:"fi.accounts_payable.credit_memos.posted"},vendors:{created:"fi.accounts_payable.vendors.created",updated:"fi.accounts_payable.vendors.updated",blocked:"fi.accounts_payable.vendors.blocked",unblocked:"fi.accounts_payable.vendors.unblocked"},aging:{calculated:"fi.accounts_payable.aging.calculated",overdue:"fi.accounts_payable.aging.overdue"}},accounts_receivable:{invoices:{created:"fi.accounts_receivable.invoices.created",drafted:"fi.accounts_receivable.invoices.drafted",sent:"fi.accounts_receivable.invoices.sent",billed:"fi.accounts_receivable.invoices.billed",posted:"fi.accounts_receivable.invoices.posted",cancelled:"fi.accounts_receivable.invoices.cancelled",overdue:"fi.accounts_receivable.invoices.overdue"},payments:{expected:"fi.accounts_receivable.payments.expected",received:"fi.accounts_receivable.payments.received",applied:"fi.accounts_receivable.payments.applied",partial:"fi.accounts_receivable.payments.partial",overpaid:"fi.accounts_receivable.payments.overpaid",reversed:"fi.accounts_receivable.payments.reversed"},credit_memos:{created:"fi.accounts_receivable.credit_memos.created",applied:"fi.accounts_receivable.credit_memos.applied",refunded:"fi.accounts_receivable.credit_memos.refunded",posted:"fi.accounts_receivable.credit_memos.posted"},customers:{created:"fi.accounts_receivable.customers.created",updated:"fi.accounts_receivable.customers.updated",blocked:"fi.accounts_receivable.customers.blocked",unblocked:"fi.accounts_receivable.customers.unblocked"},aging:{calculated:"fi.accounts_receivable.aging.calculated",overdue:"fi.accounts_receivable.aging.overdue"},dunning:{sent:"fi.accounts_receivable.dunning.sent",escalated:"fi.accounts_receivable.dunning.escalated"}},bank_ledger:{accounts:{created:"fi.bank_ledger.accounts.created",updated:"fi.bank_ledger.accounts.updated",connected:"fi.bank_ledger.accounts.connected",disconnected:"fi.bank_ledger.accounts.disconnected"},statements:{imported:"fi.bank_ledger.statements.imported",parsed:"fi.bank_ledger.statements.parsed",validated:"fi.bank_ledger.statements.validated",failed:"fi.bank_ledger.statements.failed"},transactions:{imported:"fi.bank_ledger.transactions.imported",categorized:"fi.bank_ledger.transactions.categorized",matched:"fi.bank_ledger.transactions.matched",unmatched:"fi.bank_ledger.transactions.unmatched"},reconciliation:{started:"fi.bank_ledger.reconciliation.started",completed:"fi.bank_ledger.reconciliation.completed",approved:"fi.bank_ledger.reconciliation.approved",discrepancy:"fi.bank_ledger.reconciliation.discrepancy"},transfers:{initiated:"fi.bank_ledger.transfers.initiated",pending:"fi.bank_ledger.transfers.pending",completed:"fi.bank_ledger.transfers.completed",failed:"fi.bank_ledger.transfers.failed"},cash_position:{updated:"fi.bank_ledger.cash_position.updated",forecast:"fi.bank_ledger.cash_position.forecast"}}},co:{cost_centers:{allocation:{posted:"co.cost_centers.allocation.posted"},assessment:{posted:"co.cost_centers.assessment.posted"}}},apps:{stripe:{payment:{received:"apps.stripe.payment.received"},payout:{sent:"apps.stripe.payout.sent"},fee:{charged:"apps.stripe.fee.charged"},refund:{issued:"apps.stripe.refund.issued"}}},mm:{inventory_management:{inventory:{received:"mm.inventory_management.inventory.received",issued:"mm.inventory_management.inventory.issued",adjusted:"mm.inventory_management.inventory.adjusted"}}}};__turbopack_context__.s(["EVENT_KEYS",0,EVENT_KEYS],906708);let EVENT_TRIGGER_MAPPING={[EVENT_KEYS.fi.general_ledger.accounts.created]:"GL_ACCOUNT_CREATED",[EVENT_KEYS.fi.general_ledger.accounts.updated]:"GL_ACCOUNT_UPDATED",[EVENT_KEYS.fi.general_ledger.accounts.deleted]:"GL_ACCOUNT_DELETED",[EVENT_KEYS.fi.general_ledger.accounts.archived]:"GL_ACCOUNT_ARCHIVED",[EVENT_KEYS.fi.general_ledger.accounts.restored]:"GL_ACCOUNT_RESTORED",[EVENT_KEYS.fi.general_ledger.journal_entries.created]:"JOURNAL_CREATED",[EVENT_KEYS.fi.general_ledger.journal_entries.drafted]:"JOURNAL_DRAFTED",[EVENT_KEYS.fi.general_ledger.journal_entries.submitted]:"JOURNAL_SUBMITTED",[EVENT_KEYS.fi.general_ledger.journal_entries.approved]:"JOURNAL_APPROVED",[EVENT_KEYS.fi.general_ledger.journal_entries.rejected]:"JOURNAL_REJECTED",[EVENT_KEYS.fi.general_ledger.journal_entries.posted]:"JOURNAL_POSTED",[EVENT_KEYS.fi.general_ledger.journal_entries.reversed]:"JOURNAL_REVERSED",[EVENT_KEYS.fi.general_ledger.journal_entries.voided]:"JOURNAL_VOIDED",[EVENT_KEYS.fi.general_ledger.journal_entries.imported]:"JOURNAL_IMPORTED",[EVENT_KEYS.fi.general_ledger.periods.created]:"PERIOD_CREATED",[EVENT_KEYS.fi.general_ledger.periods.opened]:"PERIOD_OPENED",[EVENT_KEYS.fi.general_ledger.periods.closed]:"PERIOD_CLOSED",[EVENT_KEYS.fi.general_ledger.periods.locked]:"PERIOD_LOCKED",[EVENT_KEYS.fi.general_ledger.periods.unlocked]:"PERIOD_UNLOCKED",[EVENT_KEYS.fi.general_ledger.periods.reopened]:"PERIOD_REOPENED",[EVENT_KEYS.fi.general_ledger.balances.updated]:"BALANCE_UPDATED",[EVENT_KEYS.fi.general_ledger.balances.snapshot]:"BALANCE_SNAPSHOT",[EVENT_KEYS.fi.general_ledger.balances.recalculated]:"BALANCE_RECALCULATED",[EVENT_KEYS.fi.general_ledger.reconciliation.started]:"GL_RECON_STARTED",[EVENT_KEYS.fi.general_ledger.reconciliation.completed]:"GL_RECON_COMPLETED",[EVENT_KEYS.fi.general_ledger.reconciliation.matched]:"GL_RECON_MATCHED",[EVENT_KEYS.fi.general_ledger.reconciliation.unmatched]:"GL_RECON_UNMATCHED",[EVENT_KEYS.fi.general_ledger.reconciliation.cleared]:"GL_RECON_CLEARED",[EVENT_KEYS.fi.general_ledger.year_end.initiated]:"YEAR_END_INITIATED",[EVENT_KEYS.fi.general_ledger.year_end.completed]:"YEAR_END_COMPLETED",[EVENT_KEYS.fi.general_ledger.year_end.reversed]:"YEAR_END_REVERSED",[EVENT_KEYS.fi.general_ledger.carry_forward.created]:"CARRY_FORWARD_CREATED",[EVENT_KEYS.fi.general_ledger.carry_forward.processed]:"CARRY_FORWARD_PROCESSED",[EVENT_KEYS.fi.general_ledger.consolidation.started]:"CONSOLIDATION_STARTED",[EVENT_KEYS.fi.general_ledger.consolidation.completed]:"CONSOLIDATION_COMPLETED",[EVENT_KEYS.fi.general_ledger.consolidation.failed]:"CONSOLIDATION_FAILED",[EVENT_KEYS.fi.general_ledger.reports.generated]:"REPORT_GENERATED",[EVENT_KEYS.fi.general_ledger.reports.exported]:"REPORT_EXPORTED",[EVENT_KEYS.fi.general_ledger.reports.scheduled]:"REPORT_SCHEDULED",[EVENT_KEYS.fi.general_ledger.posting_rules.executed]:"POSTING_RULE_EXECUTED",[EVENT_KEYS.fi.general_ledger.posting_rules.failed]:"POSTING_RULE_FAILED",[EVENT_KEYS.fi.general_ledger.posting_rules.skipped]:"POSTING_RULE_SKIPPED",[EVENT_KEYS.fi.general_ledger.forex.revalued]:"FOREX_REVALUED",[EVENT_KEYS.fi.general_ledger.forex.gain_posted]:"FOREX_GAIN_POSTED",[EVENT_KEYS.fi.general_ledger.forex.loss_posted]:"FOREX_LOSS_POSTED",[EVENT_KEYS.fi.general_ledger.adjustments.posted]:"ADJUSTMENT_POSTED",[EVENT_KEYS.fi.general_ledger.adjustments.reversed]:"ADJUSTMENT_REVERSED",[EVENT_KEYS.fi.general_ledger.fanout.received]:"FANOUT_RECEIVED",[EVENT_KEYS.fi.general_ledger.fanout.processed]:"FANOUT_PROCESSED",[EVENT_KEYS.fi.general_ledger.fanout.failed]:"FANOUT_FAILED",[EVENT_KEYS.fi.accounts_payable.invoices.created]:"AP_INVOICE_CREATED",[EVENT_KEYS.fi.accounts_payable.invoices.received]:"AP_INVOICE_RECEIVED",[EVENT_KEYS.fi.accounts_payable.invoices.verified]:"AP_INVOICE_VERIFIED",[EVENT_KEYS.fi.accounts_payable.invoices.approved]:"AP_INVOICE_APPROVED",[EVENT_KEYS.fi.accounts_payable.invoices.rejected]:"AP_INVOICE_REJECTED",[EVENT_KEYS.fi.accounts_payable.invoices.posted]:"AP_INVOICE_POSTED",[EVENT_KEYS.fi.accounts_payable.invoices.cancelled]:"AP_INVOICE_CANCELLED",[EVENT_KEYS.fi.accounts_payable.payments.scheduled]:"AP_PAYMENT_SCHEDULED",[EVENT_KEYS.fi.accounts_payable.payments.approved]:"AP_PAYMENT_APPROVED",[EVENT_KEYS.fi.accounts_payable.payments.executed]:"AP_PAYMENT_EXECUTED",[EVENT_KEYS.fi.accounts_payable.payments.completed]:"AP_PAYMENT_COMPLETED",[EVENT_KEYS.fi.accounts_payable.payments.failed]:"AP_PAYMENT_FAILED",[EVENT_KEYS.fi.accounts_payable.payments.reversed]:"AP_PAYMENT_REVERSED",[EVENT_KEYS.fi.accounts_payable.credit_memos.created]:"AP_CREDIT_MEMO_CREATED",[EVENT_KEYS.fi.accounts_payable.credit_memos.applied]:"AP_CREDIT_MEMO_APPLIED",[EVENT_KEYS.fi.accounts_payable.credit_memos.posted]:"AP_CREDIT_MEMO_POSTED",[EVENT_KEYS.fi.accounts_payable.vendors.created]:"AP_VENDOR_CREATED",[EVENT_KEYS.fi.accounts_payable.vendors.updated]:"AP_VENDOR_UPDATED",[EVENT_KEYS.fi.accounts_payable.vendors.blocked]:"AP_VENDOR_BLOCKED",[EVENT_KEYS.fi.accounts_payable.vendors.unblocked]:"AP_VENDOR_UNBLOCKED",[EVENT_KEYS.fi.accounts_payable.aging.calculated]:"AP_AGING_CALCULATED",[EVENT_KEYS.fi.accounts_payable.aging.overdue]:"AP_AGING_OVERDUE",[EVENT_KEYS.fi.accounts_receivable.invoices.created]:"AR_INVOICE_CREATED",[EVENT_KEYS.fi.accounts_receivable.invoices.drafted]:"AR_INVOICE_DRAFTED",[EVENT_KEYS.fi.accounts_receivable.invoices.sent]:"AR_INVOICE_SENT",[EVENT_KEYS.fi.accounts_receivable.invoices.billed]:"AR_INVOICE_BILLED",[EVENT_KEYS.fi.accounts_receivable.invoices.posted]:"AR_INVOICE_POSTED",[EVENT_KEYS.fi.accounts_receivable.invoices.cancelled]:"AR_INVOICE_CANCELLED",[EVENT_KEYS.fi.accounts_receivable.invoices.overdue]:"AR_INVOICE_OVERDUE",[EVENT_KEYS.fi.accounts_receivable.payments.expected]:"AR_PAYMENT_EXPECTED",[EVENT_KEYS.fi.accounts_receivable.payments.received]:"AR_PAYMENT_RECEIVED",[EVENT_KEYS.fi.accounts_receivable.payments.applied]:"AR_PAYMENT_APPLIED",[EVENT_KEYS.fi.accounts_receivable.payments.partial]:"AR_PAYMENT_PARTIAL",[EVENT_KEYS.fi.accounts_receivable.payments.overpaid]:"AR_PAYMENT_OVERPAID",[EVENT_KEYS.fi.accounts_receivable.payments.reversed]:"AR_PAYMENT_REVERSED",[EVENT_KEYS.fi.accounts_receivable.credit_memos.created]:"AR_CREDIT_MEMO_CREATED",[EVENT_KEYS.fi.accounts_receivable.credit_memos.applied]:"AR_CREDIT_MEMO_APPLIED",[EVENT_KEYS.fi.accounts_receivable.credit_memos.refunded]:"AR_CREDIT_MEMO_REFUNDED",[EVENT_KEYS.fi.accounts_receivable.credit_memos.posted]:"AR_CREDIT_MEMO_POSTED",[EVENT_KEYS.fi.accounts_receivable.customers.created]:"AR_CUSTOMER_CREATED",[EVENT_KEYS.fi.accounts_receivable.customers.updated]:"AR_CUSTOMER_UPDATED",[EVENT_KEYS.fi.accounts_receivable.customers.blocked]:"AR_CUSTOMER_BLOCKED",[EVENT_KEYS.fi.accounts_receivable.customers.unblocked]:"AR_CUSTOMER_UNBLOCKED",[EVENT_KEYS.fi.accounts_receivable.aging.calculated]:"AR_AGING_CALCULATED",[EVENT_KEYS.fi.accounts_receivable.aging.overdue]:"AR_AGING_OVERDUE",[EVENT_KEYS.fi.accounts_receivable.dunning.sent]:"AR_DUNNING_SENT",[EVENT_KEYS.fi.accounts_receivable.dunning.escalated]:"AR_DUNNING_ESCALATED",[EVENT_KEYS.fi.bank_ledger.accounts.created]:"BL_ACCOUNT_CREATED",[EVENT_KEYS.fi.bank_ledger.accounts.updated]:"BL_ACCOUNT_UPDATED",[EVENT_KEYS.fi.bank_ledger.accounts.connected]:"BL_ACCOUNT_CONNECTED",[EVENT_KEYS.fi.bank_ledger.accounts.disconnected]:"BL_ACCOUNT_DISCONNECTED",[EVENT_KEYS.fi.bank_ledger.statements.imported]:"BL_STATEMENT_IMPORTED",[EVENT_KEYS.fi.bank_ledger.statements.parsed]:"BL_STATEMENT_PARSED",[EVENT_KEYS.fi.bank_ledger.statements.validated]:"BL_STATEMENT_VALIDATED",[EVENT_KEYS.fi.bank_ledger.statements.failed]:"BL_STATEMENT_FAILED",[EVENT_KEYS.fi.bank_ledger.transactions.imported]:"BL_TXN_IMPORTED",[EVENT_KEYS.fi.bank_ledger.transactions.categorized]:"BL_TXN_CATEGORIZED",[EVENT_KEYS.fi.bank_ledger.transactions.matched]:"BL_TXN_MATCHED",[EVENT_KEYS.fi.bank_ledger.transactions.unmatched]:"BL_TXN_UNMATCHED",[EVENT_KEYS.fi.bank_ledger.reconciliation.started]:"BL_RECON_STARTED",[EVENT_KEYS.fi.bank_ledger.reconciliation.completed]:"BL_RECON_COMPLETED",[EVENT_KEYS.fi.bank_ledger.reconciliation.approved]:"BL_RECON_APPROVED",[EVENT_KEYS.fi.bank_ledger.reconciliation.discrepancy]:"BL_RECON_DISCREPANCY",[EVENT_KEYS.fi.bank_ledger.transfers.initiated]:"BL_TRANSFER_INITIATED",[EVENT_KEYS.fi.bank_ledger.transfers.pending]:"BL_TRANSFER_PENDING",[EVENT_KEYS.fi.bank_ledger.transfers.completed]:"BL_TRANSFER_COMPLETED",[EVENT_KEYS.fi.bank_ledger.transfers.failed]:"BL_TRANSFER_FAILED",[EVENT_KEYS.fi.bank_ledger.cash_position.updated]:"BL_CASH_POSITION_UPDATED",[EVENT_KEYS.fi.bank_ledger.cash_position.forecast]:"BL_CASH_POSITION_FORECAST",[EVENT_KEYS.co.cost_centers.allocation.posted]:"COST_ALLOCATION",[EVENT_KEYS.co.cost_centers.assessment.posted]:"COST_ASSESSMENT",[EVENT_KEYS.apps.stripe.payment.received]:"STRIPE_PAYMENT",[EVENT_KEYS.apps.stripe.payout.sent]:"STRIPE_PAYOUT",[EVENT_KEYS.apps.stripe.fee.charged]:"STRIPE_FEE",[EVENT_KEYS.apps.stripe.refund.issued]:"STRIPE_REFUND",[EVENT_KEYS.mm.inventory_management.inventory.received]:"INVENTORY_RECEIPT",[EVENT_KEYS.mm.inventory_management.inventory.issued]:"INVENTORY_ISSUE",[EVENT_KEYS.mm.inventory_management.inventory.adjusted]:"INVENTORY_ADJUSTMENT"};function isValidEventKey(a){return a in EVENT_TRIGGER_MAPPING}function getTriggerType(a){return isValidEventKey(a)?EVENT_TRIGGER_MAPPING[a]:a.split(".").pop()?.toUpperCase()??a.toUpperCase()}function getAllTriggerTypes(){return[...new Set(Object.values(EVENT_TRIGGER_MAPPING))]}function getEventKeysForTrigger(a){return Object.entries(EVENT_TRIGGER_MAPPING).filter(([,b])=>b===a).map(([a])=>a)}var __TURBOPACK__imported__module__713095__4=__TURBOPACK__imported__module__713095__;let moduleEventSchema=__TURBOPACK__imported__module__53112__.z.object({id:__TURBOPACK__imported__module__53112__.z.uuid(),timestamp:__TURBOPACK__imported__module__53112__.z.date().default(()=>new Date),source:__TURBOPACK__imported__module__53112__.z.object({module:__TURBOPACK__imported__module__53112__.z.string(),version:__TURBOPACK__imported__module__53112__.z.string().default("1.0.0")}),type:__TURBOPACK__imported__module__53112__.z.string(),entity:__TURBOPACK__imported__module__53112__.z.object({type:__TURBOPACK__imported__module__53112__.z.string(),id:__TURBOPACK__imported__module__53112__.z.string()}),data:__TURBOPACK__imported__module__53112__.z.object({amount:__TURBOPACK__imported__module__53112__.z.number(),currency:__TURBOPACK__imported__module__53112__.z.string().default("USD"),accountId:__TURBOPACK__imported__module__53112__.z.string().optional(),costCenterId:__TURBOPACK__imported__module__53112__.z.string().optional(),reference:__TURBOPACK__imported__module__53112__.z.string(),description:__TURBOPACK__imported__module__53112__.z.string(),metadata:__TURBOPACK__imported__module__53112__.z.record(__TURBOPACK__imported__module__53112__.z.string(),__TURBOPACK__imported__module__53112__.z.any()).default({})}),context:__TURBOPACK__imported__module__53112__.z.object({agencyId:__TURBOPACK__imported__module__53112__.z.string(),subAccountId:__TURBOPACK__imported__module__53112__.z.string().optional(),userId:__TURBOPACK__imported__module__53112__.z.string()})});async function processEvent(a){let b=moduleEventSchema.safeParse(a);if(!b.success)return errorResult(`Invalid event: ${b.error.message}`);let c=b.data,d=await __TURBOPACK__imported__module__761469__1.db.fanoutLog.create({data:{agencyId:c.context.agencyId,eventId:c.id,eventType:c.type,sourceModule:c.source.module,entityType:c.entity.type,entityId:c.entity.id,status:"PROCESSING"}});try{let a=getTriggerType(c.type),b={eventId:c.id,amount:c.data.amount,currency:c.data.currency,reference:c.data.reference,description:c.data.description,accountId:c.data.accountId,costCenterId:c.data.costCenterId,entityType:c.entity.type,entityId:c.entity.id,...c.data.metadata},e=await executePostingRules(a,b);if(!e.success)return await __TURBOPACK__imported__module__761469__1.db.fanoutLog.update({where:{id:d.id},data:{status:"FAILED",errorMessage:e.error,processedAt:new Date}}),successResult({success:!1,entriesCreated:0,journalEntryIds:[],errors:[e.error??"Unknown error"]});let f=e.data?.entriesCreated??0,g=e.data?.errors??[],h="SUCCESS";return 0===f&&0===g.length?h="SKIPPED":g.length>0&&f>0?h="PARTIAL":g.length>0&&0===f&&(h="FAILED"),await __TURBOPACK__imported__module__761469__1.db.fanoutLog.update({where:{id:d.id},data:{status:h,entriesCreated:f,errorMessage:g.length>0?g.join("; "):null,processedAt:new Date}}),successResult({success:"SUCCESS"===h||"PARTIAL"===h,entriesCreated:f,journalEntryIds:[],errors:g})}catch(a){return await __TURBOPACK__imported__module__761469__1.db.fanoutLog.update({where:{id:d.id},data:{status:"FAILED",errorMessage:a.message??"Unknown error",processedAt:new Date}}),console.error("Fanout processing error:",a),errorResult(`Fanout failed: ${a.message}`)}}async function emitEvent(a,b,c,d){let e=await getGLContext();if(!e.success)return errorResult(e.error.error);let{context:f}=e;return processEvent({id:crypto.randomUUID(),timestamp:new Date,source:{module:a,version:"1.0.0"},type:b,entity:c,data:{amount:d.amount,currency:d.currency??"USD",reference:d.reference,description:d.description,accountId:d.accountId,costCenterId:d.costCenterId,metadata:d.metadata??{}},context:{agencyId:f.agencyId,subAccountId:f.subAccountId??void 0,userId:f.userId}})}async function getFanoutLogs(a){let b=await getGLContext();if(!b.success)return errorResult(b.error.error);let{context:c}=b;if(!await checkGLPermission(c,FI_CONFIG_KEYS.posting_rules.view))return errorResult("Permission denied");try{let b={agencyId:c.agencyId};a?.status&&(b.status=a.status),a?.eventType&&(b.eventType=a.eventType),a?.entityType&&(b.entityType=a.entityType),a?.entityId&&(b.entityId=a.entityId);let[d,e]=await Promise.all([__TURBOPACK__imported__module__761469__1.db.fanoutLog.findMany({where:b,orderBy:{createdAt:"desc"},take:a?.limit??50,skip:a?.offset??0,include:{Connector:{select:{id:!0,name:!0,connectorType:!0}}}}),__TURBOPACK__imported__module__761469__1.db.fanoutLog.count({where:b})]);return successResult({logs:d,total:e})}catch(a){return console.error("Error fetching fanout logs:",a),errorResult("Failed to fetch fanout logs")}}async function getEntityFanoutStatus(a,b){let c=await getGLContext();if(!c.success)return errorResult(c.error.error);let{context:d}=c;try{let c=await __TURBOPACK__imported__module__761469__1.db.fanoutLog.findMany({where:{agencyId:d.agencyId,entityType:a,entityId:b},orderBy:{createdAt:"desc"}});return successResult(c)}catch(a){return console.error("Error fetching entity fanout status:",a),errorResult("Failed to fetch fanout status")}}async function retryFanout(a){let b=await getGLContext();if(!b.success)return errorResult(b.error.error);let{context:c}=b;if(!await checkGLPermission(c,FI_CONFIG_KEYS.posting_rules.manage))return errorResult("Permission denied");try{let b=await __TURBOPACK__imported__module__761469__1.db.fanoutLog.findUnique({where:{id:a}});if(!b)return errorResult("Fanout log not found");if("FAILED"!==b.status&&"PARTIAL"!==b.status)return errorResult("Only failed or partial fanouts can be retried");if(b.retryCount>=3)return errorResult("Maximum retry attempts reached");await __TURBOPACK__imported__module__761469__1.db.fanoutLog.update({where:{id:a},data:{retryCount:b.retryCount+1,lastRetry:new Date,status:"PENDING"}});let d={id:b.eventId,timestamp:new Date,source:{module:b.sourceModule,version:"1.0.0"},type:b.eventType,entity:{type:b.entityType,id:b.entityId},data:{amount:0,currency:"USD",reference:`RETRY-${a}`,description:`Retry of ${b.eventType}`,metadata:{}},context:{agencyId:b.agencyId,userId:c.userId}},e=await processEvent(d);return await logGLAudit({action:"UPDATE",entityType:"FANOUT",entityId:a,description:`Retried fanout: ${b.eventType}`,agencyId:c.agencyId??void 0}),e}catch(a){return console.error("Error retrying fanout:",a),errorResult("Failed to retry fanout")}}async function retryAllFailed(){let a=await getGLContext();if(!a.success)return errorResult(a.error.error);let{context:b}=a;if(!await checkGLPermission(b,FI_CONFIG_KEYS.posting_rules.manage))return errorResult("Permission denied");try{let a=await __TURBOPACK__imported__module__761469__1.db.fanoutLog.findMany({where:{agencyId:b.agencyId,status:{in:["FAILED","PARTIAL"]},retryCount:{lt:3}},take:100}),c=0,d=0,e=0;for(let b of a){c++;let a=await retryFanout(b.id);a.success&&a.data?.success?d++:e++}return(0,__TURBOPACK__imported__module__118558__.revalidatePath)("/agency/[agencyId]/fi/general-ledger/settings"),successResult({attempted:c,succeeded:d,failed:e})}catch(a){return console.error("Error retrying all failed:",a),errorResult("Failed to retry fanouts")}}async function processStripePayment(a,b,c){let d=await emitEventDirect({id:crypto.randomUUID(),timestamp:new Date,source:{module:"stripe",version:"1.0.0"},type:"stripe.payment.received",entity:{type:"Payment",id:a.id},data:{amount:a.netAmount/100,currency:a.currency.toUpperCase(),reference:a.id,description:`Stripe payment ${a.id}`,metadata:{grossAmount:a.amount/100,fee:a.fee/100,customerId:a.customerId,invoiceId:a.invoiceId,...a.metadata}},context:{agencyId:b,userId:c}});return a.fee>0&&await emitEventDirect({id:crypto.randomUUID(),timestamp:new Date,source:{module:"stripe",version:"1.0.0"},type:"stripe.fee.charged",entity:{type:"Payment",id:a.id},data:{amount:a.fee/100,currency:a.currency.toUpperCase(),reference:`${a.id}-FEE`,description:`Stripe processing fee for ${a.id}`,metadata:{paymentId:a.id}},context:{agencyId:b,userId:c}}),d}async function emitEventDirect(a){return processEvent(a)}(0,__TURBOPACK__imported__module__713095__4.ensureServerEntryExports)([processEvent,emitEvent,getFanoutLogs,getEntityFanoutStatus,retryFanout,retryAllFailed,processStripePayment]),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(processEvent,"40e25413b9706730f422c5a10b86ca89fa66d99cd7",null),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(emitEvent,"7831bec1448aef4952bf02822727f049454860d1f4",null),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(getFanoutLogs,"408fa5fa458d742727b70674a1a59218e00a4b72ba",null),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(getEntityFanoutStatus,"60d82f83f66fab22e2b275b5618edd5833b9c8456d",null),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(retryFanout,"405ada616a63c8132ee18d206a9ac2e9c05c1bade0",null),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(retryAllFailed,"004d8b23ffe285560428ab2fe8cbf709aea4250932",null),(0,__TURBOPACK__imported__module__137936__1.registerServerReference)(processStripePayment,"70f83c1fcdb2923e5c889f53c9a6c774a1340eb8db",null),__turbopack_context__.s(["emitEvent",()=>emitEvent,"getEntityFanoutStatus",()=>getEntityFanoutStatus,"getFanoutLogs",()=>getFanoutLogs,"processEvent",()=>processEvent,"processStripePayment",()=>processStripePayment,"retryAllFailed",()=>retryAllFailed,"retryFanout",()=>retryFanout],378217)},68184,978561,a=>{"use strict";var b=a.i(137936),c=a.i(761469),d=a.i(577607),e=a.i(118558),f=a.i(351728),g=a.i(903581),h=a.i(213915),i=a.i(378217),j=a.i(906708);a.i(659281);var k,l,m=a.i(349618),n=9e15,o=1e9,p="0123456789abcdef",q="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",r="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",s={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-9e15,maxE:9e15,crypto:!1},t=!0,u="[DecimalError] ",v=u+"Invalid argument: ",w=u+"Precision limit exceeded",x=u+"crypto unavailable",y="[object Decimal]",z=Math.floor,A=Math.pow,B=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,C=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,D=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,E=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,F=1e7,G=7,H=0x1fffffffffffff,I=q.length-1,J=r.length-1,K={toStringTag:y};function L(a){var b,c,d,e=a.length-1,f="",g=a[0];if(e>0){for(f+=g,b=1;b<e;b++)(c=G-(d=a[b]+"").length)&&(f+=X(c)),f+=d;(c=G-(d=(g=a[b])+"").length)&&(f+=X(c))}else if(0===g)return"0";for(;g%10==0;)g/=10;return f+g}function M(a,b,c){if(a!==~~a||a<b||a>c)throw Error(v+a)}function N(a,b,c,d){var e,f,g,h;for(f=a[0];f>=10;f/=10)--b;return--b<0?(b+=G,e=0):(e=Math.ceil((b+1)/G),b%=G),f=A(10,G-b),h=a[e]%f|0,null==d?b<3?(0==b?h=h/100|0:1==b&&(h=h/10|0),g=c<4&&99999==h||c>3&&49999==h||5e4==h||0==h):g=(c<4&&h+1==f||c>3&&h+1==f/2)&&(a[e+1]/f/100|0)==A(10,b-2)-1||(h==f/2||0==h)&&(a[e+1]/f/100|0)==0:b<4?(0==b?h=h/1e3|0:1==b?h=h/100|0:2==b&&(h=h/10|0),g=(d||c<4)&&9999==h||!d&&c>3&&4999==h):g=((d||c<4)&&h+1==f||!d&&c>3&&h+1==f/2)&&(a[e+1]/f/1e3|0)==A(10,b-3)-1,g}function O(a,b,c){for(var d,e,f=[0],g=0,h=a.length;g<h;){for(e=f.length;e--;)f[e]*=b;for(f[0]+=p.indexOf(a.charAt(g++)),d=0;d<f.length;d++)f[d]>c-1&&(void 0===f[d+1]&&(f[d+1]=0),f[d+1]+=f[d]/c|0,f[d]%=c)}return f.reverse()}function P(a,b){var c,d,e;if(b.isZero())return b;(d=b.d.length)<32?e=(1/ag(4,c=Math.ceil(d/3))).toString():(c=16,e="2.3283064365386962890625e-10"),a.precision+=c,b=af(a,1,b.times(e),new a(1));for(var f=c;f--;){var g=b.times(b);b=g.times(g).minus(g).times(8).plus(1)}return a.precision-=c,b}K.absoluteValue=K.abs=function(){var a=new this.constructor(this);return a.s<0&&(a.s=1),R(a)},K.ceil=function(){return R(new this.constructor(this),this.e+1,2)},K.clampedTo=K.clamp=function(a,b){var c=this,d=c.constructor;if(a=new d(a),b=new d(b),!a.s||!b.s)return new d(NaN);if(a.gt(b))throw Error(v+b);return 0>c.cmp(a)?a:c.cmp(b)>0?b:new d(c)},K.comparedTo=K.cmp=function(a){var b,c,d,e,f=this,g=f.d,h=(a=new f.constructor(a)).d,i=f.s,j=a.s;if(!g||!h)return i&&j?i!==j?i:g===h?0:!g^i<0?1:-1:NaN;if(!g[0]||!h[0])return g[0]?i:h[0]?-j:0;if(i!==j)return i;if(f.e!==a.e)return f.e>a.e^i<0?1:-1;for(b=0,c=(d=g.length)<(e=h.length)?d:e;b<c;++b)if(g[b]!==h[b])return g[b]>h[b]^i<0?1:-1;return d===e?0:d>e^i<0?1:-1},K.cosine=K.cos=function(){var a,b,c=this,d=c.constructor;return c.d?c.d[0]?(a=d.precision,b=d.rounding,d.precision=a+Math.max(c.e,c.sd())+G,d.rounding=1,c=P(d,ah(d,c)),d.precision=a,d.rounding=b,R(2==l||3==l?c.neg():c,a,b,!0)):new d(1):new d(NaN)},K.cubeRoot=K.cbrt=function(){var a,b,c,d,e,f,g,h,i,j,k=this,l=k.constructor;if(!k.isFinite()||k.isZero())return new l(k);for(t=!1,(f=k.s*A(k.s*k,1/3))&&Math.abs(f)!=1/0?d=new l(f.toString()):(c=L(k.d),(f=((a=k.e)-c.length+1)%3)&&(c+=1==f||-2==f?"0":"00"),f=A(c,1/3),a=z((a+1)/3)-(a%3==(a<0?-1:2)),(d=new l(c=f==1/0?"5e"+a:(c=f.toExponential()).slice(0,c.indexOf("e")+1)+a)).s=k.s),g=(a=l.precision)+3;;)if(d=Q((j=(i=(h=d).times(h).times(h)).plus(k)).plus(k).times(h),j.plus(i),g+2,1),L(h.d).slice(0,g)===(c=L(d.d)).slice(0,g)){if("9999"!=(c=c.slice(g-3,g+1))&&(e||"4999"!=c)){+c&&(+c.slice(1)||"5"!=c.charAt(0))||(R(d,a+1,1),b=!d.times(d).times(d).eq(k));break}if(!e&&(R(h,a+1,0),h.times(h).times(h).eq(k))){d=h;break}g+=4,e=1}return t=!0,R(d,a,l.rounding,b)},K.decimalPlaces=K.dp=function(){var a,b=this.d,c=NaN;if(b){if(c=((a=b.length-1)-z(this.e/G))*G,a=b[a])for(;a%10==0;a/=10)c--;c<0&&(c=0)}return c},K.dividedBy=K.div=function(a){return Q(this,new this.constructor(a))},K.dividedToIntegerBy=K.divToInt=function(a){var b=this,c=b.constructor;return R(Q(b,new c(a),0,1,1),c.precision,c.rounding)},K.equals=K.eq=function(a){return 0===this.cmp(a)},K.floor=function(){return R(new this.constructor(this),this.e+1,3)},K.greaterThan=K.gt=function(a){return this.cmp(a)>0},K.greaterThanOrEqualTo=K.gte=function(a){var b=this.cmp(a);return 1==b||0===b},K.hyperbolicCosine=K.cosh=function(){var a,b,c,d,e,f=this,g=f.constructor,h=new g(1);if(!f.isFinite())return new g(f.s?1/0:NaN);if(f.isZero())return h;c=g.precision,d=g.rounding,g.precision=c+Math.max(f.e,f.sd())+4,g.rounding=1,(e=f.d.length)<32?b=(1/ag(4,a=Math.ceil(e/3))).toString():(a=16,b="2.3283064365386962890625e-10"),f=af(g,1,f.times(b),new g(1),!0);for(var i,j=a,k=new g(8);j--;)i=f.times(f),f=h.minus(i.times(k.minus(i.times(k))));return R(f,g.precision=c,g.rounding=d,!0)},K.hyperbolicSine=K.sinh=function(){var a,b,c,d,e=this,f=e.constructor;if(!e.isFinite()||e.isZero())return new f(e);if(b=f.precision,c=f.rounding,f.precision=b+Math.max(e.e,e.sd())+4,f.rounding=1,(d=e.d.length)<3)e=af(f,2,e,e,!0);else{a=(a=1.4*Math.sqrt(d))>16?16:0|a,e=af(f,2,e=e.times(1/ag(5,a)),e,!0);for(var g,h=new f(5),i=new f(16),j=new f(20);a--;)g=e.times(e),e=e.times(h.plus(g.times(i.times(g).plus(j))))}return f.precision=b,f.rounding=c,R(e,b,c,!0)},K.hyperbolicTangent=K.tanh=function(){var a,b,c=this,d=c.constructor;return c.isFinite()?c.isZero()?new d(c):(a=d.precision,b=d.rounding,d.precision=a+7,d.rounding=1,Q(c.sinh(),c.cosh(),d.precision=a,d.rounding=b)):new d(c.s)},K.inverseCosine=K.acos=function(){var a=this,b=a.constructor,c=a.abs().cmp(1),d=b.precision,e=b.rounding;return -1!==c?0===c?a.isNeg()?V(b,d,e):new b(0):new b(NaN):a.isZero()?V(b,d+4,e).times(.5):(b.precision=d+6,b.rounding=1,a=new b(1).minus(a).div(a.plus(1)).sqrt().atan(),b.precision=d,b.rounding=e,a.times(2))},K.inverseHyperbolicCosine=K.acosh=function(){var a,b,c=this,d=c.constructor;return c.lte(1)?new d(c.eq(1)?0:NaN):c.isFinite()?(a=d.precision,b=d.rounding,d.precision=a+Math.max(Math.abs(c.e),c.sd())+4,d.rounding=1,t=!1,c=c.times(c).minus(1).sqrt().plus(c),t=!0,d.precision=a,d.rounding=b,c.ln()):new d(c)},K.inverseHyperbolicSine=K.asinh=function(){var a,b,c=this,d=c.constructor;return!c.isFinite()||c.isZero()?new d(c):(a=d.precision,b=d.rounding,d.precision=a+2*Math.max(Math.abs(c.e),c.sd())+6,d.rounding=1,t=!1,c=c.times(c).plus(1).sqrt().plus(c),t=!0,d.precision=a,d.rounding=b,c.ln())},K.inverseHyperbolicTangent=K.atanh=function(){var a,b,c,d,e=this,f=e.constructor;return e.isFinite()?e.e>=0?new f(e.abs().eq(1)?e.s/0:e.isZero()?e:NaN):(a=f.precision,b=f.rounding,Math.max(d=e.sd(),a)<-(2*e.e)-1)?R(new f(e),a,b,!0):(f.precision=c=d-e.e,e=Q(e.plus(1),new f(1).minus(e),c+a,1),f.precision=a+4,f.rounding=1,e=e.ln(),f.precision=a,f.rounding=b,e.times(.5)):new f(NaN)},K.inverseSine=K.asin=function(){var a,b,c,d,e=this,f=e.constructor;return e.isZero()?new f(e):(b=e.abs().cmp(1),c=f.precision,d=f.rounding,-1!==b)?0===b?((a=V(f,c+4,d).times(.5)).s=e.s,a):new f(NaN):(f.precision=c+6,f.rounding=1,e=e.div(new f(1).minus(e.times(e)).sqrt().plus(1)).atan(),f.precision=c,f.rounding=d,e.times(2))},K.inverseTangent=K.atan=function(){var a,b,c,d,e,f,g,h,i,j=this,k=j.constructor,l=k.precision,m=k.rounding;if(j.isFinite()){if(j.isZero())return new k(j);else if(j.abs().eq(1)&&l+4<=J)return(g=V(k,l+4,m).times(.25)).s=j.s,g}else{if(!j.s)return new k(NaN);if(l+4<=J)return(g=V(k,l+4,m).times(.5)).s=j.s,g}for(k.precision=h=l+10,k.rounding=1,a=c=Math.min(28,h/G+2|0);a;--a)j=j.div(j.times(j).plus(1).sqrt().plus(1));for(t=!1,b=Math.ceil(h/G),d=1,i=j.times(j),g=new k(j),e=j;-1!==a;)if(e=e.times(i),f=g.minus(e.div(d+=2)),e=e.times(i),void 0!==(g=f.plus(e.div(d+=2))).d[b])for(a=b;g.d[a]===f.d[a]&&a--;);return c&&(g=g.times(2<<c-1)),t=!0,R(g,k.precision=l,k.rounding=m,!0)},K.isFinite=function(){return!!this.d},K.isInteger=K.isInt=function(){return!!this.d&&z(this.e/G)>this.d.length-2},K.isNaN=function(){return!this.s},K.isNegative=K.isNeg=function(){return this.s<0},K.isPositive=K.isPos=function(){return this.s>0},K.isZero=function(){return!!this.d&&0===this.d[0]},K.lessThan=K.lt=function(a){return 0>this.cmp(a)},K.lessThanOrEqualTo=K.lte=function(a){return 1>this.cmp(a)},K.logarithm=K.log=function(a){var b,c,d,e,f,g,h,i,j=this,k=j.constructor,l=k.precision,m=k.rounding,n=5;if(null==a)a=new k(10),b=!0;else{if(c=(a=new k(a)).d,a.s<0||!c||!c[0]||a.eq(1))return new k(NaN);b=a.eq(10)}if(c=j.d,j.s<0||!c||!c[0]||j.eq(1))return new k(c&&!c[0]?-1/0:1!=j.s?NaN:c?0:1/0);if(b)if(c.length>1)f=!0;else{for(e=c[0];e%10==0;)e/=10;f=1!==e}if(t=!1,N((i=Q(g=aa(j,h=l+n),d=b?U(k,h+10):aa(a,h),h,1)).d,e=l,m))do if(h+=10,i=Q(g=aa(j,h),d=b?U(k,h+10):aa(a,h),h,1),!f){+L(i.d).slice(e+1,e+15)+1==1e14&&(i=R(i,l+1,0));break}while(N(i.d,e+=10,m))return t=!0,R(i,l,m)},K.minus=K.sub=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this,o=n.constructor;if(a=new o(a),!n.d||!a.d)return n.s&&a.s?n.d?a.s=-a.s:a=new o(a.d||n.s!==a.s?n:NaN):a=new o(NaN),a;if(n.s!=a.s)return a.s=-a.s,n.plus(a);if(j=n.d,m=a.d,h=o.precision,i=o.rounding,!j[0]||!m[0]){if(m[0])a.s=-a.s;else{if(!j[0])return new o(3===i?-0:0);a=new o(n)}return t?R(a,h,i):a}if(c=z(a.e/G),k=z(n.e/G),j=j.slice(),f=k-c){for((l=f<0)?(b=j,f=-f,g=m.length):(b=m,c=k,g=j.length),f>(d=Math.max(Math.ceil(h/G),g)+2)&&(f=d,b.length=1),b.reverse(),d=f;d--;)b.push(0);b.reverse()}else{for((l=(d=j.length)<(g=m.length))&&(g=d),d=0;d<g;d++)if(j[d]!=m[d]){l=j[d]<m[d];break}f=0}for(l&&(b=j,j=m,m=b,a.s=-a.s),g=j.length,d=m.length-g;d>0;--d)j[g++]=0;for(d=m.length;d>f;){if(j[--d]<m[d]){for(e=d;e&&0===j[--e];)j[e]=F-1;--j[e],j[d]+=F}j[d]-=m[d]}for(;0===j[--g];)j.pop();for(;0===j[0];j.shift())--c;return j[0]?(a.d=j,a.e=T(j,c),t?R(a,h,i):a):new o(3===i?-0:0)},K.modulo=K.mod=function(a){var b,c=this,d=c.constructor;return(a=new d(a),c.d&&a.s&&(!a.d||a.d[0]))?a.d&&(!c.d||c.d[0])?(t=!1,9==d.modulo?(b=Q(c,a.abs(),0,3,1),b.s*=a.s):b=Q(c,a,0,d.modulo,1),b=b.times(a),t=!0,c.minus(b)):R(new d(c),d.precision,d.rounding):new d(NaN)},K.naturalExponential=K.exp=function(){return _(this)},K.naturalLogarithm=K.ln=function(){return aa(this)},K.negated=K.neg=function(){var a=new this.constructor(this);return a.s=-a.s,R(a)},K.plus=K.add=function(a){var b,c,d,e,f,g,h,i,j,k,l=this,m=l.constructor;if(a=new m(a),!l.d||!a.d)return l.s&&a.s?l.d||(a=new m(a.d||l.s===a.s?l:NaN)):a=new m(NaN),a;if(l.s!=a.s)return a.s=-a.s,l.minus(a);if(j=l.d,k=a.d,h=m.precision,i=m.rounding,!j[0]||!k[0])return k[0]||(a=new m(l)),t?R(a,h,i):a;if(f=z(l.e/G),d=z(a.e/G),j=j.slice(),e=f-d){for(e<0?(c=j,e=-e,g=k.length):(c=k,d=f,g=j.length),e>(g=(f=Math.ceil(h/G))>g?f+1:g+1)&&(e=g,c.length=1),c.reverse();e--;)c.push(0);c.reverse()}for((g=j.length)-(e=k.length)<0&&(e=g,c=k,k=j,j=c),b=0;e;)b=(j[--e]=j[e]+k[e]+b)/F|0,j[e]%=F;for(b&&(j.unshift(b),++d),g=j.length;0==j[--g];)j.pop();return a.d=j,a.e=T(j,d),t?R(a,h,i):a},K.precision=K.sd=function(a){var b,c=this;if(void 0!==a&&!!a!==a&&1!==a&&0!==a)throw Error(v+a);return c.d?(b=W(c.d),a&&c.e+1>b&&(b=c.e+1)):b=NaN,b},K.round=function(){var a=this,b=a.constructor;return R(new b(a),a.e+1,b.rounding)},K.sine=K.sin=function(){var a,b,c=this,d=c.constructor;return c.isFinite()?c.isZero()?new d(c):(a=d.precision,b=d.rounding,d.precision=a+Math.max(c.e,c.sd())+G,d.rounding=1,c=ae(d,ah(d,c)),d.precision=a,d.rounding=b,R(l>2?c.neg():c,a,b,!0)):new d(NaN)},K.squareRoot=K.sqrt=function(){var a,b,c,d,e,f,g=this,h=g.d,i=g.e,j=g.s,k=g.constructor;if(1!==j||!h||!h[0])return new k(!j||j<0&&(!h||h[0])?NaN:h?g:1/0);for(t=!1,0==(j=Math.sqrt(+g))||j==1/0?(((b=L(h)).length+i)%2==0&&(b+="0"),j=Math.sqrt(b),i=z((i+1)/2)-(i<0||i%2),d=new k(b=j==1/0?"5e"+i:(b=j.toExponential()).slice(0,b.indexOf("e")+1)+i)):d=new k(j.toString()),c=(i=k.precision)+3;;)if(d=(f=d).plus(Q(g,f,c+2,1)).times(.5),L(f.d).slice(0,c)===(b=L(d.d)).slice(0,c)){if("9999"!=(b=b.slice(c-3,c+1))&&(e||"4999"!=b)){+b&&(+b.slice(1)||"5"!=b.charAt(0))||(R(d,i+1,1),a=!d.times(d).eq(g));break}if(!e&&(R(f,i+1,0),f.times(f).eq(g))){d=f;break}c+=4,e=1}return t=!0,R(d,i,k.rounding,a)},K.tangent=K.tan=function(){var a,b,c=this,d=c.constructor;return c.isFinite()?c.isZero()?new d(c):(a=d.precision,b=d.rounding,d.precision=a+10,d.rounding=1,(c=c.sin()).s=1,c=Q(c,new d(1).minus(c.times(c)).sqrt(),a+10,0),d.precision=a,d.rounding=b,R(2==l||4==l?c.neg():c,a,b,!0)):new d(NaN)},K.times=K.mul=function(a){var b,c,d,e,f,g,h,i,j,k=this,l=k.constructor,m=k.d,n=(a=new l(a)).d;if(a.s*=k.s,!m||!m[0]||!n||!n[0])return new l(!a.s||m&&!m[0]&&!n||n&&!n[0]&&!m?NaN:!m||!n?a.s/0:0*a.s);for(c=z(k.e/G)+z(a.e/G),(i=m.length)<(j=n.length)&&(f=m,m=n,n=f,g=i,i=j,j=g),f=[],d=g=i+j;d--;)f.push(0);for(d=j;--d>=0;){for(b=0,e=i+d;e>d;)h=f[e]+n[d]*m[e-d-1]+b,f[e--]=h%F|0,b=h/F|0;f[e]=(f[e]+b)%F|0}for(;!f[--g];)f.pop();return b?++c:f.shift(),a.d=f,a.e=T(f,c),t?R(a,l.precision,l.rounding):a},K.toBinary=function(a,b){return ai(this,2,a,b)},K.toDecimalPlaces=K.toDP=function(a,b){var c=this,d=c.constructor;return(c=new d(c),void 0===a)?c:(M(a,0,o),void 0===b?b=d.rounding:M(b,0,8),R(c,a+c.e+1,b))},K.toExponential=function(a,b){var c,d=this,e=d.constructor;return void 0===a?c=S(d,!0):(M(a,0,o),void 0===b?b=e.rounding:M(b,0,8),c=S(d=R(new e(d),a+1,b),!0,a+1)),d.isNeg()&&!d.isZero()?"-"+c:c},K.toFixed=function(a,b){var c,d,e=this,f=e.constructor;return void 0===a?c=S(e):(M(a,0,o),void 0===b?b=f.rounding:M(b,0,8),c=S(d=R(new f(e),a+e.e+1,b),!1,a+d.e+1)),e.isNeg()&&!e.isZero()?"-"+c:c},K.toFraction=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this,o=n.d,p=n.constructor;if(!o)return new p(n);if(j=c=new p(1),d=i=new p(0),g=(f=(b=new p(d)).e=W(o)-n.e-1)%G,b.d[0]=A(10,g<0?G+g:g),null==a)a=f>0?b:j;else{if(!(h=new p(a)).isInt()||h.lt(j))throw Error(v+h);a=h.gt(b)?f>0?b:j:h}for(t=!1,h=new p(L(o)),k=p.precision,p.precision=f=o.length*G*2;l=Q(h,b,0,1,1),1!=(e=c.plus(l.times(d))).cmp(a);)c=d,d=e,e=j,j=i.plus(l.times(e)),i=e,e=b,b=h.minus(l.times(e)),h=e;return e=Q(a.minus(c),d,0,1,1),i=i.plus(e.times(j)),c=c.plus(e.times(d)),i.s=j.s=n.s,m=1>Q(j,d,f,1).minus(n).abs().cmp(Q(i,c,f,1).minus(n).abs())?[j,d]:[i,c],p.precision=k,t=!0,m},K.toHexadecimal=K.toHex=function(a,b){return ai(this,16,a,b)},K.toNearest=function(a,b){var c=this,d=c.constructor;if(c=new d(c),null==a){if(!c.d)return c;a=new d(1),b=d.rounding}else{if(a=new d(a),void 0===b?b=d.rounding:M(b,0,8),!c.d)return a.s?c:a;if(!a.d)return a.s&&(a.s=c.s),a}return a.d[0]?(t=!1,c=Q(c,a,0,b,1).times(a),t=!0,R(c)):(a.s=c.s,c=a),c},K.toNumber=function(){return+this},K.toOctal=function(a,b){return ai(this,8,a,b)},K.toPower=K.pow=function(a){var b,c,d,e,f,g,h=this,i=h.constructor,j=+(a=new i(a));if(!h.d||!a.d||!h.d[0]||!a.d[0])return new i(A(+h,j));if((h=new i(h)).eq(1))return h;if(d=i.precision,f=i.rounding,a.eq(1))return R(h,d,f);if((b=z(a.e/G))>=a.d.length-1&&(c=j<0?-j:j)<=H)return e=Y(i,h,c,d),a.s<0?new i(1).div(e):R(e,d,f);if((g=h.s)<0){if(b<a.d.length-1)return new i(NaN);if((1&a.d[b])==0&&(g=1),0==h.e&&1==h.d[0]&&1==h.d.length)return h.s=g,h}return(b=0!=(c=A(+h,j))&&isFinite(c)?new i(c+"").e:z(j*(Math.log("0."+L(h.d))/Math.LN10+h.e+1)))>i.maxE+1||b<i.minE-1?new i(b>0?g/0:0):(t=!1,i.rounding=h.s=1,c=Math.min(12,(b+"").length),(e=_(a.times(aa(h,d+c)),d)).d&&N((e=R(e,d+5,1)).d,d,f)&&(b=d+10,+L((e=R(_(a.times(aa(h,b+c)),b),b+5,1)).d).slice(d+1,d+15)+1==1e14&&(e=R(e,d+1,0))),e.s=g,t=!0,i.rounding=f,R(e,d,f))},K.toPrecision=function(a,b){var c,d=this,e=d.constructor;return void 0===a?c=S(d,d.e<=e.toExpNeg||d.e>=e.toExpPos):(M(a,1,o),void 0===b?b=e.rounding:M(b,0,8),c=S(d=R(new e(d),a,b),a<=d.e||d.e<=e.toExpNeg,a)),d.isNeg()&&!d.isZero()?"-"+c:c},K.toSignificantDigits=K.toSD=function(a,b){var c=this,d=c.constructor;return void 0===a?(a=d.precision,b=d.rounding):(M(a,1,o),void 0===b?b=d.rounding:M(b,0,8)),R(new d(c),a,b)},K.toString=function(){var a=this,b=a.constructor,c=S(a,a.e<=b.toExpNeg||a.e>=b.toExpPos);return a.isNeg()&&!a.isZero()?"-"+c:c},K.truncated=K.trunc=function(){return R(new this.constructor(this),this.e+1,1)},K.valueOf=K.toJSON=function(){var a=this,b=a.constructor,c=S(a,a.e<=b.toExpNeg||a.e>=b.toExpPos);return a.isNeg()?"-"+c:c};var Q=function(){function a(a,b,c){var d,e=0,f=a.length;for(a=a.slice();f--;)d=a[f]*b+e,a[f]=d%c|0,e=d/c|0;return e&&a.unshift(e),a}function b(a,b,c,d){var e,f;if(c!=d)f=c>d?1:-1;else for(e=f=0;e<c;e++)if(a[e]!=b[e]){f=a[e]>b[e]?1:-1;break}return f}function c(a,b,c,d){for(var e=0;c--;)a[c]-=e,e=+(a[c]<b[c]),a[c]=e*d+a[c]-b[c];for(;!a[0]&&a.length>1;)a.shift()}return function(d,e,f,g,h,i){var j,l,m,n,o,p,q,r,s,t,u,v,w,x,y,A,B,C,D,E,H=d.constructor,I=d.s==e.s?1:-1,J=d.d,K=e.d;if(!J||!J[0]||!K||!K[0])return new H(!d.s||!e.s||(J?K&&J[0]==K[0]:!K)?NaN:J&&0==J[0]||!K?0*I:I/0);for(i?(o=1,l=d.e-e.e):(i=F,o=G,l=z(d.e/o)-z(e.e/o)),D=K.length,B=J.length,t=(s=new H(I)).d=[],m=0;K[m]==(J[m]||0);m++);if(K[m]>(J[m]||0)&&l--,null==f?(x=f=H.precision,g=H.rounding):x=h?f+(d.e-e.e)+1:f,x<0)t.push(1),p=!0;else{if(x=x/o+2|0,m=0,1==D){for(n=0,K=K[0],x++;(m<B||n)&&x--;m++)y=n*i+(J[m]||0),t[m]=y/K|0,n=y%K|0;p=n||m<B}else{for((n=i/(K[0]+1)|0)>1&&(K=a(K,n,i),J=a(J,n,i),D=K.length,B=J.length),A=D,v=(u=J.slice(0,D)).length;v<D;)u[v++]=0;(E=K.slice()).unshift(0),C=K[0],K[1]>=i/2&&++C;do n=0,(j=b(K,u,D,v))<0?(w=u[0],D!=v&&(w=w*i+(u[1]||0)),(n=w/C|0)>1?(n>=i&&(n=i-1),r=(q=a(K,n,i)).length,v=u.length,1==(j=b(q,u,r,v))&&(n--,c(q,D<r?E:K,r,i))):(0==n&&(j=n=1),q=K.slice()),(r=q.length)<v&&q.unshift(0),c(u,q,v,i),-1==j&&(v=u.length,(j=b(K,u,D,v))<1&&(n++,c(u,D<v?E:K,v,i))),v=u.length):0===j&&(n++,u=[0]),t[m++]=n,j&&u[0]?u[v++]=J[A]||0:(u=[J[A]],v=1);while((A++<B||void 0!==u[0])&&x--)p=void 0!==u[0]}t[0]||t.shift()}if(1==o)s.e=l,k=p;else{for(m=1,n=t[0];n>=10;n/=10)m++;s.e=m+l*o-1,R(s,h?f+s.e+1:f,g,p)}return s}}();function R(a,b,c,d){var e,f,g,h,i,j,k,l,m,n=a.constructor;a:if(null!=b){if(!(l=a.d))return a;for(e=1,h=l[0];h>=10;h/=10)e++;if((f=b-e)<0)f+=G,g=b,i=(k=l[m=0])/A(10,e-g-1)%10|0;else if((m=Math.ceil((f+1)/G))>=(h=l.length))if(d){for(;h++<=m;)l.push(0);k=i=0,e=1,f%=G,g=f-G+1}else break a;else{for(e=1,k=h=l[m];h>=10;h/=10)e++;f%=G,i=(g=f-G+e)<0?0:k/A(10,e-g-1)%10|0}if(d=d||b<0||void 0!==l[m+1]||(g<0?k:k%A(10,e-g-1)),j=c<4?(i||d)&&(0==c||c==(a.s<0?3:2)):i>5||5==i&&(4==c||d||6==c&&(f>0?g>0?k/A(10,e-g):0:l[m-1])%10&1||c==(a.s<0?8:7)),b<1||!l[0])return l.length=0,j?(b-=a.e+1,l[0]=A(10,(G-b%G)%G),a.e=-b||0):l[0]=a.e=0,a;if(0==f?(l.length=m,h=1,m--):(l.length=m+1,h=A(10,G-f),l[m]=g>0?(k/A(10,e-g)%A(10,g)|0)*h:0),j)for(;;)if(0==m){for(f=1,g=l[0];g>=10;g/=10)f++;for(g=l[0]+=h,h=1;g>=10;g/=10)h++;f!=h&&(a.e++,l[0]==F&&(l[0]=1));break}else{if(l[m]+=h,l[m]!=F)break;l[m--]=0,h=1}for(f=l.length;0===l[--f];)l.pop()}return t&&(a.e>n.maxE?(a.d=null,a.e=NaN):a.e<n.minE&&(a.e=0,a.d=[0])),a}function S(a,b,c){if(!a.isFinite())return ab(a);var d,e=a.e,f=L(a.d),g=f.length;return b?(c&&(d=c-g)>0?f=f.charAt(0)+"."+f.slice(1)+X(d):g>1&&(f=f.charAt(0)+"."+f.slice(1)),f=f+(a.e<0?"e":"e+")+a.e):e<0?(f="0."+X(-e-1)+f,c&&(d=c-g)>0&&(f+=X(d))):e>=g?(f+=X(e+1-g),c&&(d=c-e-1)>0&&(f=f+"."+X(d))):((d=e+1)<g&&(f=f.slice(0,d)+"."+f.slice(d)),c&&(d=c-g)>0&&(e+1===g&&(f+="."),f+=X(d))),f}function T(a,b){var c=a[0];for(b*=G;c>=10;c/=10)b++;return b}function U(a,b,c){if(b>I)throw t=!0,c&&(a.precision=c),Error(w);return R(new a(q),b,1,!0)}function V(a,b,c){if(b>J)throw Error(w);return R(new a(r),b,c,!0)}function W(a){var b=a.length-1,c=b*G+1;if(b=a[b]){for(;b%10==0;b/=10)c--;for(b=a[0];b>=10;b/=10)c++}return c}function X(a){for(var b="";a--;)b+="0";return b}function Y(a,b,c,d){var e,f=new a(1),g=Math.ceil(d/G+4);for(t=!1;;){if(c%2&&aj((f=f.times(b)).d,g)&&(e=!0),0===(c=z(c/2))){c=f.d.length-1,e&&0===f.d[c]&&++f.d[c];break}aj((b=b.times(b)).d,g)}return t=!0,f}function Z(a){return 1&a.d[a.d.length-1]}function $(a,b,c){for(var d,e,f=new a(b[0]),g=0;++g<b.length;){if(!(e=new a(b[g])).s){f=e;break}((d=f.cmp(e))===c||0===d&&f.s===c)&&(f=e)}return f}function _(a,b){var c,d,e,f,g,h,i,j=0,k=0,l=0,m=a.constructor,n=m.rounding,o=m.precision;if(!a.d||!a.d[0]||a.e>17)return new m(a.d?!a.d[0]?1:a.s<0?0:1/0:a.s?a.s<0?0:a:0/0);for(null==b?(t=!1,i=o):i=b,h=new m(.03125);a.e>-2;)a=a.times(h),l+=5;for(i+=d=Math.log(A(2,l))/Math.LN10*2+5|0,c=f=g=new m(1),m.precision=i;;){if(f=R(f.times(a),i,1),c=c.times(++k),L((h=g.plus(Q(f,c,i,1))).d).slice(0,i)===L(g.d).slice(0,i)){for(e=l;e--;)g=R(g.times(g),i,1);if(null!=b)return m.precision=o,g;if(!(j<3&&N(g.d,i-d,n,j)))return R(g,m.precision=o,n,t=!0);m.precision=i+=10,c=f=h=new m(1),k=0,j++}g=h}}function aa(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=1,o=10,p=a,q=p.d,r=p.constructor,s=r.rounding,u=r.precision;if(p.s<0||!q||!q[0]||!p.e&&1==q[0]&&1==q.length)return new r(q&&!q[0]?-1/0:1!=p.s?NaN:q?0:p);if(null==b?(t=!1,k=u):k=b,r.precision=k+=o,d=(c=L(q)).charAt(0),!(15e14>Math.abs(f=p.e)))return j=U(r,k+2,u).times(f+""),p=aa(new r(d+"."+c.slice(1)),k-o).plus(j),r.precision=u,null==b?R(p,u,s,t=!0):p;for(;d<7&&1!=d||1==d&&c.charAt(1)>3;)d=(c=L((p=p.times(a)).d)).charAt(0),n++;for(f=p.e,d>1?(p=new r("0."+c),f++):p=new r(d+"."+c.slice(1)),l=p,i=g=p=Q(p.minus(1),p.plus(1),k,1),m=R(p.times(p),k,1),e=3;;){if(g=R(g.times(m),k,1),L((j=i.plus(Q(g,new r(e),k,1))).d).slice(0,k)===L(i.d).slice(0,k)){if(i=i.times(2),0!==f&&(i=i.plus(U(r,k+2,u).times(f+""))),i=Q(i,new r(n),k,1),null!=b)return r.precision=u,i;if(!N(i.d,k-o,s,h))return R(i,r.precision=u,s,t=!0);r.precision=k+=o,j=g=p=Q(l.minus(1),l.plus(1),k,1),m=R(p.times(p),k,1),e=h=1}i=j,e+=2}}function ab(a){return String(a.s*a.s/0)}function ac(a,b){var c,d,e;for((c=b.indexOf("."))>-1&&(b=b.replace(".","")),(d=b.search(/e/i))>0?(c<0&&(c=d),c+=+b.slice(d+1),b=b.substring(0,d)):c<0&&(c=b.length),d=0;48===b.charCodeAt(d);d++);for(e=b.length;48===b.charCodeAt(e-1);--e);if(b=b.slice(d,e)){if(e-=d,a.e=c=c-d-1,a.d=[],d=(c+1)%G,c<0&&(d+=G),d<e){for(d&&a.d.push(+b.slice(0,d)),e-=G;d<e;)a.d.push(+b.slice(d,d+=G));d=G-(b=b.slice(d)).length}else d-=e;for(;d--;)b+="0";a.d.push(+b),t&&(a.e>a.constructor.maxE?(a.d=null,a.e=NaN):a.e<a.constructor.minE&&(a.e=0,a.d=[0]))}else a.e=0,a.d=[0];return a}function ad(a,b){var c,d,e,f,g,h,i,j,k;if(b.indexOf("_")>-1){if(b=b.replace(/(\d)_(?=\d)/g,"$1"),E.test(b))return ac(a,b)}else if("Infinity"===b||"NaN"===b)return+b||(a.s=NaN),a.e=NaN,a.d=null,a;if(C.test(b))c=16,b=b.toLowerCase();else if(B.test(b))c=2;else if(D.test(b))c=8;else throw Error(v+b);for((f=b.search(/p/i))>0?(i=+b.slice(f+1),b=b.substring(2,f)):b=b.slice(2),g=(f=b.indexOf("."))>=0,d=a.constructor,g&&(f=(h=(b=b.replace(".","")).length)-f,e=Y(d,new d(c),f,2*f)),f=k=(j=O(b,c,F)).length-1;0===j[f];--f)j.pop();return f<0?new d(0*a.s):(a.e=T(j,k),a.d=j,t=!1,g&&(a=Q(a,e,4*h)),i&&(a=a.times(54>Math.abs(i)?A(2,i):aZ.pow(2,i))),t=!0,a)}function ae(a,b){var c,d=b.d.length;if(d<3)return b.isZero()?b:af(a,2,b,b);c=(c=1.4*Math.sqrt(d))>16?16:0|c,b=af(a,2,b=b.times(1/ag(5,c)),b);for(var e,f=new a(5),g=new a(16),h=new a(20);c--;)e=b.times(b),b=b.times(f.plus(e.times(g.times(e).minus(h))));return b}function af(a,b,c,d,e){var f,g,h,i,j=a.precision,k=Math.ceil(j/G);for(t=!1,i=c.times(c),h=new a(d);;){if(g=Q(h.times(i),new a(b++*b++),j,1),h=e?d.plus(g):d.minus(g),d=Q(g.times(i),new a(b++*b++),j,1),void 0!==(g=h.plus(d)).d[k]){for(f=k;g.d[f]===h.d[f]&&f--;);if(-1==f)break}f=h,h=d,d=g,g=f}return t=!0,g.d.length=k+1,g}function ag(a,b){for(var c=a;--b;)c*=a;return c}function ah(a,b){var c,d=b.s<0,e=V(a,a.precision,1),f=e.times(.5);if((b=b.abs()).lte(f))return l=d?4:1,b;if((c=b.divToInt(e)).isZero())l=d?3:2;else{if((b=b.minus(c.times(e))).lte(f))return l=Z(c)?d?2:3:d?4:1,b;l=Z(c)?d?1:4:d?3:2}return b.minus(e).abs()}function ai(a,b,c,d){var e,f,g,h,i,j,l,m,n,q=a.constructor,r=void 0!==c;if(r?(M(c,1,o),void 0===d?d=q.rounding:M(d,0,8)):(c=q.precision,d=q.rounding),a.isFinite()){for(g=(l=S(a)).indexOf("."),r?(e=2,16==b?c=4*c-3:8==b&&(c=3*c-2)):e=b,g>=0&&(l=l.replace(".",""),(n=new q(1)).e=l.length-g,n.d=O(S(n),10,e),n.e=n.d.length),f=i=(m=O(l,10,e)).length;0==m[--i];)m.pop();if(m[0]){if(g<0?f--:((a=new q(a)).d=m,a.e=f,m=(a=Q(a,n,c,d,0,e)).d,f=a.e,j=k),g=m[c],h=e/2,j=j||void 0!==m[c+1],j=d<4?(void 0!==g||j)&&(0===d||d===(a.s<0?3:2)):g>h||g===h&&(4===d||j||6===d&&1&m[c-1]||d===(a.s<0?8:7)),m.length=c,j)for(;++m[--c]>e-1;)m[c]=0,c||(++f,m.unshift(1));for(i=m.length;!m[i-1];--i);for(g=0,l="";g<i;g++)l+=p.charAt(m[g]);if(r){if(i>1)if(16==b||8==b){for(g=16==b?4:3,--i;i%g;i++)l+="0";for(i=(m=O(l,e,b)).length;!m[i-1];--i);for(g=1,l="1.";g<i;g++)l+=p.charAt(m[g])}else l=l.charAt(0)+"."+l.slice(1);l=l+(f<0?"p":"p+")+f}else if(f<0){for(;++f;)l="0"+l;l="0."+l}else if(++f>i)for(f-=i;f--;)l+="0";else f<i&&(l=l.slice(0,f)+"."+l.slice(f))}else l=r?"0p+0":"0";l=(16==b?"0x":2==b?"0b":8==b?"0o":"")+l}else l=ab(a);return a.s<0?"-"+l:l}function aj(a,b){if(a.length>b)return a.length=b,!0}function ak(a){return new this(a).abs()}function al(a){return new this(a).acos()}function am(a){return new this(a).acosh()}function an(a,b){return new this(a).plus(b)}function ao(a){return new this(a).asin()}function ap(a){return new this(a).asinh()}function aq(a){return new this(a).atan()}function ar(a){return new this(a).atanh()}function as(a,b){a=new this(a),b=new this(b);var c,d=this.precision,e=this.rounding,f=d+4;return a.s&&b.s?a.d||b.d?!b.d||a.isZero()?(c=b.s<0?V(this,d,e):new this(0)).s=a.s:!a.d||b.isZero()?(c=V(this,f,1).times(.5)).s=a.s:b.s<0?(this.precision=f,this.rounding=1,c=this.atan(Q(a,b,f,1)),b=V(this,f,1),this.precision=d,this.rounding=e,c=a.s<0?c.minus(b):c.plus(b)):c=this.atan(Q(a,b,f,1)):(c=V(this,f,1).times(b.s>0?.25:.75)).s=a.s:c=new this(NaN),c}function at(a){return new this(a).cbrt()}function au(a){return R(a=new this(a),a.e+1,2)}function av(a,b,c){return new this(a).clamp(b,c)}function aw(a){if(!a||"object"!=typeof a)throw Error(u+"Object expected");var b,c,d,e=!0===a.defaults,f=["precision",1,o,"rounding",0,8,"toExpNeg",-n,0,"toExpPos",0,n,"maxE",0,n,"minE",-n,0,"modulo",0,9];for(b=0;b<f.length;b+=3)if(c=f[b],e&&(this[c]=s[c]),void 0!==(d=a[c]))if(z(d)===d&&d>=f[b+1]&&d<=f[b+2])this[c]=d;else throw Error(v+c+": "+d);if(c="crypto",e&&(this[c]=s[c]),void 0!==(d=a[c]))if(!0===d||!1===d||0===d||1===d)if(d)if("u">typeof crypto&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[c]=!0;else throw Error(x);else this[c]=!1;else throw Error(v+c+": "+d);return this}function ax(a){return new this(a).cos()}function ay(a){return new this(a).cosh()}function az(a){var b,c,d;function e(a){var b,c,d,f=this;if(!(f instanceof e))return new e(a);if(f.constructor=e,aE(a)){f.s=a.s,t?!a.d||a.e>e.maxE?(f.e=NaN,f.d=null):a.e<e.minE?(f.e=0,f.d=[0]):(f.e=a.e,f.d=a.d.slice()):(f.e=a.e,f.d=a.d?a.d.slice():a.d);return}if("number"==(d=typeof a)){if(0===a){f.s=1/a<0?-1:1,f.e=0,f.d=[0];return}if(a<0?(a=-a,f.s=-1):f.s=1,a===~~a&&a<1e7){for(b=0,c=a;c>=10;c/=10)b++;t?b>e.maxE?(f.e=NaN,f.d=null):b<e.minE?(f.e=0,f.d=[0]):(f.e=b,f.d=[a]):(f.e=b,f.d=[a]);return}if(0*a!=0){a||(f.s=NaN),f.e=NaN,f.d=null;return}return ac(f,a.toString())}if("string"===d)return 45===(c=a.charCodeAt(0))?(a=a.slice(1),f.s=-1):(43===c&&(a=a.slice(1)),f.s=1),E.test(a)?ac(f,a):ad(f,a);if("bigint"===d)return a<0?(a=-a,f.s=-1):f.s=1,ac(f,a.toString());throw Error(v+a)}if(e.prototype=K,e.ROUND_UP=0,e.ROUND_DOWN=1,e.ROUND_CEIL=2,e.ROUND_FLOOR=3,e.ROUND_HALF_UP=4,e.ROUND_HALF_DOWN=5,e.ROUND_HALF_EVEN=6,e.ROUND_HALF_CEIL=7,e.ROUND_HALF_FLOOR=8,e.EUCLID=9,e.config=e.set=aw,e.clone=az,e.isDecimal=aE,e.abs=ak,e.acos=al,e.acosh=am,e.add=an,e.asin=ao,e.asinh=ap,e.atan=aq,e.atanh=ar,e.atan2=as,e.cbrt=at,e.ceil=au,e.clamp=av,e.cos=ax,e.cosh=ay,e.div=aA,e.exp=aB,e.floor=aC,e.hypot=aD,e.ln=aF,e.log=aG,e.log10=aI,e.log2=aH,e.max=aJ,e.min=aK,e.mod=aL,e.mul=aM,e.pow=aN,e.random=aO,e.round=aP,e.sign=aQ,e.sin=aR,e.sinh=aS,e.sqrt=aT,e.sub=aU,e.sum=aV,e.tan=aW,e.tanh=aX,e.trunc=aY,void 0===a&&(a={}),a&&!0!==a.defaults)for(b=0,d=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"];b<d.length;)a.hasOwnProperty(c=d[b++])||(a[c]=this[c]);return e.config(a),e}function aA(a,b){return new this(a).div(b)}function aB(a){return new this(a).exp()}function aC(a){return R(a=new this(a),a.e+1,3)}function aD(){var a,b,c=new this(0);for(a=0,t=!1;a<arguments.length;)if(b=new this(arguments[a++]),b.d)c.d&&(c=c.plus(b.times(b)));else{if(b.s)return t=!0,new this(1/0);c=b}return t=!0,c.sqrt()}function aE(a){return a instanceof aZ||a&&a.toStringTag===y||!1}function aF(a){return new this(a).ln()}function aG(a,b){return new this(a).log(b)}function aH(a){return new this(a).log(2)}function aI(a){return new this(a).log(10)}function aJ(){return $(this,arguments,-1)}function aK(){return $(this,arguments,1)}function aL(a,b){return new this(a).mod(b)}function aM(a,b){return new this(a).mul(b)}function aN(a,b){return new this(a).pow(b)}function aO(a){var b,c,d,e,f=0,g=new this(1),h=[];if(void 0===a?a=this.precision:M(a,1,o),d=Math.ceil(a/G),this.crypto)if(crypto.getRandomValues)for(b=crypto.getRandomValues(new Uint32Array(d));f<d;)(e=b[f])>=429e7?b[f]=crypto.getRandomValues(new Uint32Array(1))[0]:h[f++]=e%1e7;else if(crypto.randomBytes){for(b=crypto.randomBytes(d*=4);f<d;)(e=b[f]+(b[f+1]<<8)+(b[f+2]<<16)+((127&b[f+3])<<24))>=214e7?crypto.randomBytes(4).copy(b,f):(h.push(e%1e7),f+=4);f=d/4}else throw Error(x);else for(;f<d;)h[f++]=1e7*Math.random()|0;for(d=h[--f],a%=G,d&&a&&(e=A(10,G-a),h[f]=(d/e|0)*e);0===h[f];f--)h.pop();if(f<0)c=0,h=[0];else{for(c=-1;0===h[0];c-=G)h.shift();for(d=1,e=h[0];e>=10;e/=10)d++;d<G&&(c-=G-d)}return g.e=c,g.d=h,g}function aP(a){return R(a=new this(a),a.e+1,this.rounding)}function aQ(a){return(a=new this(a)).d?a.d[0]?a.s:0*a.s:a.s||NaN}function aR(a){return new this(a).sin()}function aS(a){return new this(a).sinh()}function aT(a){return new this(a).sqrt()}function aU(a,b){return new this(a).sub(b)}function aV(){var a=0,b=arguments,c=new this(b[0]);for(t=!1;c.s&&++a<b.length;)c=c.plus(b[a]);return t=!0,R(c,this.precision,this.rounding)}function aW(a){return new this(a).tan()}function aX(a){return new this(a).tanh()}function aY(a){return R(a=new this(a),a.e+1,1)}K[Symbol.for("nodejs.util.inspect.custom")]=K.toString,K[Symbol.toStringTag]="Decimal";var aZ=K.constructor=az(s);q=new aZ(q),r=new aZ(r);let a$=aZ;a.s(["Decimal",()=>aZ,"default",0,a$],978561);var a_=a.i(713095);let a0=async()=>{let a=await (0,d.auth)();if(!a?.user?.id)return null;let b=await c.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},a1=a=>{let b=a.reduce((a,b)=>a+(b.debitAmount||0),0),c=a.reduce((a,b)=>a+(b.creditAmount||0),0);return Math.abs(b-c)>.01?{valid:!1,message:"Debits and credits must balance"}:0===b&&0===c?{valid:!1,message:"Journal entry must have at least one debit and one credit"}:{valid:!0}},a2=async(a,b,c,d,e)=>{for(let f of c){let c=await a.accountBalance.findFirst({where:{accountId:f.accountId,financialPeriodId:b}});if(c){let b=new aZ(c.debitAmount).plus(f.debitAmount).toNumber(),e=new aZ(c.creditAmount).plus(f.creditAmount).toNumber(),g=new aZ(c.openingBalance).plus(b).minus(e).toNumber();await a.accountBalance.update({where:{id:c.id},data:{debitAmount:b,creditAmount:e,endingBalance:g,updatedBy:d}})}else{let c=new aZ(f.debitAmount).minus(f.creditAmount).toNumber();await a.accountBalance.create({data:{accountId:f.accountId,financialPeriodId:b,agencyId:e.subAccountId?null:e.agencyId,subAccountId:e.subAccountId||null,openingBalance:0,debitAmount:f.debitAmount,creditAmount:f.creditAmount,endingBalance:c,currency:f.currency,createdBy:d,updatedBy:d}})}}},a3=async a=>{try{let b=await a0();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.general_ledger.journal_entries.read"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.general_ledger.journal_entries.read")))return{success:!1,error:"Unauthorized: Missing permission to view journal entries"};let d=await c.db.journalEntry.findUnique({where:{id:a},include:{Lines:{include:{Account:{select:{id:!0,code:!0,name:!0,accountType:!0}}},orderBy:{lineNumber:"asc"}},Period:{select:{id:!0,name:!0,fiscalYear:!0,fiscalPeriod:!0,status:!0}}}});if(!d)return{success:!1,error:"Journal entry not found"};if(!(b.subAccountId?d.subAccountId===b.subAccountId:d.agencyId===b.agencyId&&!d.subAccountId))return{success:!1,error:"Journal entry does not belong to current context"};return{success:!0,data:d}}catch(a){return console.error("Error in getJournalEntry:",a),{success:!1,error:"Failed to get journal entry"}}},a4=async a=>{try{let b=await a0();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.general_ledger.journal_entries.read"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.general_ledger.journal_entries.read")))return{success:!1,error:"Unauthorized: Missing permission to view journal entries"};let d=b.subAccountId?{subAccountId:b.subAccountId}:{agencyId:b.agencyId,subAccountId:null};a?.status&&a.status.length>0&&(d.status={in:a.status}),(a?.startDate||a?.endDate)&&(d.entryDate={},a.startDate&&(d.entryDate.gte=a.startDate),a.endDate&&(d.entryDate.lte=a.endDate));let e=await c.db.journalEntry.findMany({where:d,orderBy:[{entryDate:"desc"},{entryNumber:"desc"}],include:{Lines:{include:{Account:{select:{id:!0,code:!0,name:!0}}}},Period:{select:{id:!0,name:!0,fiscalYear:!0,fiscalPeriod:!0}}},take:100});return{success:!0,data:e}}catch(a){return console.error("Error in listJournalEntries:",a),{success:!1,error:"Failed to list journal entries"}}},a5=async()=>{try{let a=await a0();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!(a.subAccountId?await (0,f.hasSubAccountPermission)(a.subAccountId,"fi.general_ledger.journal_entries.approve"):await (0,f.hasAgencyPermission)(a.agencyId,"fi.general_ledger.journal_entries.approve")))return{success:!1,error:"Unauthorized: Missing approval permission"};let b=a.subAccountId?{subAccountId:a.subAccountId}:{agencyId:a.agencyId,subAccountId:null};b.status=m.JournalEntryStatus.PENDING_APPROVAL;let d=await c.db.journalEntry.findMany({where:b,orderBy:{submittedAt:"asc"},include:{Lines:{include:{Account:{select:{id:!0,code:!0,name:!0}}}},Period:{select:{name:!0}}},take:50}),e=await Promise.all(d.map(async a=>{let b=a.submittedBy?await c.db.user.findUnique({where:{id:a.submittedBy},select:{name:!0,email:!0}}):null;return{...a,submitter:b}}));return{success:!0,data:{journalEntries:e,counts:{journalEntries:d.length}}}}catch(a){return console.error("Error in getPendingApprovals:",a),{success:!1,error:"Failed to get pending approvals"}}},a6=async a=>{try{let b=await a0();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.general_ledger.journal_entries.create"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.general_ledger.journal_entries.create")))return{success:!1,error:"Unauthorized: Missing permission to create journal entries"};let d=g.createJournalEntrySchema.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0].message};let k=a1(d.data.lines);if(!k.valid)return{success:!1,error:k.message};let l=await c.db.financialPeriod.findUnique({where:{id:d.data.periodId}});if(!l)return{success:!1,error:"Financial period not found"};if(l.status===m.PeriodStatus.FUTURE)return{success:!1,error:"Cannot create entries in future periods"};let n=await c.db.journalEntry.findFirst({where:b.subAccountId?{subAccountId:b.subAccountId}:{agencyId:b.agencyId,subAccountId:null},orderBy:{entryNumber:"desc"},select:{entryNumber:!0}}),o=n?n.entryNumber+1:1,p=await c.db.$transaction(async a=>{let c=await a.journalEntry.create({data:{entryNumber:`${o}`.padStart(6,"0"),entryDate:d.data.entryDate,description:d.data.description,reference:d.data.sourceReference,status:m.JournalEntryStatus.DRAFT,entryType:d.data.entryType,periodId:d.data.periodId,agencyId:b.subAccountId?null:b.agencyId,subAccountId:b.subAccountId||null,createdBy:b.userId,updatedBy:b.userId},include:{Lines:!0}});for(let b of d.data.lines)await a.journalEntryLine.create({data:{lineNumber:b.lineNumber,journalEntryId:c.id,accountId:b.accountId,description:b.description||c.description,debitAmount:b.debitAmount||0,creditAmount:b.creditAmount||0,taxCode:b.taxCode||null,taxAmount:b.taxAmount||0,debitAmountBase:(b.debitAmount||0)*(b.exchangeRate||1),creditAmountBase:(b.creditAmount||0)*(b.exchangeRate||1),createdAt:new Date}});return a.journalEntry.findUnique({where:{id:c.id},include:{Lines:{include:{Account:!0}}}})});await (0,h.logGLAudit)({action:"CREATE",entityType:"JournalEntry",entityId:p.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Journal entry ${p.entryNumber} created`}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.drafted,{type:"JournalEntry",id:p.id},{amount:d.data.lines.reduce((a,b)=>a+(b.debitAmount||0),0),reference:p.entryNumber,description:p.description||"Journal entry drafted"});let q=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/journal-entries`:`/agency/${b.agencyId}/fi/general-ledger/journal-entries`;return(0,e.revalidatePath)(q),{success:!0,data:p}}catch(a){return console.error("Error in createJournalEntry:",a),{success:!1,error:"Failed to create journal entry"}}},a7=async a=>{try{let b=await a0();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.general_ledger.journal_entries.update"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.general_ledger.journal_entries.update")))return{success:!1,error:"Unauthorized: Missing permission to edit journal entries"};let d=g.updateJournalEntrySchema.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0].message};let i=await c.db.journalEntry.findUnique({where:{id:d.data.id},include:{Lines:!0}});if(!i)return{success:!1,error:"Journal entry not found"};if(i.status!==m.JournalEntryStatus.DRAFT)return{success:!1,error:"Can only edit draft journal entries"};if(d.data.lines){let a=a1(d.data.lines);if(!a.valid)return{success:!1,error:a.message}}let j=await c.db.$transaction(async a=>{let{id:c,lines:e,...f}=d.data,g=await a.journalEntry.update({where:{id:c},data:{...f,updatedBy:b.userId}});if(e)for(let b of(await a.journalEntryLine.deleteMany({where:{journalEntryId:c}}),e))await a.journalEntryLine.create({data:{journalEntryId:c,accountId:b.accountId,description:b.description||g.description,debitAmount:b.debitAmount||0,creditAmount:b.creditAmount||0,taxCode:b.taxCode||null,taxAmount:b.taxAmount||0,exchangeRate:b.exchangeRate||1,creditAmountBase:(b.creditAmount||0)*(b.exchangeRate||1),debitAmountBase:(b.debitAmount||0)*(b.exchangeRate||1),lineNumber:b.lineNumber,createdAt:new Date}});return a.journalEntry.findUnique({where:{id:c},include:{Lines:{include:{Account:!0}}}})});await (0,h.logGLAudit)({action:"UPDATE",entityType:"JournalEntry",entityId:j.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Journal entry ${j.entryNumber} updated`,previousValues:i,newValues:j});let k=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/journal-entries`:`/agency/${b.agencyId}/fi/general-ledger/journal-entries`;return(0,e.revalidatePath)(k),{success:!0,data:j}}catch(a){return console.error("Error in updateJournalEntry:",a),{success:!1,error:"Failed to update journal entry"}}},a8=async a=>{try{let b=await a0();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.general_ledger.journal_entries.submit"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.general_ledger.journal_entries.submit")))return{success:!1,error:"Unauthorized: Missing permission to submit journal entries"};let d=await c.db.journalEntry.findUnique({where:{id:a},include:{Lines:!0}});if(!d)return{success:!1,error:"Journal entry not found"};if(d.status!==m.JournalEntryStatus.DRAFT)return{success:!1,error:"Can only submit draft journal entries"};let g=a1(d.Lines.map(a=>({debitAmount:a.debitAmount.toNumber(),creditAmount:a.creditAmount.toNumber()})));if(!g.valid)return{success:!1,error:g.message};let k=await c.db.journalEntry.update({where:{id:a},data:{status:m.JournalEntryStatus.PENDING_APPROVAL,submittedAt:new Date,submittedBy:b.userId,updatedBy:b.userId}});await (0,h.logGLAudit)({action:"UPDATE",entityType:"JournalEntry",entityId:a,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Journal entry ${d.entryNumber} submitted for approval`}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.submitted,{type:"JournalEntry",id:a},{amount:d.Lines.reduce((a,b)=>a+b.debitAmount.toNumber(),0),reference:d.entryNumber,description:d.description||"Journal entry submitted"});let l=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/journal-entries`:`/agency/${b.agencyId}/fi/general-ledger/journal-entries`;return(0,e.revalidatePath)(l),{success:!0,data:k}}catch(a){return console.error("Error in submitJournalEntry:",a),{success:!1,error:"Failed to submit journal entry"}}},a9=async(a,b)=>{try{let d=await a0();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,f.hasSubAccountPermission)(d.subAccountId,"fi.general_ledger.journal_entries.approve"):await (0,f.hasAgencyPermission)(d.agencyId,"fi.general_ledger.journal_entries.approve")))return{success:!1,error:"Unauthorized: Missing permission to approve journal entries"};let g=await c.db.journalEntry.findUnique({where:{id:a},include:{Lines:{include:{Account:{select:{id:!0,isControlAccount:!0,accountType:!0}}}},Period:!0}});if(!g)return{success:!1,error:"Journal entry not found"};if(g.status!==m.JournalEntryStatus.PENDING_APPROVAL)return{success:!1,error:"Can only approve entries pending approval"};if(g.Period.status!==m.PeriodStatus.OPEN)return{success:!1,error:"Cannot post to closed or locked periods"};let k="MYR";if(d.subAccountId){let a=await c.db.gLConfigurationSubAccount.findUnique({where:{subAccountId:d.subAccountId},select:{baseCurrency:!0}});a?.baseCurrency&&(k=a.baseCurrency)}else if(d.agencyId){let a=await c.db.gLConfiguration.findUnique({where:{agencyId:d.agencyId},select:{baseCurrency:!0}});a?.baseCurrency&&(k=a.baseCurrency)}let l=await c.db.$transaction(async c=>{let e=await c.journalEntry.update({where:{id:a},data:{status:m.JournalEntryStatus.APPROVED,approvedAt:new Date,approvedBy:d.userId,notes:b,updatedBy:d.userId}});for(let a of(await a2(c,g.periodId,g.Lines.map(a=>({accountId:a.accountId,debitAmount:a.debitAmount.toNumber(),creditAmount:a.creditAmount.toNumber(),currency:"USD"})),d.userId,d),g.Lines.filter(a=>a.Account?.isControlAccount===!0))){let b=new aZ(a.debitAmount.toString()).toNumber(),e=new aZ(a.creditAmount.toString()).toNumber(),f=b-e;await c.openItem.create({data:{agencyId:d.agencyId,subAccountId:d.subAccountId,accountId:a.accountId,journalEntryId:g.id,journalLineId:a.id,sourceModule:g.sourceModule,sourceId:g.id,sourceReference:g.entryNumber,reference:g.reference||void 0,assignment:a.subledgerReference||void 0,text:a.description||g.description,itemDate:g.entryDate,itemType:"JOURNAL",dueDate:g.entryDate,localCurrencyCode:k,localAmount:f,localRemainingAmount:f,documentCurrencyCode:g.currencyCode||k,documentAmount:f,documentRemainingAmount:f,exchangeRate:g.exchangeRate?.toNumber()||1,status:"OPEN",createdBy:d.userId}})}return e});await (0,h.logGLAudit)({action:"UPDATE",entityType:"JournalEntry",entityId:a,agencyId:d.agencyId,subAccountId:d.subAccountId,description:`Journal entry ${g.entryNumber} approved and posted`}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.approved,{type:"JournalEntry",id:a},{amount:g.Lines.reduce((a,b)=>a+b.debitAmount.toNumber(),0),reference:g.entryNumber,description:g.description||"Journal entry approved",metadata:{periodId:g.periodId}}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.posted,{type:"JournalEntry",id:a},{amount:g.Lines.reduce((a,b)=>a+b.debitAmount.toNumber(),0),reference:g.entryNumber,description:g.description||"Journal entry posted",metadata:{periodId:g.periodId,lines:g.Lines.map(a=>({accountId:a.accountId,debit:a.debitAmount.toNumber(),credit:a.creditAmount.toNumber()}))}});let n=d.subAccountId?`/subaccount/${d.subAccountId}/fi/general-ledger/journal-entries`:`/agency/${d.agencyId}/fi/general-ledger/journal-entries`;return(0,e.revalidatePath)(n),{success:!0,data:l}}catch(a){return console.error("Error in approveJournalEntry:",a),{success:!1,error:"Failed to approve journal entry"}}},ba=async(a,b)=>{try{let d=await a0();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,f.hasSubAccountPermission)(d.subAccountId,"fi.general_ledger.journal_entries.reject"):await (0,f.hasAgencyPermission)(d.agencyId,"fi.general_ledger.journal_entries.reject")))return{success:!1,error:"Unauthorized: Missing permission to reject journal entries"};let g=await c.db.journalEntry.findUnique({where:{id:a}});if(!g)return{success:!1,error:"Journal entry not found"};if(g.status!==m.JournalEntryStatus.PENDING_APPROVAL)return{success:!1,error:"Can only reject entries pending approval"};let k=await c.db.journalEntry.update({where:{id:a},data:{status:m.JournalEntryStatus.REJECTED,rejectedAt:new Date,rejectedBy:d.userId,rejectionReason:b,updatedBy:d.userId}});await (0,h.logGLAudit)({action:"UPDATE",entityType:"JournalEntry",entityId:a,agencyId:d.agencyId,subAccountId:d.subAccountId,description:`Journal entry ${g.entryNumber} rejected`,reason:b}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.rejected,{type:"JournalEntry",id:a},{amount:0,reference:g.entryNumber,description:b||"Journal entry rejected"});let l=d.subAccountId?`/subaccount/${d.subAccountId}/fi/general-ledger/journal-entries`:`/agency/${d.agencyId}/fi/general-ledger/journal-entries`;return(0,e.revalidatePath)(l),{success:!0,data:k}}catch(a){return console.error("Error in rejectJournalEntry:",a),{success:!1,error:"Failed to reject journal entry"}}},bb=async(a,b,d)=>{try{let g=await a0();if(!g)return{success:!1,error:"Unauthorized: No session found"};if(!(g.subAccountId?await (0,f.hasSubAccountPermission)(g.subAccountId,"fi.general_ledger.journal_entries.reverse"):await (0,f.hasAgencyPermission)(g.agencyId,"fi.general_ledger.journal_entries.reverse")))return{success:!1,error:"Unauthorized: Missing permission to reverse journal entries"};let k=await c.db.journalEntry.findUnique({where:{id:a},include:{Lines:!0,Period:!0}});if(!k)return{success:!1,error:"Journal entry not found"};if(k.status!==m.JournalEntryStatus.APPROVED)return{success:!1,error:"Can only reverse approved journal entries"};if(k.isReversal)return{success:!1,error:"Entry has already been reversed"};let l=await c.db.financialPeriod.findFirst({where:g.subAccountId?{subAccountId:g.subAccountId,startDate:{lte:d},endDate:{gte:d}}:{agencyId:g.agencyId,subAccountId:null,startDate:{lte:d},endDate:{gte:d}}});if(!l)return{success:!1,error:"No open period found for reversal date"};if(l.status!==m.PeriodStatus.OPEN)return{success:!1,error:"Reversal period must be open"};let n=await c.db.journalEntry.findFirst({where:g.subAccountId?{subAccountId:g.subAccountId}:{agencyId:g.agencyId,subAccountId:null},orderBy:{entryNumber:"desc"},select:{entryNumber:!0}}),o=n?parseInt(n.entryNumber,10)+1:1,p=await c.db.$transaction(async b=>{let c=await b.journalEntry.create({data:{entryNumber:`${o}`.padStart(6,"0"),entryDate:d,description:`Reversal of JE ${k.entryNumber}: ${k.description}`,reference:k.reference,status:m.JournalEntryStatus.APPROVED,entryType:k.entryType,periodId:l.id,isReversal:!0,reversalOfId:k.id,agencyId:g.subAccountId?null:g.agencyId,subAccountId:g.subAccountId||null,createdBy:g.userId,updatedBy:g.userId,approvedAt:new Date,approvedBy:g.userId}});for(let a of k.Lines)await b.journalEntryLine.create({data:{journalEntryId:c.id,accountId:a.accountId,description:a.description,debitAmount:a.creditAmount.toNumber(),creditAmount:a.debitAmount.toNumber(),exchangeRate:a.exchangeRate,debitAmountBase:a.debitAmountBase.toNumber(),creditAmountBase:a.creditAmountBase.toNumber(),createdAt:new Date,lineNumber:a.lineNumber}});await b.journalEntry.update({where:{id:a},data:{isReversal:!0,reversedAt:new Date,reversedByUser:g.userId}});let e=k.Lines.map(a=>({accountId:a.accountId,debitAmount:a.creditAmount,creditAmount:a.debitAmount,currency:"USD"}));return await a2(b,l.id,e.map(a=>({...a,debitAmount:a.debitAmount.toNumber(),creditAmount:a.creditAmount.toNumber()})),g.userId,g),c});await (0,h.logGLAudit)({action:"CREATE",entityType:"JournalEntry",entityId:p.id,agencyId:g.agencyId,subAccountId:g.subAccountId,description:`Reversal entry ${p.entryNumber} created for JE ${k.entryNumber}`,reason:b}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.reversed,{type:"JournalEntry",id:a},{amount:0,reference:k.entryNumber,description:b||"Journal entry reversed",metadata:{reversalEntryId:p.id,reversalEntryNumber:p.entryNumber,reversalDate:p.entryDate}}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.journal_entries.posted,{type:"JournalEntry",id:p.id},{amount:k.Lines.reduce((a,b)=>a+b.creditAmount.toNumber(),0),reference:p.entryNumber,description:p.description||"Reversal entry posted",metadata:{isReversal:!0,originalEntryId:a}});let q=g.subAccountId?`/subaccount/${g.subAccountId}/fi/general-ledger/journal-entries`:`/agency/${g.agencyId}/fi/general-ledger/journal-entries`;return(0,e.revalidatePath)(q),{success:!0,data:p}}catch(a){return console.error("Error in reverseJournalEntry:",a),{success:!1,error:"Failed to reverse journal entry"}}};(0,a_.ensureServerEntryExports)([a3,a4,a5,a6,a7,a8,a9,ba,bb]),(0,b.registerServerReference)(a3,"40b589cd4e8bc98f00bccc10d3d8c9205f369560ce",null),(0,b.registerServerReference)(a4,"406c004a1d94f3b27f3ee27f877315bd60f60eeed5",null),(0,b.registerServerReference)(a5,"0014aabe767485f060e4bc7877834bc333bff02850",null),(0,b.registerServerReference)(a6,"40e3beed1dc4ea30a08f2fc2b8b23dc9ce34a1128a",null),(0,b.registerServerReference)(a7,"40c6deca694f7200b2339ae67e92154b0d5f2c8534",null),(0,b.registerServerReference)(a8,"4094967d55cba38eaae53d16ca7af28cdac68939ad",null),(0,b.registerServerReference)(a9,"6090bcd21259ee87777f75e1ef84a8b891a09f5d13",null),(0,b.registerServerReference)(ba,"603bb93f0adfe5d5f4b85d60ba0ec3d0e7eb8d671d",null),(0,b.registerServerReference)(bb,"70c8b859edef83002142fe5e732bfa133d69123925",null),a.s(["approveJournalEntry",0,a9,"createJournalEntry",0,a6,"getJournalEntry",0,a3,"getPendingApprovals",0,a5,"listJournalEntries",0,a4,"rejectJournalEntry",0,ba,"reverseJournalEntry",0,bb,"submitJournalEntry",0,a8,"updateJournalEntry",0,a7],68184)},481517,a=>{"use strict";var b=a.i(53112),c=a.i(349618);let d=/^[A-Z0-9]{1,4}(-[A-Z0-9]{1,4})*$/,e=b.z.object({code:b.z.string().min(1,"Account code is required").max(20,"Account code must be 20 characters or less").regex(d,"Invalid account code format"),name:b.z.string().min(1,"Account name is required").max(100,"Account name must be 100 characters or less"),description:b.z.string().max(500).optional(),parentAccountId:b.z.string().uuid().optional().nullable(),accountType:b.z.enum(c.AccountType),category:b.z.enum(c.AccountCategory).optional(),subcategory:b.z.string().max(50).optional(),isControlAccount:b.z.boolean().default(!1),subledgerType:b.z.enum(c.SubledgerType).default("NONE"),controlAccountId:b.z.string().uuid().optional().nullable(),allowManualPosting:b.z.boolean().default(!0),requireApproval:b.z.boolean().default(!1),isPostingAccount:b.z.boolean().default(!0),isConsolidationEnabled:b.z.boolean().default(!1),consolidationAccountCode:b.z.string().max(20).optional(),currencyCode:b.z.string().length(3).optional(),isMultiCurrency:b.z.boolean().default(!1),normalBalance:b.z.enum(["DEBIT","CREDIT"]).default("DEBIT"),sortOrder:b.z.number().int().min(0).default(0)}),f=e.partial().extend({id:b.z.uuid()});b.z.object({accountId:b.z.uuid(),newParentId:b.z.uuid().optional().nullable(),newSortOrder:b.z.number().int().min(0)}),b.z.object({subAccountId:b.z.uuid(),subAccountCOACode:b.z.string().min(1),groupCOAId:b.z.uuid(),mappingPercentage:b.z.number().min(0).max(100).default(100),isElimination:b.z.boolean().default(!1),eliminationPairId:b.z.string().uuid().optional()}),a.s(["createAccountSchema",0,e,"updateAccountSchema",0,f])},44289,a=>{"use strict";var b=a.i(137936),c=a.i(761469),d=a.i(577607),e=a.i(118558),f=a.i(351728),g=a.i(481517),h=a.i(213915),i=a.i(378217),j=a.i(906708),k=a.i(713095);let l=async()=>{let a=await (0,d.auth)();if(!a?.user?.id)return null;let b=await c.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},m=async a=>{try{let b=await l();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.master_data.accounts.view"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.master_data.accounts.view")))return{success:!1,error:"Unauthorized: Missing permission to view COA"};let d=await c.db.chartOfAccount.findUnique({where:{id:a},include:{ParentAccount:{select:{id:!0,code:!0,name:!0}},ChildAccounts:{select:{id:!0,code:!0,name:!0,accountType:!0},where:{isArchived:!1}}}});if(!d)return{success:!1,error:"Account not found"};if(!(b.subAccountId?d.subAccountId===b.subAccountId:d.agencyId===b.agencyId&&!d.subAccountId))return{success:!1,error:"Account does not belong to current context"};return{success:!0,data:d}}catch(a){return console.error("Error in getAccount:",a),{success:!1,error:"Failed to get account"}}},n=async()=>{try{let a=await l();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!(a.subAccountId?await (0,f.hasSubAccountPermission)(a.subAccountId,"fi.master_data.accounts.view"):await (0,f.hasAgencyPermission)(a.agencyId,"fi.master_data.accounts.view")))return{success:!1,error:"Unauthorized: Missing permission to view COA"};let b=await c.db.chartOfAccount.findMany({where:a.subAccountId?{subAccountId:a.subAccountId,isArchived:!1}:{agencyId:a.agencyId,subAccountId:null,isArchived:!1},orderBy:[{path:"asc"},{sortOrder:"asc"}],include:{ParentAccount:{select:{id:!0,code:!0,name:!0}},ChildAccounts:{select:{id:!0,code:!0,name:!0}}}});return{success:!0,data:b}}catch(a){return console.error("Error in listChartOfAccounts:",a),{success:!1,error:"Failed to list chart of accounts"}}},o=async a=>{try{let b=await l();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.master_data.accounts.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.master_data.accounts.manage")))return{success:!1,error:"Unauthorized: Missing permission to create accounts"};let d=g.createAccountSchema.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0].message};if(await c.db.chartOfAccount.findFirst({where:b.subAccountId?{subAccountId:b.subAccountId,code:d.data.code}:{agencyId:b.agencyId,code:d.data.code,subAccountId:null}}))return{success:!1,error:"Account code already exists"};let k="/",m=0;if(d.data.parentAccountId){let a=await c.db.chartOfAccount.findUnique({where:{id:d.data.parentAccountId},select:{path:!0,level:!0}});if(!a)return{success:!1,error:"Parent account not found"};if(a.level>=6)return{success:!1,error:"Maximum hierarchy depth (7 levels) reached"};k=`${a.path}${d.data.code}/`,m=a.level+1}else k=`/${d.data.code}/`;let n=await c.db.chartOfAccount.create({data:{...d.data,agencyId:b.subAccountId?null:b.agencyId,subAccountId:b.subAccountId||null,path:k,level:m,createdBy:b.userId,updatedBy:b.userId}});await (0,h.logGLAudit)({action:"CREATE",entityType:"ChartOfAccount",entityId:n.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Account ${n.code} - ${n.name} created`}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.accounts.created,{type:"ChartOfAccount",id:n.id},{amount:0,reference:n.code,description:n.name||"Account created",accountId:n.id});let o=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/chart-of-accounts`:`/agency/${b.agencyId}/fi/general-ledger/chart-of-accounts`;return(0,e.revalidatePath)(o),{success:!0,data:n}}catch(a){return console.error("Error in createAccount:",a),{success:!1,error:"Failed to create account"}}},p=async a=>{try{let b=await l();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.master_data.accounts.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.master_data.accounts.manage")))return{success:!1,error:"Unauthorized: Missing permission to edit accounts"};let d=g.updateAccountSchema.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0].message};let k=await c.db.chartOfAccount.findUnique({where:{id:d.data.id}});if(!k)return{success:!1,error:"Account not found"};if(k.isSystemManaged)return{success:!1,error:"Cannot modify system-managed accounts"};if(!(b.subAccountId?k.subAccountId===b.subAccountId:k.agencyId===b.agencyId&&!k.subAccountId))return{success:!1,error:"Account does not belong to current context"};let{id:m,...n}=d.data,o=await c.db.chartOfAccount.update({where:{id:m},data:{...n,updatedBy:b.userId}});await (0,h.logGLAudit)({action:"UPDATE",entityType:"ChartOfAccount",entityId:o.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Account ${o.code} - ${o.name} updated`,previousValues:k,newValues:o}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.accounts.updated,{type:"ChartOfAccount",id:o.id},{amount:0,reference:o.code,description:o.name||"Account updated",accountId:o.id});let p=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/chart-of-accounts`:`/agency/${b.agencyId}/fi/general-ledger/chart-of-accounts`;return(0,e.revalidatePath)(p),{success:!0,data:o}}catch(a){return console.error("Error in updateAccount:",a),{success:!1,error:"Failed to update account"}}},q=async(a,b)=>{try{let d=await l();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,f.hasSubAccountPermission)(d.subAccountId,"fi.master_data.accounts.manage"):await (0,f.hasAgencyPermission)(d.agencyId,"fi.master_data.accounts.manage")))return{success:!1,error:"Unauthorized: Missing permission to delete accounts"};let g=await c.db.chartOfAccount.findUnique({where:{id:a},include:{ChildAccounts:!0,JournalEntryLines:{take:1},AccountBalances:{take:1}}});if(!g)return{success:!1,error:"Account not found"};if(g.isSystemAccount||g.isSystemManaged)return{success:!1,error:"Cannot archive system accounts"};if(g.ChildAccounts.length>0)return{success:!1,error:"Cannot archive account with child accounts"};if(g.JournalEntryLines.length>0)return{success:!1,error:"Cannot archive account with transactions"};if(g.AccountBalances.length>0)return{success:!1,error:"Cannot archive account with balances"};let k=await c.db.chartOfAccount.update({where:{id:a},data:{isArchived:!0,archivedAt:new Date,archivedBy:d.userId,updatedBy:d.userId}});await (0,h.logGLAudit)({action:"DELETE",entityType:"ChartOfAccount",entityId:a,agencyId:d.agencyId,subAccountId:d.subAccountId,description:`Account ${g.code} - ${g.name} archived`,reason:b}),await (0,i.emitEvent)("fi.general_ledger",j.EVENT_KEYS.fi.general_ledger.accounts.archived,{type:"ChartOfAccount",id:a},{amount:0,reference:g.code,description:b||"Account archived",accountId:a});let m=d.subAccountId?`/subaccount/${d.subAccountId}/fi/general-ledger/chart-of-accounts`:`/agency/${d.agencyId}/fi/general-ledger/chart-of-accounts`;return(0,e.revalidatePath)(m),{success:!0,data:k}}catch(a){return console.error("Error in archiveAccount:",a),{success:!1,error:"Failed to archive account"}}},r=async a=>{try{let b=await l();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.master_data.accounts.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.master_data.accounts.manage")))return{success:!1,error:"Unauthorized: Missing permission to manage hierarchy"};let d=await c.db.chartOfAccount.findUnique({where:{id:a.accountId}});if(!d)return{success:!1,error:"Account not found"};let g="/",i=0;if(a.newParentId){let b=await c.db.chartOfAccount.findUnique({where:{id:a.newParentId},select:{path:!0,level:!0}});if(!b)return{success:!1,error:"New parent account not found"};if(b.path.startsWith(d.path))return{success:!1,error:"Cannot move account under itself or its descendants"};if(g=`${b.path}${d.code}/`,(i=b.level+1)>6)return{success:!1,error:"Maximum hierarchy depth (7 levels) would be exceeded"}}else g=`/${d.code}/`,i=0;await c.db.$transaction(async c=>{for(let e of(await c.chartOfAccount.update({where:{id:a.accountId},data:{parentAccountId:a.newParentId||null,path:g,level:i,sortOrder:a.newSortOrder,updatedBy:b.userId}}),await c.chartOfAccount.findMany({where:{path:{startsWith:d.path},id:{not:d.id}}}))){let a=e.path.substring(d.path.length),b=g+a,f=i-d.level;await c.chartOfAccount.update({where:{id:e.id},data:{path:b,level:e.level+f}})}}),await (0,h.logGLAudit)({action:"UPDATE",entityType:"ChartOfAccount",entityId:a.accountId,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Account hierarchy moved: ${d.code}`,previousValues:{path:d.path,level:d.level},newValues:{path:g,level:i}});let j=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/chart-of-accounts`:`/agency/${b.agencyId}/fi/general-ledger/chart-of-accounts`;return(0,e.revalidatePath)(j),{success:!0,data:{message:"Account moved successfully"}}}catch(a){return console.error("Error in moveAccountInHierarchy:",a),{success:!1,error:"Failed to move account in hierarchy"}}};(0,k.ensureServerEntryExports)([m,n,o,p,q,r]),(0,b.registerServerReference)(m,"403d92ad92c659adbd52c8fe574c69649a8d0438d6",null),(0,b.registerServerReference)(n,"002309092d7e8ed1105811fe320655155eaacb05f2",null),(0,b.registerServerReference)(o,"40b67cefe6d2ec0a8fd5a7f04a57ef76d4cf34d54a",null),(0,b.registerServerReference)(p,"4044baf2c73a382487411665762ef385f04a39fae1",null),(0,b.registerServerReference)(q,"60d461cd45231654778902549efec93dbc25a5862c",null),(0,b.registerServerReference)(r,"4024ad043ce2c422c1343274cca1aec0c0c9c82302",null),a.s(["archiveAccount",0,q,"createAccount",0,o,"getAccount",0,m,"listChartOfAccounts",0,n,"moveAccountInHierarchy",0,r,"updateAccount",0,p])},960856,743978,a=>{"use strict";var b=a.i(137936),c=a.i(761469),d=a.i(577607),e=a.i(118558),f=a.i(351728),g=a.i(213915),h=a.i(53112);let i=h.z.object({periodId:h.z.uuid(),name:h.z.string().min(1).max(100),description:h.z.string().max(1e3).optional(),subAccountIds:h.z.array(h.z.string().uuid()).min(1),consolidationMethod:h.z.enum(["FULL","PROPORTIONAL","EQUITY"]).default("FULL"),notes:h.z.string().max(1e3).optional()});h.z.object({snapshotId:h.z.uuid()});let j=h.z.object({snapshotId:h.z.uuid(),description:h.z.string().min(1).max(500),debitAccountCode:h.z.string().min(1),creditAccountCode:h.z.string().min(1),amount:h.z.number().positive(),adjustmentType:h.z.enum(["MANUAL","MINORITY_INTEREST","GOODWILL","OTHER"]),notes:h.z.string().max(1e3).optional()}),k=h.z.object({snapshotId:h.z.uuid(),description:h.z.string().min(1).max(500),subAccountId1:h.z.string().uuid(),subAccountId2:h.z.string().uuid(),accountCode1:h.z.string().min(1),accountCode2:h.z.string().min(1),amount:h.z.number().positive(),eliminationType:h.z.enum(["REVENUE_EXPENSE","RECEIVABLE_PAYABLE","INVENTORY_PROFIT","OTHER"]),notes:h.z.string().max(1e3).optional()});h.z.object({subAccountId:h.z.uuid(),ownershipPercentage:h.z.number().min(0).max(100),consolidationMethod:h.z.enum(["FULL","PROPORTIONAL","EQUITY"]),effectiveFrom:h.z.coerce.date(),effectiveTo:h.z.coerce.date().optional(),minorityInterestAccountCode:h.z.string().optional()});var l=a.i(978561);a.i(659281);var m=a.i(349618),n=a.i(713095);let o=async()=>{let a=await (0,d.auth)();if(!a?.user?.id)return null;let b=await c.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},p=async(a,b)=>a.subAccountId?(0,f.hasSubAccountPermission)(a.subAccountId,b):!!a.agencyId&&(0,f.hasAgencyPermission)(a.agencyId,b),q=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await p(b,"fi.general_ledger.consolidation.view"))return{success:!1,error:"Unauthorized: Missing permission"};let d={agencyId:b.agencyId};a&&(d.subAccountId=a);let e=await c.db.consolidationMapping.findMany({where:d,include:{SubAccount:{select:{id:!0,name:!0}},GroupCOA:{select:{id:!0,code:!0,name:!0}}},orderBy:{subAccountCOACode:"asc"}});return{success:!0,data:e}}catch(a){return console.error("Error fetching consolidation mappings:",a),{success:!1,error:"Failed to fetch consolidation mappings"}}},r=async a=>{try{let b,d=await o();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!d.agencyId)return{success:!1,error:"Agency context required for consolidation"};if(!await p(d,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let f=await c.db.consolidationMapping.findFirst({where:{agencyId:d.agencyId,subAccountId:a.subAccountId,subAccountCOACode:a.subAccountCOACode}});return b=f?await c.db.consolidationMapping.update({where:{id:f.id},data:{groupCOAId:a.groupCOAId,mappingPercentage:a.mappingPercentage??100,updatedBy:d.userId}}):await c.db.consolidationMapping.create({data:{agencyId:d.agencyId,subAccountId:a.subAccountId,subAccountCOACode:a.subAccountCOACode,groupCOAId:a.groupCOAId,mappingPercentage:a.mappingPercentage??100,createdBy:d.userId}}),await (0,g.logGLAudit)({action:f?"UPDATE":"CREATE",entityType:"ConsolidationMapping",entityId:b.id,agencyId:d.agencyId,description:`${f?"Updated":"Created"} consolidation mapping`}),(0,e.revalidatePath)(`/agency/${d.agencyId}/fi/general-ledger/consolidation`),{success:!0,data:b}}catch(a){return console.error("Error upserting consolidation mapping:",a),{success:!1,error:"Failed to save consolidation mapping"}}},s=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required for consolidation"};if(!await p(b,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=await c.db.chartOfAccount.findMany({where:{subAccountId:a,isActive:!0}}),e=await c.db.agencyGroupCOA.findMany({where:{agencyId:b.agencyId,isActive:!0}}),f=new Map(e.map(a=>[a.code,a])),g=0;for(let e of d){let d=f.get(e.code);d&&!await c.db.consolidationMapping.findFirst({where:{agencyId:b.agencyId,subAccountId:a,subAccountCOACode:e.code}})&&(await c.db.consolidationMapping.create({data:{agencyId:b.agencyId,subAccountId:a,subAccountCOACode:e.code,groupCOAId:d.id,mappingPercentage:100,createdBy:b.userId}}),g++)}return{success:!0,data:{created:g}}}catch(a){return console.error("Error generating auto mappings:",a),{success:!1,error:"Failed to generate auto mappings"}}},t=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required for consolidation"};if(!await p(b,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=i.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0]?.message??"Validation failed"};let f=await c.db.gLConfiguration.findFirst({where:{agencyId:b.agencyId}});if(!f?.consolidationEnabled)return{success:!1,error:"Consolidation is not enabled"};let h=await c.db.subAccount.findMany({where:{agencyId:b.agencyId},select:{id:!0,name:!0}}),j=await c.db.consolidationSnapshot.count({where:{agencyId:b.agencyId}}),k=`CS-${new Date().getFullYear()}-${String(j+1).padStart(5,"0")}`,l=await c.db.consolidationSnapshot.create({data:{agencyId:b.agencyId,periodId:d.data.periodId,snapshotNumber:k,name:d.data.name,description:d.data.description,subAccountIds:h.map(a=>a.id),consolidationMethod:d.data.consolidationMethod,consolidatedBalances:{},balanceSheet:{},incomeStatement:{},cashFlowStatement:{},eliminationEntries:[],adjustmentEntries:[],consolidatedBy:b.userId}});for(let a of h)for(let e of(await c.db.accountBalance.findMany({where:{subAccountId:a.id,periodId:d.data.periodId},include:{Account:{select:{code:!0,name:!0,accountType:!0}}}}))){let d=await c.db.consolidationMapping.findFirst({where:{agencyId:b.agencyId,subAccountId:a.id,subAccountCOACode:e.Account?.code??""}});d&&await c.db.consolidationWorksheetLine.create({data:{snapshotId:l.id,groupCOAId:d.groupCOAId,accountCode:e.Account?.code??"",accountName:e.Account?.name??"",subAccountBalances:{[a.id]:{balance:e.closingBalance.toNumber(),percentage:d.mappingPercentage.toNumber()}},totalBeforeAdj:e.closingBalance,consolidatedBalance:e.closingBalance.times(d.mappingPercentage.dividedBy(100))}})}return await (0,g.logGLAudit)({action:"CREATE",entityType:"ConsolidationSnapshot",entityId:l.id,agencyId:b.agencyId,description:`Created consolidation snapshot for period ${d.data.periodId}`}),(0,e.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/consolidation`),{success:!0,data:l}}catch(a){return console.error("Error creating consolidation snapshot:",a),{success:!1,error:"Failed to create consolidation snapshot"}}},u=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await p(b,"fi.general_ledger.consolidation.view"))return{success:!1,error:"Unauthorized: Missing permission"};let d=a?.page??1,e=a?.pageSize??20,f=(d-1)*e,g={agencyId:b.agencyId};a?.periodId&&(g.periodId=a.periodId),a?.status&&(g.status=a.status);let[h,i]=await Promise.all([c.db.consolidationSnapshot.findMany({where:g,include:{Period:{select:{id:!0,name:!0}},_count:{select:{WorksheetLines:!0,Adjustments:!0,Eliminations:!0}}},orderBy:{createdAt:"desc"},skip:f,take:e}),c.db.consolidationSnapshot.count({where:g})]);return{success:!0,data:{snapshots:h,total:i}}}catch(a){return console.error("Error listing consolidation snapshots:",a),{success:!1,error:"Failed to list consolidation snapshots"}}},v=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await p(b,"fi.general_ledger.consolidation.view"))return{success:!1,error:"Unauthorized: Missing permission"};let d=await c.db.consolidationSnapshot.findUnique({where:{id:a},include:{Period:{select:{id:!0,name:!0,startDate:!0,endDate:!0}},WorksheetLines:{include:{GroupCOA:{select:{code:!0,name:!0}}}},Adjustments:!0,Eliminations:!0}});if(!d)return{success:!1,error:"Consolidation snapshot not found"};if(d.agencyId!==b.agencyId)return{success:!1,error:"Unauthorized: Access denied"};return{success:!0,data:d}}catch(a){return console.error("Error fetching consolidation snapshot:",a),{success:!1,error:"Failed to fetch consolidation snapshot"}}},w=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await p(b,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=j.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0]?.message??"Validation failed"};let f=await c.db.consolidationAdjustment.count({where:{snapshotId:d.data.snapshotId}}),h=`ADJ-${String(f+1).padStart(4,"0")}`,i=await c.db.consolidationAdjustment.create({data:{...d.data,adjustmentNumber:h,amount:new l.Decimal(d.data.amount),createdBy:b.userId}});return await (0,g.logGLAudit)({action:"CREATE",entityType:"ConsolidationAdjustment",entityId:i.id,agencyId:b.agencyId,description:`Created consolidation adjustment: ${i.description}`}),(0,e.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/consolidation`),{success:!0,data:i}}catch(a){return console.error("Error creating consolidation adjustment:",a),{success:!1,error:"Failed to create consolidation adjustment"}}},x=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await p(b,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=k.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0]?.message??"Validation failed"};let f=await c.db.intercompanyElimination.count({where:{snapshotId:d.data.snapshotId}}),h=`ELIM-${String(f+1).padStart(4,"0")}`,i=await c.db.intercompanyElimination.create({data:{...d.data,eliminationNumber:h,amount:new l.Decimal(d.data.amount),createdBy:b.userId}});return await (0,g.logGLAudit)({action:"CREATE",entityType:"ConsolidationElimination",entityId:i.id,agencyId:b.agencyId,description:`Created intercompany elimination: ${i.description}`}),(0,e.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/consolidation`),{success:!0,data:i}}catch(a){return console.error("Error creating consolidation elimination:",a),{success:!1,error:"Failed to create consolidation elimination"}}},y=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(!await p(b,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};if(!await c.db.consolidationSnapshot.findUnique({where:{id:a}}))return{success:!1,error:"Snapshot not found"};let d=await c.db.journalEntryLine.findMany({where:{isIntercompany:!0,JournalEntry:{agencyId:b.agencyId,status:"POSTED"}},include:{JournalEntry:{select:{subAccountId:!0,entryNumber:!0}},Account:{select:{code:!0,name:!0}}}}),e=0,f=await c.db.intercompanyElimination.count({where:{snapshotId:a}}),g=new Map;for(let a of d){let b=a.JournalEntry?.entryNumber??a.journalEntryId;g.has(b)||g.set(b,[]),g.get(b).push(a)}for(let[d,h]of g){if(h.length<2)continue;let g=h.reduce((a,b)=>a.plus(new l.Decimal(b.debitAmount)),new l.Decimal(0)),i=h.reduce((a,b)=>a.plus(new l.Decimal(b.creditAmount)),new l.Decimal(0));g.equals(i)&&(f++,await c.db.intercompanyElimination.create({data:{snapshotId:a,eliminationNumber:`ELIM-${String(f).padStart(4,"0")}`,eliminationType:"REVENUE_EXPENSE",subAccountId1:h[0]?.JournalEntry?.subAccountId??"",subAccountId2:h[1]?.JournalEntry?.subAccountId??"",accountCode1:h[0]?.Account?.code??"",accountCode2:h[1]?.Account?.code??"",amount:g,description:`IC Elimination: ${d}`,isAutoGenerated:!0,createdBy:b.userId}}),e++)}return{success:!0,data:{detected:e}}}catch(a){return console.error("Error detecting intercompany transactions:",a),{success:!1,error:"Failed to detect intercompany transactions"}}},z=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await p(b,"fi.general_ledger.consolidation.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=await c.db.consolidationSnapshot.findUnique({where:{id:a},include:{WorksheetLines:!0,Adjustments:!0,Eliminations:!0}});if(!d)return{success:!1,error:"Snapshot not found"};let f=new l.Decimal(0),h=new l.Decimal(0),i=new l.Decimal(0),j=new l.Decimal(0),k=new l.Decimal(0);for(let a of d.WorksheetLines)new l.Decimal(a.consolidatedBalance);for(let a of d.Adjustments)f=f.plus(new l.Decimal(a.amount));for(let a of d.Eliminations)f=f.minus(new l.Decimal(a.amount));let n={assets:f.toNumber(),liabilities:h.toNumber(),equity:i.toNumber(),revenue:j.toNumber(),expenses:k.toNumber()},q=await c.db.consolidationSnapshot.update({where:{id:a},data:{status:m.ConsolidationStatus.APPROVED,consolidatedBalances:n}});return await (0,g.logGLAudit)({action:"UPDATE",entityType:"ConsolidationSnapshot",entityId:a,agencyId:b.agencyId,description:"Finalized consolidation snapshot"}),(0,e.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/consolidation`),{success:!0,data:q}}catch(a){return console.error("Error finalizing consolidation:",a),{success:!1,error:"Failed to finalize consolidation"}}};(0,n.ensureServerEntryExports)([q,r,s,t,u,v,w,x,y,z]),(0,b.registerServerReference)(q,"40dc3bccfc9066e5280e667deab96280f54f60f6fe",null),(0,b.registerServerReference)(r,"40796509ac9690fa9ada0323e70004b62d739e524a",null),(0,b.registerServerReference)(s,"40f3ccd8fffe4514b888c51048f2df2800d9429e06",null),(0,b.registerServerReference)(t,"4021556c29f8593c8b75447c9af1abcbe108470c15",null),(0,b.registerServerReference)(u,"40c2c924b3bd7596a2160b8883f82c10c388efaa8d",null),(0,b.registerServerReference)(v,"403c13baf5bd16e7d79ed3d735b5e14457911a10db",null),(0,b.registerServerReference)(w,"40d434a945acdd5118cb2603fb552fb796281fc738",null),(0,b.registerServerReference)(x,"40ddbbc2c0ab36ef29fb1d4817e84c8aaaa8d5fd2c",null),(0,b.registerServerReference)(y,"40502f5db05f8ea11eb3073d476edcbc4c686157f2",null),(0,b.registerServerReference)(z,"40ff69c2b7071d42a0ac39643163f8e24c7910106e",null),a.s(["createConsolidationAdjustment",0,w,"createConsolidationElimination",0,x,"createConsolidationSnapshot",0,t,"detectIntercompanyTransactions",0,y,"finalizeConsolidation",0,z,"generateAutoMappings",0,s,"getConsolidationMappings",0,q,"getConsolidationSnapshot",0,v,"listConsolidationSnapshots",0,u,"upsertConsolidationMapping",0,r],960856);var A=b,B=c,C=d,D=e,E=f,F=h,G=h;let H=G.z.enum(["INPUT","OUTPUT","WITHHOLDING","EXEMPT"]),I=G.z.enum(["MONTHLY","QUARTERLY","ANNUAL"]),J=G.z.object({code:G.z.string().min(1).max(10).regex(/^[A-Z0-9_-]+$/i,"Code must be alphanumeric"),name:G.z.string().min(1).max(100),description:G.z.string().max(500).optional(),rate:G.z.number().min(0).max(100),type:H,accountId:G.z.uuid(),reverseChargeAccountId:G.z.string().uuid().optional(),isDefault:G.z.boolean().default(!1),isActive:G.z.boolean().default(!0),effectiveFrom:G.z.coerce.date().optional(),effectiveTo:G.z.coerce.date().optional()});J.partial().extend({id:G.z.uuid()});let K=G.z.object({enabled:G.z.boolean().default(!1),inputVATAccountId:G.z.string().uuid().nullable().optional(),outputVATAccountId:G.z.string().uuid().nullable().optional(),withholdingTaxAccountId:G.z.string().uuid().nullable().optional(),taxClearingAccountId:G.z.string().uuid().nullable().optional(),taxPayableAccountId:G.z.string().uuid().nullable().optional(),taxReceivableAccountId:G.z.string().uuid().nullable().optional(),taxPeriod:I.default("MONTHLY"),taxCodes:G.z.array(J).default([]),autoApplyDefaultTax:G.z.boolean().default(!1),requireTaxOnInvoice:G.z.boolean().default(!1),calculateTaxInclusive:G.z.boolean().default(!1)});G.z.object({periodId:G.z.uuid(),clearingDate:G.z.coerce.date(),description:G.z.string().max(200).optional(),clearInputVAT:G.z.boolean().default(!0),clearOutputVAT:G.z.boolean().default(!0),clearWithholding:G.z.boolean().default(!1),netToPayable:G.z.boolean().default(!0)}),G.z.object({amount:G.z.number(),taxCodeId:G.z.string(),isInclusive:G.z.boolean().default(!1)}),G.z.object({periodId:G.z.string().uuid().optional(),fromDate:G.z.coerce.date().optional(),toDate:G.z.coerce.date().optional(),taxType:H.optional(),taxCodes:G.z.array(G.z.string()).optional(),format:G.z.enum(["SCREEN","PDF","EXCEL","CSV"]).default("SCREEN")}),Object.entries({SIMPLE_VAT:{name:"Simple VAT",description:"Standard input/output VAT setup",codes:[{code:"VAT_IN",name:"Input VAT",type:"INPUT",rate:0},{code:"VAT_OUT",name:"Output VAT",type:"OUTPUT",rate:0}]},GST:{name:"GST",description:"Goods and Services Tax setup",codes:[{code:"GST_IN",name:"GST Input",type:"INPUT",rate:0},{code:"GST_OUT",name:"GST Output",type:"OUTPUT",rate:0},{code:"GST_EXEMPT",name:"GST Exempt",type:"EXEMPT",rate:0}]},SALES_TAX:{name:"Sales Tax",description:"US-style sales tax setup",codes:[{code:"SALES_TAX",name:"Sales Tax",type:"OUTPUT",rate:0},{code:"USE_TAX",name:"Use Tax",type:"INPUT",rate:0}]},WITHHOLDING:{name:"Withholding Tax",description:"Income withholding tax setup",codes:[{code:"WHT",name:"Withholding Tax",type:"WITHHOLDING",rate:0}]},NONE:{name:"No Tax",description:"No tax management",codes:[]}}).map(([a,b])=>({id:a,...b}));let L=F.z.object({baseCurrency:F.z.string().length(3).default("USD"),fiscalYearEnd:F.z.string().regex(/^(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/).default("12-31"),fiscalYearStart:F.z.string().regex(/^(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/).default("01-01"),useControlAccounts:F.z.boolean().default(!0),requireApproval:F.z.boolean().default(!0),approvalThreshold:F.z.number().positive().optional(),autoPostingEnabled:F.z.boolean().default(!1),allowFuturePeriodPost:F.z.boolean().default(!1),allowClosedPeriodPost:F.z.boolean().default(!1),consolidationEnabled:F.z.boolean().default(!1),consolidationMethod:F.z.enum(["FULL","PROPORTIONAL","EQUITY"]).default("FULL"),eliminateIntercompany:F.z.boolean().default(!0),autoCreatePeriods:F.z.boolean().default(!0),periodLockDays:F.z.number().int().min(0).max(365).default(5),accountCodeFormat:F.z.string().max(20).default("####-####"),accountCodeLength:F.z.number().int().min(4).max(20).default(8),accountCodeSeparator:F.z.string().max(1).default("-"),taxSettings:K.optional(),erpIntegrationEnabled:F.z.boolean().default(!1),erpSystemType:F.z.string().nullable().optional(),erpApiUrl:F.z.string().url().nullable().optional(),erpApiKey:F.z.string().nullable().optional(),retainAuditDays:F.z.number().int().min(365).max(3650).default(2555)}),M=L.partial();var N=g,O=m;let P=async()=>{let a=await (0,C.auth)();if(!a?.user?.id)return null;let b=await B.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},Q=async(a,b)=>a.subAccountId?(0,E.hasSubAccountPermission)(a.subAccountId,b):!!a.agencyId&&(0,E.hasAgencyPermission)(a.agencyId,b),R=async()=>{try{let a=await P();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!a.agencyId)return{success:!1,error:"Agency context required"};if(!await Q(a,"fi.general_ledger.settings.view"))return{success:!1,error:"Unauthorized: Missing permission"};let b=await B.db.gLConfiguration.findFirst({where:{agencyId:a.agencyId}});return b||(b={id:"",agencyId:a.agencyId??null,subAccountId:a.subAccountId??null,baseCurrency:"USD",fiscalYearEnd:"12-31",fiscalYearStart:"01-01",useControlAccounts:!0,requireApproval:!0,autoPostingEnabled:!1,allowFuturePeriodPost:!1,allowClosedPeriodPost:!1,consolidationMethod:O.ConsolidationMethod.FULL,eliminateIntercompany:!0,autoCreatePeriods:!0,periodLockDays:5,accountCodeFormat:"####-####",accountCodeLength:8,erpIntegrationEnabled:!1,erpSystemType:null,erpApiUrl:null,erpApiKey:null,retainAuditDays:2555,createdAt:new Date,updatedAt:new Date,updatedBy:null}),{success:!0,data:b}}catch(a){return console.error("Error fetching GL configuration:",a),{success:!1,error:"Failed to fetch GL configuration"}}},S=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let c=L.safeParse(a);if(!c.success)return{success:!1,error:c.error.message};let d=c.data;if(await B.db.gLConfiguration.findFirst({where:{agencyId:b.agencyId}}))return{success:!1,error:"GL configuration already exists. Use update instead."};let e=await B.db.gLConfiguration.create({data:{...d,agencyId:b.agencyId??null,updatedBy:b.userId}});return await (0,N.logGLAudit)({action:"CREATE",entityType:"GLConfiguration",entityId:e.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:"Initialized GL configuration"}),(0,D.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/settings`),{success:!0,data:{id:e.id}}}catch(a){return console.error("Error initializing GL configuration:",a),{success:!1,error:"Failed to initialize GL configuration"}}},T=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let c=M.safeParse(a);if(!c.success)return{success:!1,error:c.error.issues[0].message};let d=c.data,e=await B.db.gLConfiguration.findFirst({where:b.subAccountId?{Agency:{SubAccount:{some:{id:b.subAccountId}}}}:{agencyId:b.agencyId}}),f=e?{...e}:null;return e?await B.db.gLConfiguration.update({where:{id:e.id},data:{...d,updatedBy:b.userId}}):e=await B.db.gLConfiguration.create({data:{baseCurrency:"USD",fiscalYearEnd:"12-31",fiscalYearStart:"01-01",useControlAccounts:!0,requireApproval:!0,autoPostingEnabled:!1,allowFuturePeriodPost:!1,allowClosedPeriodPost:!1,consolidationMethod:O.ConsolidationMethod.FULL,eliminateIntercompany:!0,autoCreatePeriods:!0,periodLockDays:5,accountCodeFormat:"####-####",accountCodeLength:8,retainAuditDays:2555,...d,agencyId:b.agencyId||"",...b.subAccountId?{subAccountId:b.subAccountId}:{},updatedBy:b.userId}}),await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfiguration",entityId:e.id,agencyId:b.agencyId,subAccountId:b.subAccountId,previousValues:f,newValues:d,description:"Updated GL configuration"}),(0,D.revalidatePath)(`/agency/${b.agencyId}/finance/gl/settings`),{success:!0}}catch(a){return console.error("Error updating GL configuration:",a),{success:!1,error:"Failed to update GL configuration"}}},U=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(!await (0,E.hasAgencyPermission)(b.agencyId,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission to edit GL settings"};let c=L.safeParse(a);if(!c.success)return{success:!1,error:c.error.issues[0].message};if(await B.db.gLConfiguration.findUnique({where:{agencyId:b.agencyId}}))return{success:!1,error:"GL configuration already exists. Use update instead."};let d=await B.db.gLConfiguration.create({data:{...c.data,agencyId:b.agencyId,updatedBy:b.userId}});return await (0,N.logGLAudit)({action:"CREATE",entityType:"GLConfiguration",entityId:d.id,agencyId:b.agencyId,description:"GL Configuration created"}),(0,D.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger`),{success:!0,data:d}}catch(a){return console.error("Error in createGLConfiguration:",a),{success:!1,error:"Failed to create GL configuration"}}},V=async()=>{try{let a=await P();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!a.agencyId)return{success:!1,error:"Agency context required"};if(!await (0,E.hasAgencyPermission)(a.agencyId,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission to initialize GL module"};if(await B.db.gLConfiguration.findUnique({where:{agencyId:a.agencyId}}))return{success:!1,error:"GL module already initialized for this agency"};let b=await B.db.gLConfiguration.create({data:{agencyId:a.agencyId,baseCurrency:"USD",fiscalYearEnd:"12-31",fiscalYearStart:"01-01",useControlAccounts:!0,requireApproval:!0,autoPostingEnabled:!1,allowFuturePeriodPost:!1,allowClosedPeriodPost:!1,consolidationEnabled:!1,consolidationMethod:"FULL",eliminateIntercompany:!0,autoCreatePeriods:!0,periodLockDays:5,accountCodeFormat:"####-####",accountCodeLength:8,accountCodeSeparator:"-",retainAuditDays:2555,updatedBy:a.userId}}),c=await W(a.agencyId,a.userId);return await (0,N.logGLAudit)({action:"CREATE",entityType:"GLConfiguration",entityId:b.id,agencyId:a.agencyId,description:"GL Module initialized with default configuration and system accounts"}),(0,D.revalidatePath)(`/agency/${a.agencyId}/fi/general-ledger`),{success:!0,data:{configuration:b,systemAccounts:c}}}catch(a){return console.error("Error in initializeGLModule:",a),{success:!1,error:"Failed to initialize GL module"}}};async function W(a,b){let c=[{code:"9999-0000",name:"Retained Earnings",accountType:"EQUITY",category:"RETAINED_EARNINGS_CAT",isSystemAccount:!0,isSystemManaged:!0,systemAccountType:"RETAINED_EARNINGS",normalBalance:"CREDIT",allowManualPosting:!1},{code:"9999-9999",name:"Suspense Account",accountType:"ASSET",category:"CURRENT_ASSET",isSystemAccount:!0,systemAccountType:"SUSPENSE",isSuspenseAccount:!0,normalBalance:"DEBIT",allowManualPosting:!0},{code:"9999-9998",name:"Opening Balance Control",accountType:"EQUITY",isSystemAccount:!0,isSystemManaged:!0,systemAccountType:"OPENING_BALANCE_CONTROL",isOpeningBalControl:!0,normalBalance:"CREDIT",allowManualPosting:!1}];return await B.db.$transaction(c.map(c=>B.db.chartOfAccount.create({data:{...c,agencyId:a,createdBy:b,updatedBy:b,path:`/${c.code}/`,level:0}})))}let X=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};if(!/^[A-Z]{3}$/.test(a))return{success:!1,error:"Invalid currency code format. Must be 3 uppercase letters."};if(await B.db.journalEntry.count({where:{...b.subAccountId?{subAccountId:b.subAccountId}:{agencyId:b.agencyId,subAccountId:null},status:"POSTED"}})>0)return{success:!1,error:"Cannot change base currency after transactions have been posted"};return await T({baseCurrency:a}),{success:!0}}catch(a){return console.error("Error updating base currency:",a),{success:!1,error:"Failed to update base currency"}}},Y=async(a,b)=>{try{let c=await P();if(!c)return{success:!1,error:"Unauthorized: No session found"};if(!c.agencyId)return{success:!1,error:"Agency context required"};if(!await Q(c,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=/^(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/;if(!d.test(a)||!d.test(b))return{success:!1,error:"Invalid date format. Use MM-DD format (e.g., 01-01, 12-31)."};return await T({fiscalYearStart:a,fiscalYearEnd:b}),await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfiguration",entityId:c.agencyId,agencyId:c.agencyId,description:`Updated fiscal year: ${a} to ${b}`}),{success:!0}}catch(a){return console.error("Error updating fiscal year:",a),{success:!1,error:"Failed to update fiscal year"}}},Z=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};return await T(a),await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfiguration",entityId:b.agencyId,agencyId:b.agencyId,description:"Updated approval settings",newValues:a}),{success:!0}}catch(a){return console.error("Error updating approval settings:",a),{success:!1,error:"Failed to update approval settings"}}},$=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(b.subAccountId)return{success:!1,error:"Consolidation settings can only be configured at agency level"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};return await T(a),await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfiguration",entityId:b.agencyId,agencyId:b.agencyId,description:"Updated consolidation settings",newValues:a}),{success:!0}}catch(a){return console.error("Error updating consolidation settings:",a),{success:!1,error:"Failed to update consolidation settings"}}},_=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};if(!/^[#\-\.]+$/.test(a.accountCodeFormat))return{success:!1,error:"Invalid account code format. Use # for digits and - or . as separators."};let c=(a.accountCodeFormat.match(/#/g)||[]).length;if(c!==a.accountCodeLength)return{success:!1,error:`Account code length (${a.accountCodeLength}) must match format digit count (${c})`};if(await B.db.chartOfAccount.count({where:{agencyId:b.agencyId,isSystemAccount:!1}})>0)return{success:!1,error:"Cannot change account code format after accounts have been created"};return await T(a),await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfiguration",entityId:b.agencyId,agencyId:b.agencyId,description:`Updated account code format to ${a.accountCodeFormat}`,newValues:a}),{success:!0}}catch(a){return console.error("Error updating account code format:",a),{success:!1,error:"Failed to update account code format"}}},aa=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!b.agencyId)return{success:!1,error:"Agency context required"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};if(a.erpIntegrationEnabled){if(!a.erpSystemType)return{success:!1,error:"ERP system type is required when enabling integration"};if(!a.erpApiUrl)return{success:!1,error:"ERP API URL is required when enabling integration"}}return await T(a),await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfiguration",entityId:b.agencyId,agencyId:b.agencyId,description:a.erpIntegrationEnabled?`Enabled ERP integration with ${a.erpSystemType}`:"Disabled ERP integration"}),{success:!0}}catch(a){return console.error("Error updating ERP integration:",a),{success:!1,error:"Failed to update ERP integration"}}},ab=async()=>{try{let a=await P();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!a.agencyId)return{success:!1,error:"Agency context required"};let b={agencyId:a.agencyId},[c,d,e,f]=await Promise.all([B.db.gLConfiguration.findFirst({where:b}),B.db.chartOfAccount.count({where:b}),B.db.financialPeriod.count({where:b}),B.db.chartOfAccount.count({where:{...b,isSystemAccount:!0}})]),g=!!c,h=d>0,i=e>0,j=f>=3,k=[{step:"configuration",completed:g,description:"Configure GL settings (base currency, fiscal year, etc.)"},{step:"system-accounts",completed:j,description:"Create required system accounts (Retained Earnings, Suspense, etc.)"},{step:"chart-of-accounts",completed:h&&d>f,description:"Set up Chart of Accounts"},{step:"financial-periods",completed:i,description:"Create financial periods"}];return{success:!0,data:{isConfigured:g,hasAccounts:h,hasPeriods:i,hasSystemAccounts:j,setupSteps:k}}}catch(a){return console.error("Error fetching GL setup status:",a),{success:!1,error:"Failed to fetch GL setup status"}}},ac=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};let c=a??b.subAccountId;if(!c)return{success:!1,error:"SubAccount context required"};if(!await Q(b,"fi.general_ledger.settings.view"))return{success:!1,error:"Unauthorized: Missing permission"};let d=await B.db.gLConfigurationSubAccount.findUnique({where:{subAccountId:c},include:{AgencyConfig:!0,SubAccount:{select:{name:!0,agencyId:!0}}}});if(d?.isIndependent)return{success:!0,data:{...d,configLevel:"SUBACCOUNT",isIndependent:!0}};let e=await B.db.gLConfiguration.findFirst({where:{agencyId:d?.SubAccount?.agencyId??b.agencyId}});if(!e)return{success:!1,error:"Agency GL configuration not found"};let f={...e,...d&&{baseCurrency:d.baseCurrency??e.baseCurrency,fiscalYearStart:d.fiscalYearStart??e.fiscalYearStart,fiscalYearEnd:d.fiscalYearEnd??e.fiscalYearEnd,useControlAccounts:d.useControlAccounts??e.useControlAccounts,requireApproval:d.requireApproval??e.requireApproval,approvalThreshold:d.approvalThreshold??e.approvalThreshold,autoPostingEnabled:d.autoPostingEnabled??e.autoPostingEnabled,allowFuturePeriodPost:d.allowFuturePeriodPost??e.allowFuturePeriodPost,allowClosedPeriodPost:d.allowClosedPeriodPost??e.allowClosedPeriodPost,autoCreatePeriods:d.autoCreatePeriods??e.autoCreatePeriods,periodLockDays:d.periodLockDays??e.periodLockDays,accountCodeFormat:d.accountCodeFormat??e.accountCodeFormat,accountCodeLength:d.accountCodeLength??e.accountCodeLength,retainAuditDays:d.retainAuditDays??e.retainAuditDays},configLevel:d?"INHERITED_WITH_OVERRIDES":"INHERITED",isIndependent:!1,subAccountConfigId:d?.id};return{success:!0,data:f}}catch(a){return console.error("Error fetching SubAccount GL configuration:",a),{success:!1,error:"Failed to fetch SubAccount GL configuration"}}},ad=async a=>{try{let b=await P();if(!b)return{success:!1,error:"Unauthorized: No session found"};let c=a.subAccountId??b.subAccountId;if(!c)return{success:!1,error:"SubAccount context required"};if(!await Q(b,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let d=await B.db.subAccount.findUnique({where:{id:c},select:{agencyId:!0}});if(!d)return{success:!1,error:"SubAccount not found"};let e=await B.db.gLConfiguration.findFirst({where:{agencyId:d.agencyId}}),{subAccountId:f,...g}=a,h=await B.db.gLConfigurationSubAccount.upsert({where:{subAccountId:c},update:{...g,updatedBy:b.userId},create:{subAccountId:c,agencyConfigId:e?.id,isIndependent:a.isIndependent??!1,...g}});return await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfigurationSubAccount",entityId:h.id,agencyId:b.agencyId,subAccountId:c,description:"Updated SubAccount GL configuration"}),(0,D.revalidatePath)(`/agency/${b.agencyId}/fi/general-ledger/settings`),{success:!0,data:h}}catch(a){return console.error("Error updating SubAccount GL configuration:",a),{success:!1,error:"Failed to update SubAccount GL configuration"}}},ae=async(a,b)=>{try{let c=await P();if(!c)return{success:!1,error:"Unauthorized: No session found"};let d=a??c.subAccountId;if(!d)return{success:!1,error:"SubAccount context required"};if(!await Q(c,"fi.general_ledger.settings.manage"))return{success:!1,error:"Unauthorized: Missing permission"};let e=await B.db.gLConfigurationSubAccount.findUnique({where:{subAccountId:d}}),f=b??!e?.isIndependent,g=await B.db.subAccount.findUnique({where:{id:d},select:{agencyId:!0}}),h=await B.db.gLConfiguration.findFirst({where:{agencyId:g?.agencyId}}),i=await B.db.gLConfigurationSubAccount.upsert({where:{subAccountId:d},update:{isIndependent:f,updatedBy:c.userId},create:{subAccountId:d,agencyConfigId:h?.id,isIndependent:f}});return await (0,N.logGLAudit)({action:"UPDATE",entityType:"GLConfigurationSubAccount",entityId:i.id,agencyId:c.agencyId,subAccountId:d,description:`Toggled SubAccount independence to: ${f}`}),(0,D.revalidatePath)(`/agency/${c.agencyId}/fi/general-ledger/settings`),{success:!0,data:{isIndependent:f}}}catch(a){return console.error("Error toggling SubAccount independence:",a),{success:!1,error:"Failed to toggle SubAccount independence"}}},af=async()=>{try{let a=await P();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(a.subAccountId)return ac(a.subAccountId);return R()}catch(a){return console.error("Error fetching effective configuration:",a),{success:!1,error:"Failed to fetch effective configuration"}}};(0,n.ensureServerEntryExports)([R,S,T,U,V,X,Y,Z,$,_,aa,ab,ac,ad,ae,af]),(0,A.registerServerReference)(R,"00d5cf5866210e4e91c9c5bf9f0697e16f2957a37d",null),(0,A.registerServerReference)(S,"4082a7cddd12f558a23615c11447210af09d5aa3e2",null),(0,A.registerServerReference)(T,"4035d595559932637460e183d4645d5fba4e4973dc",null),(0,A.registerServerReference)(U,"40ef47c8d7f4a148218f4c2abcb065c91c8b067b98",null),(0,A.registerServerReference)(V,"00b73af7fe8a37f002eb09dc4c2d733d2e203ad2e5",null),(0,A.registerServerReference)(X,"402088cbcc19d7eb6cf62eb1644f3109edc1c66240",null),(0,A.registerServerReference)(Y,"60d1dd7f780ced21cf879e9d7aefa798ed9767b178",null),(0,A.registerServerReference)(Z,"408627094323c3da03939125ab92077c6dbe885487",null),(0,A.registerServerReference)($,"40138128b985e606268f67c04881579b303ff20e91",null),(0,A.registerServerReference)(_,"40f1c4ce5b382577731ec1e8519ac2736f4dafef6a",null),(0,A.registerServerReference)(aa,"40340cc23f41fe43d7a127f9cd593f31162b0cd501",null),(0,A.registerServerReference)(ab,"00f0e1f0a735f6dd33b993f52e47c038e96fdcd1da",null),(0,A.registerServerReference)(ac,"400b4ad8edd5aa036acbfaadf109ba5828c8f07b22",null),(0,A.registerServerReference)(ad,"402d7c7d5f557914f2c438bc7dc7cfeece83a6332c",null),(0,A.registerServerReference)(ae,"60578c2b7a8b6ab4cb200af957ef40a96b17076324",null),(0,A.registerServerReference)(af,"00a9d3ac926750662a08b7789b5c046248bc50c745",null),a.s(["createGLConfiguration",0,U,"getEffectiveConfiguration",0,af,"getGLConfiguration",0,R,"getGLSetupStatus",0,ab,"getSubAccountConfiguration",0,ac,"initializeGLConfiguration",0,S,"initializeGLModule",0,V,"toggleSubAccountIndependence",0,ae,"updateAccountCodeFormat",0,_,"updateApprovalSettings",0,Z,"updateBaseCurrency",0,X,"updateConsolidationSettings",0,$,"updateERPIntegration",0,aa,"updateFiscalYear",0,Y,"updateGLConfiguration",0,T,"updateSubAccountConfiguration",0,ad],743978)},620876,a=>{"use strict";var b=a.i(137936),c=a.i(761469),d=a.i(577607),e=a.i(118558),f=a.i(351728),g=a.i(53112);g.z.object({name:g.z.string().min(1).max(100),shortName:g.z.string().max(20).optional(),periodType:g.z.enum(["MONTH","QUARTER","HALF_YEAR","YEAR","CUSTOM"]),fiscalYear:g.z.number().int().min(2e3).max(2100),fiscalPeriod:g.z.number().int().min(1).max(12),startDate:g.z.coerce.date(),endDate:g.z.coerce.date(),status:g.z.enum(["FUTURE","OPEN","CLOSED","LOCKED"]).default("FUTURE"),openedAt:g.z.date().optional(),openedBy:g.z.string().optional(),closedAt:g.z.date().optional(),closedBy:g.z.string().optional(),lockedAt:g.z.date().optional(),lockedBy:g.z.string().optional(),openingBalances:g.z.any().optional(),closingBalances:g.z.any().optional(),yearEndProcessedAt:g.z.date().optional(),yearEndProcessedBy:g.z.string().optional(),isYearEnd:g.z.boolean().default(!1),notes:g.z.string().max(1e3).optional()});let h=g.z.object({name:g.z.string().min(1).max(100),shortName:g.z.string().max(20).optional(),periodType:g.z.enum(["MONTH","QUARTER","HALF_YEAR","YEAR","CUSTOM"]),fiscalYear:g.z.number().int().min(2e3).max(2100),fiscalPeriod:g.z.number().int().min(1).max(12),startDate:g.z.coerce.date(),endDate:g.z.coerce.date(),isYearEnd:g.z.boolean().default(!1),notes:g.z.string().max(1e3).optional()}).refine(a=>a.endDate>a.startDate,{message:"End date must be after start date"}),i=h.extend({id:g.z.uuid()});g.z.object({id:g.z.uuid()}),g.z.object({id:g.z.uuid(),notes:g.z.string().max(500).optional()}),g.z.object({id:g.z.uuid(),notes:g.z.string().max(500).optional()}),g.z.object({periodId:g.z.uuid(),retainedEarningsAccountId:g.z.uuid(),createBroughtForward:g.z.boolean().default(!0),notes:g.z.string().max(1e3).optional()});var j=a.i(213915),k=a.i(378217),l=a.i(906708);a.i(659281);var m=a.i(349618),n=a.i(713095);let o=async()=>{let a=await (0,d.auth)();if(!a?.user?.id)return null;let b=await c.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},p=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.configuration.fiscal_years.view"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.configuration.fiscal_years.view")))return{success:!1,error:"Unauthorized: Missing permission to view periods"};let d=await c.db.financialPeriod.findUnique({where:{id:a}});if(!d)return{success:!1,error:"Period not found"};if(!(b.subAccountId?d.subAccountId===b.subAccountId:d.agencyId===b.agencyId&&!d.subAccountId))return{success:!1,error:"Period does not belong to current context"};return{success:!0,data:d}}catch(a){return console.error("Error in getFinancialPeriod:",a),{success:!1,error:"Failed to get financial period"}}},q=async()=>{try{let a=await o();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!(a.subAccountId?await (0,f.hasSubAccountPermission)(a.subAccountId,"fi.configuration.fiscal_years.view"):await (0,f.hasAgencyPermission)(a.agencyId,"fi.configuration.fiscal_years.view")))return{success:!1,error:"Unauthorized: Missing permission to view periods"};let b=await c.db.financialPeriod.findFirst({where:{...a.subAccountId?{subAccountId:a.subAccountId}:{agencyId:a.agencyId,subAccountId:null},status:m.PeriodStatus.OPEN},orderBy:[{fiscalYear:"desc"},{fiscalPeriod:"desc"}]});if(!b)return{success:!1,error:"No open period found for posting"};return{success:!0,data:b}}catch(a){return console.error("Error in getCurrentOpenPeriod:",a),{success:!1,error:"Failed to get current open period"}}},r=async()=>{try{let a=await o();if(!a)return{success:!1,error:"Unauthorized: No session found"};if(!(a.subAccountId?await (0,f.hasSubAccountPermission)(a.subAccountId,"fi.configuration.fiscal_years.view"):await (0,f.hasAgencyPermission)(a.agencyId,"fi.configuration.fiscal_years.view")))return{success:!1,error:"Unauthorized: Missing permission to view periods"};let b=await c.db.financialPeriod.findMany({where:a.subAccountId?{subAccountId:a.subAccountId}:{agencyId:a.agencyId,subAccountId:null},orderBy:[{fiscalYear:"desc"},{fiscalPeriod:"desc"}]});return{success:!0,data:b}}catch(a){return console.error("Error in listFinancialPeriods:",a),{success:!1,error:"Failed to list financial periods"}}},s=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.configuration.fiscal_years.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.configuration.fiscal_years.manage")))return{success:!1,error:"Unauthorized: Missing permission to create periods"};let d=h.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0].message};if(await c.db.financialPeriod.findFirst({where:{...b.subAccountId?{subAccountId:b.subAccountId}:{agencyId:b.agencyId,subAccountId:null},OR:[{startDate:{lte:d.data.endDate},endDate:{gte:d.data.startDate}}]}}))return{success:!1,error:"Period overlaps with existing period"};let g=await c.db.financialPeriod.create({data:{...d.data,agencyId:b.subAccountId?null:b.agencyId,subAccountId:b.subAccountId||null,status:m.PeriodStatus.FUTURE,createdBy:b.userId,updatedBy:b.userId}});await (0,j.logGLAudit)({action:"CREATE",entityType:"FinancialPeriod",entityId:g.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Financial period ${g.fiscalYear}-${g.fiscalPeriod} created`});let i=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/periods`:`/agency/${b.agencyId}/fi/general-ledger/periods`;return(0,e.revalidatePath)(i),{success:!0,data:g}}catch(a){return console.error("Error in createFinancialPeriod:",a),{success:!1,error:"Failed to create financial period"}}},t=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.configuration.fiscal_years.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.configuration.fiscal_years.manage")))return{success:!1,error:"Unauthorized: Missing permission to edit periods"};let d=i.safeParse(a);if(!d.success)return{success:!1,error:d.error.issues[0].message};let g=await c.db.financialPeriod.findUnique({where:{id:d.data.id}});if(!g)return{success:!1,error:"Period not found"};if(g.status===m.PeriodStatus.CLOSED||g.status===m.PeriodStatus.LOCKED)return{success:!1,error:"Cannot edit closed or locked periods"};let{id:h,...k}=d.data,l=await c.db.financialPeriod.update({where:{id:h},data:{...k,updatedBy:b.userId}});await (0,j.logGLAudit)({action:"UPDATE",entityType:"FinancialPeriod",entityId:l.id,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Financial period ${l.fiscalYear}-${l.fiscalPeriod} updated`,previousValues:g,newValues:l});let n=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/periods`:`/agency/${b.agencyId}/fi/general-ledger/periods`;return(0,e.revalidatePath)(n),{success:!0,data:l}}catch(a){return console.error("Error in updateFinancialPeriod:",a),{success:!1,error:"Failed to update financial period"}}},u=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.configuration.fiscal_years.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.configuration.fiscal_years.manage")))return{success:!1,error:"Unauthorized: Missing permission to open periods"};let d=await c.db.financialPeriod.findUnique({where:{id:a}});if(!d)return{success:!1,error:"Period not found"};if(d.status===m.PeriodStatus.OPEN)return{success:!1,error:"Period is already open"};if(d.status===m.PeriodStatus.LOCKED)return{success:!1,error:"Cannot reopen locked periods"};let g=await c.db.financialPeriod.update({where:{id:a},data:{status:m.PeriodStatus.OPEN,openedAt:new Date,openedBy:b.userId,updatedBy:b.userId}});await (0,j.logGLAudit)({action:"UPDATE",entityType:"FinancialPeriod",entityId:a,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Period ${d.fiscalYear}-${d.fiscalPeriod} opened`}),await (0,k.emitEvent)("fi.general_ledger",l.EVENT_KEYS.fi.general_ledger.periods.opened,{type:"FinancialPeriod",id:a},{amount:0,reference:`${d.fiscalYear}-${d.fiscalPeriod}`,description:d.name||"Period opened"});let h=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/periods`:`/agency/${b.agencyId}/fi/general-ledger/periods`;return(0,e.revalidatePath)(h),{success:!0,data:g}}catch(a){return console.error("Error in openPeriod:",a),{success:!1,error:"Failed to open period"}}},v=async a=>{try{let b=await o();if(!b)return{success:!1,error:"Unauthorized: No session found"};if(!(b.subAccountId?await (0,f.hasSubAccountPermission)(b.subAccountId,"fi.configuration.fiscal_years.manage"):await (0,f.hasAgencyPermission)(b.agencyId,"fi.configuration.fiscal_years.manage")))return{success:!1,error:"Unauthorized: Missing permission to close periods"};let d=await c.db.financialPeriod.findUnique({where:{id:a}});if(!d)return{success:!1,error:"Period not found"};if(d.status===m.PeriodStatus.CLOSED||d.status===m.PeriodStatus.LOCKED)return{success:!1,error:"Period is already closed or locked"};let g=await c.db.accountBalance.findMany({where:{periodId:a},include:{Account:!0}}),h=await c.db.financialPeriod.findFirst({where:b.subAccountId?{subAccountId:b.subAccountId,OR:[{fiscalYear:d.fiscalYear,fiscalPeriod:{gt:d.fiscalPeriod}},{fiscalYear:{gt:d.fiscalYear}}]}:{agencyId:b.agencyId,subAccountId:null,OR:[{fiscalYear:d.fiscalYear,fiscalPeriod:{gt:d.fiscalPeriod}},{fiscalYear:{gt:d.fiscalYear}}]},orderBy:[{fiscalYear:"asc"},{fiscalPeriod:"asc"}]});await c.db.$transaction(async c=>{if(await c.financialPeriod.update({where:{id:a},data:{status:m.PeriodStatus.CLOSED,closedAt:new Date,closedBy:b.userId,updatedBy:b.userId}}),h)for(let a of g){let d=["ASSET","LIABILITY","EQUITY"].includes(a.Account.accountType)?a.closingBalance:0,e=await c.accountBalance.findFirst({where:{accountId:a.accountId,periodId:h.id}});e?await c.accountBalance.update({where:{id:e.id},data:{openingBalance:d}}):await c.accountBalance.create({data:{accountId:a.accountId,periodId:h.id,agencyId:b.subAccountId?null:b.agencyId,subAccountId:b.subAccountId||null,openingBalance:d,closingBalance:d,debitMovement:0,creditMovement:0}})}}),await (0,j.logGLAudit)({action:"UPDATE",entityType:"FinancialPeriod",entityId:a,agencyId:b.agencyId,subAccountId:b.subAccountId,description:`Period ${d.fiscalYear}-${d.fiscalPeriod} closed with carry forward`}),await (0,k.emitEvent)("fi.general_ledger",l.EVENT_KEYS.fi.general_ledger.periods.closed,{type:"FinancialPeriod",id:a},{amount:0,reference:`${d.fiscalYear}-${d.fiscalPeriod}`,description:d.name||"Period closed",metadata:{carryForwardApplied:!!h}});let i=b.subAccountId?`/subaccount/${b.subAccountId}/fi/general-ledger/periods`:`/agency/${b.agencyId}/fi/general-ledger/periods`;return(0,e.revalidatePath)(i),{success:!0,data:{message:"Period closed successfully"}}}catch(a){return console.error("Error in closePeriod:",a),{success:!1,error:"Failed to close period"}}},w=async(a,b)=>{try{let d=await o();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,f.hasSubAccountPermission)(d.subAccountId,"fi.configuration.fiscal_years.manage"):await (0,f.hasAgencyPermission)(d.agencyId,"fi.configuration.fiscal_years.manage")))return{success:!1,error:"Unauthorized: Missing permission to lock periods"};let g=await c.db.financialPeriod.findUnique({where:{id:a}});if(!g)return{success:!1,error:"Period not found"};if(g.status===m.PeriodStatus.LOCKED)return{success:!1,error:"Period is already locked"};if(g.status!==m.PeriodStatus.CLOSED)return{success:!1,error:"Period must be closed before locking"};let h=await c.db.financialPeriod.update({where:{id:a},data:{status:m.PeriodStatus.LOCKED,lockedAt:new Date,lockedBy:d.userId,updatedBy:d.userId}});await (0,j.logGLAudit)({action:"UPDATE",entityType:"FinancialPeriod",entityId:a,agencyId:d.agencyId,subAccountId:d.subAccountId,description:`Period ${g.fiscalYear}-${g.fiscalPeriod} locked`,reason:b}),await (0,k.emitEvent)("fi.general_ledger",l.EVENT_KEYS.fi.general_ledger.periods.locked,{type:"FinancialPeriod",id:a},{amount:0,reference:`${g.fiscalYear}-${g.fiscalPeriod}`,description:b||"Period locked"});let i=d.subAccountId?`/subaccount/${d.subAccountId}/fi/general-ledger/periods`:`/agency/${d.agencyId}/fi/general-ledger/periods`;return(0,e.revalidatePath)(i),{success:!0,data:h}}catch(a){return console.error("Error in lockPeriod:",a),{success:!1,error:"Failed to lock period"}}};(0,n.ensureServerEntryExports)([p,q,r,s,t,u,v,w]),(0,b.registerServerReference)(p,"406c5c262f8bd0dbdb8ad71f4829762fc58979ef1a",null),(0,b.registerServerReference)(q,"00e5fd16ba1705218cb3cbd5d6d5f2b83f45040021",null),(0,b.registerServerReference)(r,"00fc45cca34a14284145f9a665f300def744d0201a",null),(0,b.registerServerReference)(s,"40d1468c05ee3b0d35ae90530577cde053b3acdae2",null),(0,b.registerServerReference)(t,"40d53d68950c391dc500b44e5c7ca6c8e8598f3eb2",null),(0,b.registerServerReference)(u,"40645d3a6d5e1585850299936590f39a6d1abab326",null),(0,b.registerServerReference)(v,"4028235a8059e8a8bffc885d869fd39b2775949c58",null),(0,b.registerServerReference)(w,"60fd6a9cae2308c7c90f9eab68bbe5f8c549bb220a",null),a.s(["closePeriod",0,v,"createFinancialPeriod",0,s,"getCurrentOpenPeriod",0,q,"getFinancialPeriod",0,p,"listFinancialPeriods",0,r,"lockPeriod",0,w,"openPeriod",0,u,"updateFinancialPeriod",0,t],620876)},898683,a=>{"use strict";var b=a.i(137936),c=a.i(761469),d=a.i(577607),e=a.i(351728),f=a.i(537150);let g=["BANK","ACCOUNTS_RECEIVABLE","INVENTORY","PREPAID_EXPENSE","CURRENT_ASSET"],h=["FIXED_ASSET"],i=["OTHER_ASSET"],j=["ACCOUNTS_PAYABLE","CREDIT_CARD","ACCRUED_EXPENSE","CURRENT_LIABILITY"],k=["LONG_TERM_LIABILITY"],l=["OPERATING_REVENUE","SALES","SERVICE_REVENUE"],m=["OTHER_REVENUE"],n=["COST_OF_GOODS_SOLD"],o=["OPERATING_EXPENSE","ADMINISTRATIVE_EXPENSE"],p=["DEPRECIATION"],q=["OTHER_EXPENSE"];f.KEYS.fi.master_data.accounts.view,f.KEYS.fi.master_data.accounts.manage,f.KEYS.fi.general_ledger.journal_entries.read,f.KEYS.fi.general_ledger.journal_entries.create,f.KEYS.fi.general_ledger.journal_entries.update,f.KEYS.fi.general_ledger.journal_entries.delete,f.KEYS.fi.general_ledger.journal_entries.approve,f.KEYS.fi.configuration.fiscal_years.view,f.KEYS.fi.configuration.fiscal_years.manage,f.KEYS.fi.general_ledger.reports.view,f.KEYS.fi.general_ledger.reports.generate,f.KEYS.fi.general_ledger.reports.approve,f.KEYS.fi.general_ledger.settings.view,f.KEYS.fi.general_ledger.settings.manage,f.KEYS.fi.general_ledger.settings.setup,f.KEYS.fi.general_ledger.reconciliation.view,f.KEYS.fi.general_ledger.reconciliation.manage,f.KEYS.fi.general_ledger.reconciliation.clear,f.KEYS.fi.general_ledger.consolidation.view,f.KEYS.fi.general_ledger.consolidation.manage,f.KEYS.fi.general_ledger.year_end.view,f.KEYS.fi.general_ledger.year_end.manage,f.KEYS.fi.general_ledger.year_end.close,f.KEYS.fi.configuration.currencies.view,f.KEYS.fi.configuration.currencies.manage,f.KEYS.fi.configuration.tax_settings.view,f.KEYS.fi.configuration.tax_settings.manage,f.KEYS.fi.configuration.posting_rules.view,f.KEYS.fi.configuration.posting_rules.manage;var r=a.i(978561),s=a.i(713095);let t=async()=>{let a=await (0,d.auth)();if(!a?.user?.id)return null;let b=await c.db.session.findFirst({where:{userId:a.user.id},select:{activeAgencyId:!0,activeSubAccountId:!0}});return{userId:a.user.id,agencyId:b?.activeAgencyId??void 0,subAccountId:b?.activeSubAccountId??void 0}},u=async(a,b)=>{try{let d=await t();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,e.hasSubAccountPermission)(d.subAccountId,"fi.general_ledger.reports.generate"):await (0,e.hasAgencyPermission)(d.agencyId,"fi.general_ledger.reports.generate")))return{success:!1,error:"Unauthorized: Missing permission to generate reports"};let f=await c.db.financialPeriod.findUnique({where:{id:a}});if(!f)return{success:!1,error:"Financial period not found"};let g=await c.db.accountBalance.findMany({where:{periodId:a,...b?.currency&&{currency:b.currency}},include:{Account:{select:{id:!0,code:!0,name:!0,category:!0,accountType:!0,path:!0}}},orderBy:{Account:{path:"asc"}}}),h=b?.includeZeroBalances?g:g.filter(a=>0!==new r.default(a.closingBalance).toDecimalPlaces(2).toNumber()),i=0,j=0,k=h.map(a=>{let b=["ASSET","EXPENSE"].includes(a.Account.accountType)?"DEBIT":"CREDIT",c="DEBIT"===b&&new r.default(a.closingBalance).gte(0)||"CREDIT"===b&&new r.default(a.closingBalance).lt(0)?new r.default(a.closingBalance).abs().toNumber():0,d="CREDIT"===b&&new r.default(a.closingBalance).gte(0)||"DEBIT"===b&&new r.default(a.closingBalance).lt(0)?new r.default(a.closingBalance).abs().toNumber():0;return i+=c,j+=d,{accountId:a.accountId,accountCode:a.Account.code,accountName:a.Account.name,category:a.Account.category,accountType:a.Account.accountType,debitBalance:c,creditBalance:d,currency:a.currencyCode}}),l={reportType:"TRIAL_BALANCE",periodId:f.id,periodName:f.name,year:f.fiscalYear,periodNumber:f.fiscalPeriod,startDate:f.startDate,endDate:f.endDate,generatedAt:new Date,generatedBy:d.userId,currency:b?.currency||"USD",lines:k,totals:{totalDebits:i,totalCredits:j,difference:Math.abs(i-j),balanced:.01>Math.abs(i-j)}};return{success:!0,data:l}}catch(a){return console.error("Error in generateTrialBalance:",a),{success:!1,error:"Failed to generate trial balance"}}},v=async(a,b)=>{try{let d=await t();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,e.hasSubAccountPermission)(d.subAccountId,"fi.general_ledger.reports.generate"):await (0,e.hasAgencyPermission)(d.agencyId,"fi.general_ledger.reports.generate")))return{success:!1,error:"Unauthorized: Missing permission to generate reports"};let f=await c.db.financialPeriod.findUnique({where:{id:a}});if(!f)return{success:!1,error:"Financial period not found"};let l=await c.db.accountBalance.findMany({where:{periodId:a,Account:{accountType:{in:["ASSET","LIABILITY","EQUITY"]}},...b?.currency&&{currency:b.currency}},include:{Account:{select:{id:!0,code:!0,name:!0,category:!0,accountType:!0,path:!0,level:!0}}}}),m={currentAssets:l.filter(a=>"ASSET"===a.Account.accountType&&g.includes(a.Account.accountType)),fixedAssets:l.filter(a=>"ASSET"===a.Account.accountType&&h.includes(a.Account.accountType)),otherAssets:l.filter(a=>"ASSET"===a.Account.accountType&&i.includes(a.Account.accountType))},n={currentLiabilities:l.filter(a=>"LIABILITY"===a.Account.accountType&&j.includes(a.Account.accountType)),longTermLiabilities:l.filter(a=>"LIABILITY"===a.Account.accountType&&k.includes(a.Account.accountType))},o=l.filter(a=>"EQUITY"===a.Account.accountType),p=m.currentAssets.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),q=m.fixedAssets.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),s=m.otherAssets.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),u=p+q+s,v=n.currentLiabilities.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),w=n.longTermLiabilities.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),x=v+w,y=o.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),z={reportType:"BALANCE_SHEET",periodId:f.id,periodName:f.name,asOfDate:f.endDate,generatedAt:new Date,generatedBy:d.userId,currency:b?.currency||"USD",assets:{currentAssets:{accounts:m.currentAssets.map(a=>({code:a.Account.code,name:a.Account.name,balance:a.closingBalance,level:a.Account.level})),total:p},fixedAssets:{accounts:m.fixedAssets.map(a=>({code:a.Account.code,name:a.Account.name,balance:a.closingBalance,level:a.Account.level})),total:q},otherAssets:{accounts:m.otherAssets.map(a=>({code:a.Account.code,name:a.Account.name,balance:a.closingBalance,level:a.Account.level})),total:s},totalAssets:u},liabilities:{currentLiabilities:{accounts:n.currentLiabilities.map(a=>({code:a.Account.code,name:a.Account.name,balance:a.closingBalance,level:a.Account.level})),total:v},longTermLiabilities:{accounts:n.longTermLiabilities.map(a=>({code:a.Account.code,name:a.Account.name,balance:a.closingBalance,level:a.Account.level})),total:w},totalLiabilities:x},equity:{accounts:o.map(a=>({code:a.Account.code,name:a.Account.name,balance:a.closingBalance,level:a.Account.level})),totalEquity:y},totalLiabilitiesAndEquity:x+y,balanced:.01>Math.abs(u-(x+y))};return{success:!0,data:z}}catch(a){return console.error("Error in generateBalanceSheet:",a),{success:!1,error:"Failed to generate balance sheet"}}},w=async(a,b)=>{try{let d=await t();if(!d)return{success:!1,error:"Unauthorized: No session found"};if(!(d.subAccountId?await (0,e.hasSubAccountPermission)(d.subAccountId,"fi.general_ledger.reports.generate"):await (0,e.hasAgencyPermission)(d.agencyId,"fi.general_ledger.reports.generate")))return{success:!1,error:"Unauthorized: Missing permission to generate reports"};let f=await c.db.financialPeriod.findUnique({where:{id:a}});if(!f)return{success:!1,error:"Financial period not found"};let g=await c.db.accountBalance.findMany({where:{periodId:a,Account:{accountType:{in:["REVENUE","EXPENSE"]}},...b?.currency&&{currency:b.currency}},include:{Account:{select:{id:!0,code:!0,name:!0,category:!0,accountType:!0,path:!0,level:!0}}}}),h={operatingRevenue:g.filter(a=>"REVENUE"===a.Account.accountType&&l.includes(a.Account.accountType)),otherRevenue:g.filter(a=>"REVENUE"===a.Account.accountType&&m.includes(a.Account.accountType))},i={costOfGoodsSold:g.filter(a=>"EXPENSE"===a.Account.accountType&&n.includes(a.Account.accountType)),operatingExpenses:g.filter(a=>"EXPENSE"===a.Account.accountType&&o.includes(a.Account.accountType)),depreciation:g.filter(a=>"EXPENSE"===a.Account.accountType&&p.includes(a.Account.accountType)),otherExpenses:g.filter(a=>"EXPENSE"===a.Account.accountType&&q.includes(a.Account.accountType))},j=h.operatingRevenue.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),k=h.otherRevenue.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),s=j+k,u=i.costOfGoodsSold.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),v=s-u,w=i.operatingExpenses.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),x=i.depreciation.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),y=i.otherExpenses.reduce((a,b)=>new r.default(a).plus(b.closingBalance),new r.default(0)).toNumber(),z=u+w+x+y,A=s-z,B={reportType:"INCOME_STATEMENT",periodId:f.id,periodName:f.name,startDate:f.startDate,endDate:f.endDate,generatedAt:new Date,generatedBy:d.userId,currency:b?.currency||"USD",revenue:{operatingRevenue:{accounts:h.operatingRevenue.map(a=>({code:a.Account.code,name:a.Account.name,amount:new r.default(a.closingBalance).abs().toNumber(),level:a.Account.level})),total:j},otherRevenue:{accounts:h.otherRevenue.map(a=>({code:a.Account.code,name:a.Account.name,amount:new r.default(a.closingBalance).abs().toNumber(),level:a.Account.level})),total:k},totalRevenue:s},expenses:{costOfGoodsSold:{accounts:i.costOfGoodsSold.map(a=>({code:a.Account.code,name:a.Account.name,amount:new r.default(a.closingBalance).abs().toNumber(),level:a.Account.level})),total:u},grossProfit:v,operatingExpenses:{accounts:i.operatingExpenses.map(a=>({code:a.Account.code,name:a.Account.name,amount:new r.default(a.closingBalance).abs().toNumber(),level:a.Account.level})),total:w},depreciation:{accounts:i.depreciation.map(a=>({code:a.Account.code,name:a.Account.name,amount:new r.default(a.closingBalance).abs().toNumber(),level:a.Account.level})),total:x},otherExpenses:{accounts:i.otherExpenses.map(a=>({code:a.Account.code,name:a.Account.name,amount:new r.default(a.closingBalance).abs().toNumber(),level:a.Account.level})),total:y},totalExpenses:z},netIncome:A};return{success:!0,data:B}}catch(a){return console.error("Error in generateIncomeStatement:",a),{success:!1,error:"Failed to generate income statement"}}},x=async(a,b,d)=>{try{let f=await t();if(!f)return{success:!1,error:"Unauthorized: No session found"};if(!(f.subAccountId?await (0,e.hasSubAccountPermission)(f.subAccountId,"fi.general_ledger.reports.generate"):await (0,e.hasAgencyPermission)(f.agencyId,"fi.general_ledger.reports.generate")))return{success:!1,error:"Unauthorized: Missing permission to generate reports"};let g=await c.db.chartOfAccount.findUnique({where:{id:a}});if(!g)return{success:!1,error:"Account not found"};let h=await c.db.journalEntryLine.findMany({where:{accountId:a,JournalEntry:{entryDate:{gte:b,lte:d},status:"APPROVED"}},include:{JournalEntry:{select:{entryNumber:!0,entryDate:!0,description:!0,reference:!0}}},orderBy:{JournalEntry:{entryDate:"asc"}}}),i=new r.default(0),j=h.map(a=>(i=i.plus(a.debitAmount).minus(a.creditAmount),{date:a.JournalEntry.entryDate,entryNumber:a.JournalEntry.entryNumber,description:a.description,reference:a.JournalEntry.reference,debitAmount:a.debitAmount,creditAmount:a.creditAmount,balance:i.toNumber()})),k={reportType:"GENERAL_LEDGER",accountId:g.id,accountCode:g.code,accountName:g.name,category:g.category,startDate:b,endDate:d,generatedAt:new Date,generatedBy:f.userId,transactions:j,summary:{totalDebits:h.reduce((a,b)=>a.plus(b.debitAmount),new r.default(0)).toNumber(),totalCredits:h.reduce((a,b)=>a.plus(b.creditAmount),new r.default(0)).toNumber(),endingBalance:i.toNumber(),transactionCount:h.length}};return{success:!0,data:k}}catch(a){return console.error("Error in generateGeneralLedger:",a),{success:!1,error:"Failed to generate general ledger"}}};(0,s.ensureServerEntryExports)([u,v,w,x]),(0,b.registerServerReference)(u,"601f76f8ca9030e78b3decd9607951ddcd391f15f6",null),(0,b.registerServerReference)(v,"60e3adc004c07d493f9a884233f52b543cbec0ce03",null),(0,b.registerServerReference)(w,"6021a594df0ef4336031c4ef78ece30f8068a11ac7",null),(0,b.registerServerReference)(x,"703d39b2c9e3a3ed3fb9e353aa6d0fe9a7facb708b",null),a.s(["generateBalanceSheet",0,v,"generateGeneralLedger",0,x,"generateIncomeStatement",0,w,"generateTrialBalance",0,u],898683)}];

//# sourceMappingURL=src_lib_0f71ec4b._.js.map