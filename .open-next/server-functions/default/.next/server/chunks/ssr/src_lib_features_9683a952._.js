module.exports=[973831,537150,a=>{"use strict";a.i(155781);var b=a.i(761469);function c(a){return null==a?null:"string"==typeof a?a:a.toString()}let d=new Set(["ACTIVE","TRIALING"]),e="false"!==process.env.ENTITLEMENTS_SUBACCOUNT_INHERIT_AGENCY;async function f(a){if("SUBACCOUNT"!==a.scope)return!1;if(null!=a.inheritAgencyEntitlements)return!!a.inheritAgencyEntitlements;if(a.subAccountId){let c=await b.db.subAccountSettings.findUnique({where:{subAccountId:a.subAccountId},select:{entitlementsInheritFromAgency:!0}});if(c?.entitlementsInheritFromAgency!=null)return!!c.entitlementsInheritFromAgency}let c=await b.db.agencySettings.findUnique({where:{agencyId:a.agencyId},select:{entitlementsInheritToSubaccounts:!0}});return c?.entitlementsInheritToSubaccounts??e}async function g(a,c=new Date){let e=await b.db.subscription.findFirst({where:{agencyId:a,status:{in:Array.from(d)},currentPeriodEndDate:{gt:c}},select:{priceId:!0}});return e?.priceId??null}async function h(a,c=new Date){return Array.from(new Set([await g(a,c),...(await b.db.addOns.findMany({where:{agencyId:a,active:!0},select:{priceId:!0}})).map(a=>a.priceId)].filter(Boolean)))}function i(a,b){let c=a??null,d=b??null;return null==c&&null==d?null:(c??0)+(d??0)}function j(a,b){return null==a&&null==b?null:null==a?b:null==b?a:a.plus?.(b)??a}async function k(a){let d=a.now??new Date,e=a.planId,g=e?[e]:await h(a.agencyId,d);if(!g.length)return{};let k=await b.db.planFeature.findMany({where:{planId:{in:g}},include:{EntitlementFeature:!0}}),l=new Map;for(let a of k){let b=l.get(a.featureKey)??[];b.push(a),l.set(a.featureKey,b)}let m=[];for(let[,a]of l)m.push(1===a.length?a[0]:function(a){let b=a[0];if(!b)throw Error("mergePlanFeatures called with empty list");return{...b,isEnabled:a.some(a=>a.isEnabled),isUnlimited:a.some(a=>a.isUnlimited),includedInt:a.reduce((a,b)=>i(a,b.includedInt),null),maxInt:a.reduce((a,b)=>i(a,b.maxInt),null),includedDec:a.reduce((a,b)=>j(a,b.includedDec),null),maxDec:a.reduce((a,b)=>j(a,b.maxDec),null),recurringCreditGrantInt:a.reduce((a,b)=>i(a,b.recurringCreditGrantInt),null),recurringCreditGrantDec:a.reduce((a,b)=>j(a,b.recurringCreditGrantDec),null),rolloverCredits:a.some(a=>a.rolloverCredits),topUpEnabled:a.some(a=>a.topUpEnabled),topUpPriceId:a.find(a=>a.topUpPriceId)?.topUpPriceId??b.topUpPriceId,enforcement:a.some(a=>"HARD"===a.enforcement)?"HARD":b.enforcement,overageMode:b.overageMode,overageFee:b.overageFee,stripeOveragePriceId:b.stripeOveragePriceId}}(a));let n=await f(a)?await b.db.entitlementOverride.findMany({where:{scope:"AGENCY",agencyId:a.agencyId,subAccountId:null,startsAt:{lte:d},OR:[{endsAt:null},{endsAt:{gte:d}}]}}):[],o=await b.db.entitlementOverride.findMany({where:{scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId||null,startsAt:{lte:d},OR:[{endsAt:null},{endsAt:{gte:d}}]}}),p=[...n,...o],q=new Map;for(let a of n)q.set(a.featureKey,a);for(let a of o)q.set(a.featureKey,a);let r={};for(let a of m)r[a.featureKey]=function(a,b){let d=a.EntitlementFeature,e=(b?.isEnabled??!0)&&a.isEnabled,f=b?.isUnlimited??a.isUnlimited,g=a.maxInt??null,h=b?.maxOverrideInt!=null?b.maxOverrideInt:null!=g?g+(b?.maxDeltaInt??0):null,i=null!=a.maxDec?c(a.maxDec):null,j=b?.maxOverrideDec!=null?c(b.maxOverrideDec):null!=i?c(a.maxDec.plus?.(b?.maxDeltaDec??0)??a.maxDec):null;return{featureKey:a.featureKey,name:d.name,category:d.category,description:d.description,valueType:d.valueType,unit:d.unit,metering:d.metering,aggregation:d.aggregation,scope:d.scope,period:d.period,isEnabled:e,isUnlimited:f,includedInt:a.includedInt??null,maxInt:h,includedDec:null!=a.includedDec?c(a.includedDec):null,maxDec:j,enforcement:a.enforcement,overageMode:a.overageMode,creditEnabled:d.creditEnabled,creditUnit:d.creditUnit??null,creditExpires:d.creditExpires,creditPriority:d.creditPriority,recurringCreditGrantInt:a.recurringCreditGrantInt??null,recurringCreditGrantDec:null!=a.recurringCreditGrantDec?c(a.recurringCreditGrantDec):null,rolloverCredits:a.rolloverCredits,topUpEnabled:a.topUpEnabled,topUpPriceId:a.topUpPriceId??null}}(a,q.get(a.featureKey)||null);for(let a of p){if(r[a.featureKey])continue;let c=await b.db.entitlementFeature.findUnique({where:{key:a.featureKey}});c&&(r[a.featureKey]={featureKey:c.key,name:c.name,category:c.category,description:c.description,valueType:c.valueType,unit:c.unit,metering:c.metering,aggregation:c.aggregation,scope:c.scope,period:c.period,isEnabled:a.isEnabled??!1,isUnlimited:a.isUnlimited??!1,includedInt:0,maxInt:a.maxOverrideInt??a.maxDeltaInt??null,includedDec:"0",maxDec:a.maxOverrideDec?a.maxOverrideDec.toString():a.maxDeltaDec?a.maxDeltaDec.toString():null,enforcement:"HARD",overageMode:"NONE",creditEnabled:c.creditEnabled,creditUnit:c.creditUnit??null,creditExpires:c.creditExpires,creditPriority:c.creditPriority,recurringCreditGrantInt:null,recurringCreditGrantDec:null,rolloverCredits:!1,topUpEnabled:!1,topUpPriceId:null})}return r}a.s(["resolveEffectiveEntitlements",()=>k],973831),a.s(["KEYS",0,{core:{organization:{profile:{view:"core.organization.profile.view",manage:"core.organization.profile.manage"},security:{view:"core.organization.security.view",manage:"core.organization.security.manage"},integrations:{view:"core.organization.integrations.view",manage:"core.organization.integrations.manage"},automation:{view:"core.organization.automation.view",manage:"core.organization.automation.manage"}},agency:{account:{read:"core.agency.account.read",update:"core.agency.account.update",delete:"core.agency.account.delete"},subaccounts:{read:"core.agency.subaccounts.read",create:"core.agency.subaccounts.create",update:"core.agency.subaccounts.update",delete:"core.agency.subaccounts.delete"},team_member:{invite:"core.agency.team_member.invite",remove:"core.agency.team_member.remove",manage:"core.agency.team_member.manage"},settings:{view:"core.agency.settings.view",manage:"core.agency.settings.manage"},storage:{view:"core.agency.storage.view",manage:"core.agency.storage.manage"}},billing:{account:{view:"core.billing.account.view",manage:"core.billing.account.manage"},payment_methods:{read:"core.billing.payment_methods.read",create:"core.billing.payment_methods.create",delete:"core.billing.payment_methods.delete"},subscription:{view:"core.billing.subscription.view",manage:"core.billing.subscription.manage"},features:{manage:"core.billing.features.manage"},usage:{view:"core.billing.usage.view",consume:"core.billing.usage.consume"},entitlements:{view:"core.billing.entitlements.view"},credits:{view:"core.billing.credits.view"},rebilling:{manage:"core.billing.rebilling.manage"},priority_support:{view:"core.billing.priority_support.view"}},subaccount:{account:{read:"core.subaccount.account.read",update:"core.subaccount.account.update",delete:"core.subaccount.account.delete"},team_member:{invite:"core.subaccount.team_member.invite",remove:"core.subaccount.team_member.remove"}},experimental:{flag:{toggle:"core.experimental.flag.toggle"}},apps:{app:{view:"core.apps.app.view",install:"core.apps.app.install",manage:"core.apps.app.manage",uninstall:"core.apps.app.uninstall"},webhooks:{manage:"core.apps.webhooks.manage",view:"core.apps.webhooks.view"},api_keys:{read:"core.apps.api_keys.read",create:"core.apps.api_keys.create",delete:"core.apps.api_keys.delete"}},support:{tickets:{view:"core.support.tickets.view",create:"core.support.tickets.create",update:"core.support.tickets.update",close:"core.support.tickets.close"},diagnostics:{run:"core.support.diagnostics.run"}}},iam:{authZ:{roles:{read:"iam.authZ.roles.read",create:"iam.authZ.roles.create",update:"iam.authZ.roles.update",delete:"iam.authZ.roles.delete"},permissions:{view:"iam.authZ.permissions.view"},members:{assign:"iam.authZ.members.assign",revoke:"iam.authZ.members.revoke"}}},fi:{configuration:{fiscal_years:{view:"fi.configuration.fiscal_years.view",manage:"fi.configuration.fiscal_years.manage"},currencies:{view:"fi.configuration.currencies.view",manage:"fi.configuration.currencies.manage"},tax_settings:{view:"fi.configuration.tax_settings.view",manage:"fi.configuration.tax_settings.manage"},tolerances:{view:"fi.configuration.tolerances.view",manage:"fi.configuration.tolerances.manage"},number_ranges:{view:"fi.configuration.number_ranges.view",manage:"fi.configuration.number_ranges.manage"},posting_rules:{view:"fi.configuration.posting_rules.view",manage:"fi.configuration.posting_rules.manage",simulate:"fi.configuration.posting_rules.simulate"}},master_data:{accounts:{view:"fi.master_data.accounts.view",manage:"fi.master_data.accounts.manage"},customers:{view:"fi.master_data.customers.view",manage:"fi.master_data.customers.manage"},vendors:{view:"fi.master_data.vendors.view",manage:"fi.master_data.vendors.manage"},banks:{view:"fi.master_data.banks.view",manage:"fi.master_data.banks.manage"}},general_ledger:{accounts:{view:"fi.general_ledger.accounts.view",manage:"fi.general_ledger.accounts.manage"},subledgers:{view:"fi.general_ledger.subledgers.view",allocate:"fi.general_ledger.subledgers.allocate",manage:"fi.general_ledger.subledgers.manage"},balances:{view:"fi.general_ledger.balances.view",recalculate:"fi.general_ledger.balances.recalculate",rollforward:"fi.general_ledger.balances.rollforward"},settings:{view:"fi.general_ledger.settings.view",manage:"fi.general_ledger.settings.manage",setup:"fi.general_ledger.settings.setup"},journal_entries:{read:"fi.general_ledger.journal_entries.read",create:"fi.general_ledger.journal_entries.create",update:"fi.general_ledger.journal_entries.update",submit:"fi.general_ledger.journal_entries.submit",delete:"fi.general_ledger.journal_entries.delete",reverse:"fi.general_ledger.journal_entries.reverse",reject:"fi.general_ledger.journal_entries.reject",approve:"fi.general_ledger.journal_entries.approve"},reports:{view:"fi.general_ledger.reports.view",generate:"fi.general_ledger.reports.generate",approve:"fi.general_ledger.reports.approve",export:"fi.general_ledger.reports.export"},consolidation:{view:"fi.general_ledger.consolidation.view",manage:"fi.general_ledger.consolidation.manage"},year_end:{view:"fi.general_ledger.year_end.view",manage:"fi.general_ledger.year_end.manage",close:"fi.general_ledger.year_end.close"},reconciliation:{view:"fi.general_ledger.reconciliation.view",manage:"fi.general_ledger.reconciliation.manage",clear:"fi.general_ledger.reconciliation.clear",reset:"fi.general_ledger.reconciliation.reset"}},accounts_receivable:{subledgers:{view:"fi.accounts_receivable.subledgers.view",allocate:"fi.accounts_receivable.subledgers.allocate",manage:"fi.accounts_receivable.subledgers.manage"}},accounts_payable:{subledgers:{view:"fi.accounts_payable.subledgers.view",allocate:"fi.accounts_payable.subledgers.allocate",manage:"fi.accounts_payable.subledgers.manage"}},bank_ledger:{bank_accounts:{view:"fi.bank_ledger.bank_accounts.view",manage:"fi.bank_ledger.bank_accounts.manage"},subledgers:{view:"fi.bank_ledger.subledgers.view",allocate:"fi.bank_ledger.subledgers.allocate",manage:"fi.bank_ledger.subledgers.manage"}},controlling:{cost_centers:{view:"fi.controlling.cost_centers.view",manage:"fi.controlling.cost_centers.manage"}},advanced_reporting:{financial_statements:{view:"fi.advanced_reporting.financial_statements.view",generate:"fi.advanced_reporting.financial_statements.generate"},custom_reports:{view:"fi.advanced_reporting.custom_reports.view",create:"fi.advanced_reporting.custom_reports.create",update:"fi.advanced_reporting.custom_reports.update",delete:"fi.advanced_reporting.custom_reports.delete"}}},crm:{customers:{contact:{read:"crm.customers.contact.read",create:"crm.customers.contact.create",update:"crm.customers.contact.update",delete:"crm.customers.contact.delete"},billing:{read:"crm.customers.billing.read",create:"crm.customers.billing.create",update:"crm.customers.billing.update",delete:"crm.customers.billing.delete"}},media:{file:{read:"crm.media.file.read",create:"crm.media.file.create",delete:"crm.media.file.delete"}},funnels:{content:{read:"crm.funnels.content.read",create:"crm.funnels.content.create",update:"crm.funnels.content.update",delete:"crm.funnels.content.delete",publish:"crm.funnels.content.publish"}},pipelines:{lane:{read:"crm.pipelines.lane.read",create:"crm.pipelines.lane.create",update:"crm.pipelines.lane.update",delete:"crm.pipelines.lane.delete"},ticket:{read:"crm.pipelines.ticket.read",create:"crm.pipelines.ticket.create",update:"crm.pipelines.ticket.update",delete:"crm.pipelines.ticket.delete"},tag:{read:"crm.pipelines.tag.read",create:"crm.pipelines.tag.create",update:"crm.pipelines.tag.update",delete:"crm.pipelines.tag.delete"}}},co:{cost_centers:{master_data:{read:"co.cost_centers.master_data.read",create:"co.cost_centers.master_data.create",update:"co.cost_centers.master_data.update",delete:"co.cost_centers.master_data.delete"},hierarchy:{view:"co.cost_centers.hierarchy.view",manage:"co.cost_centers.hierarchy.manage"},allocations:{view:"co.cost_centers.allocations.view",execute:"co.cost_centers.allocations.execute"},reports:{view:"co.cost_centers.reports.view",generate:"co.cost_centers.reports.generate"}},profit_centers:{master_data:{read:"co.profit_centers.master_data.read",create:"co.profit_centers.master_data.create",update:"co.profit_centers.master_data.update",delete:"co.profit_centers.master_data.delete"},hierarchy:{view:"co.profit_centers.hierarchy.view",manage:"co.profit_centers.hierarchy.manage"},reports:{view:"co.profit_centers.reports.view",generate:"co.profit_centers.reports.generate"}},internal_orders:{master_data:{read:"co.internal_orders.master_data.read",create:"co.internal_orders.master_data.create",update:"co.internal_orders.master_data.update",close:"co.internal_orders.master_data.close"},settlement:{view:"co.internal_orders.settlement.view",execute:"co.internal_orders.settlement.execute"}},profitability:{segments:{view:"co.profitability.segments.view",manage:"co.profitability.segments.manage"},reports:{view:"co.profitability.reports.view",generate:"co.profitability.reports.generate"}},budgets:{planning:{view:"co.budgets.planning.view",create:"co.budgets.planning.create",update:"co.budgets.planning.update",approve:"co.budgets.planning.approve"},monitoring:{view:"co.budgets.monitoring.view",alerts:"co.budgets.monitoring.alerts"}}}}],537150)},351728,829816,17764,a=>{"use strict";a.i(155781);var b=a.i(577607),c=a.i(761469),d=a.i(973831),e=a.i(537150);function f(){let a=[];return!function a(b,c){if(b&&"object"==typeof b)for(let d of Object.values(b))"string"==typeof d?c.push(d):d&&"object"==typeof d&&a(d,c)}(e.KEYS,a),Array.from(new Set(a)).sort((a,b)=>a.localeCompare(b)).map(a=>{var b;let c,d,e;return{key:a,name:(d=(c=(b=a).split("."))[c.length-1]??b,e=c[c.length-2]??"",`${e} ${d}`.trim().replace(/[-_]/g," ").replace(/\b\w/g,a=>a.toUpperCase())),description:null,category:a.split(".").slice(0,2).join("."),isSystem:!0}})}a.s(["getPermissionCatalogSeeds",()=>f],829816);let g=[{prefix:"core.agency.",requireAny:["core.agency.account"]},{prefix:"core.billing.",requireAll:["core.agency.account"]},{prefix:"iam.authZ.",requireAnyAll:[["core.agency.account"],["core.subaccount.account"]]},{prefix:"core.subaccount.",requireAny:["core.agency.subaccounts","core.subaccount.account"]},{prefix:"core.apps.",requireAny:["core.apps.api_keys","core.apps.app","core.apps.webhooks"]},{prefix:"core.billing.priority_support.",requireAny:["core.billing.priority_support"]},{prefix:"core.billing.rebilling.",requireAny:["crm.customers.billing"]},{prefix:"crm.customers.contact.",requireAny:["crm.customers.contact"]},{prefix:"crm.customers.billing.",requireAny:["crm.customers.billing"]},{prefix:"crm.funnels.content.",requireAny:["crm.funnels.content"]},{prefix:"crm.pipelines.lane.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.pipelines.ticket.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.pipelines.tag.",requireAny:["crm.pipelines.lane"]},{prefix:"crm.media.file.",requireAny:["crm.media.file"]},{prefix:"fi.configuration.",requireAny:["fi.general_ledger.settings","fi.accounts_receivable.subledgers","fi.accounts_payable.subledgers","fi.bank_ledger.bank_accounts","fi.controlling.cost_centers","fi.advanced_reporting.financial_statements"]},{prefix:"fi.general_ledger.",requireAny:["fi.general_ledger.settings"]},{prefix:"fi.accounts_receivable.",requireAny:["fi.accounts_receivable.subledgers"]},{prefix:"fi.accounts_payable.",requireAny:["fi.accounts_payable.subledgers"]},{prefix:"fi.bank_ledger.",requireAny:["fi.bank_ledger.bank_accounts"]},{prefix:"fi.controlling.",requireAny:["fi.controlling.cost_centers"]},{prefix:"fi.advanced_reporting.",requireAny:["fi.advanced_reporting.financial_statements"]},{prefix:"co.cost_centers.",requireAny:["co.cost_centers.master_data"]},{prefix:"co.profit_centers.",requireAny:["co.profit_centers.master_data"]},{prefix:"co.internal_orders.",requireAny:["co.internal_orders.master_data"]},{prefix:"co.profitability.",requireAny:["co.profitability.segments"]},{prefix:"co.budgets.",requireAny:["co.budgets.planning"]}];function h(a){if(!a)return!1;if("BOOLEAN"===a.valueType)return a.isEnabled;if(!a.isEnabled)return!1;if(a.isUnlimited||(a.maxInt??a.includedInt??0)>0)return!0;let b=parseFloat(a.maxDec??a.includedDec??"0");return Number.isFinite(b)&&b>0}function i(a,b){let c=function(a){let b=null;for(let c of g)a.startsWith(c.prefix)&&(!b||c.prefix.length>b.prefix.length)&&(b=c);return b}(a);if(!c)return!(a.startsWith("fi.")||a.startsWith("co."));if(c.requireAll?.length){for(let a of c.requireAll)if(!h(b[a]))return!1}return(!c.requireAnyAll?.length||!!c.requireAnyAll.some(a=>a.every(a=>h(b[a]))))&&(!c.requireAny?.length||c.requireAny.some(a=>h(b[a])))}a.s(["isPermissionAssignable",()=>i],17764);let j=async()=>{let a=await (0,b.auth)(),d=a?.user?.id;return d?c.db.user.findUnique({where:{id:d},include:{AgencyMemberships:{where:{isActive:!0},include:{Agency:!0,Role:{include:{Permissions:{where:{granted:!0},include:{Permission:!0}}}}}},SubAccountMemberships:{where:{isActive:!0},include:{SubAccount:!0,Role:{include:{Permissions:{where:{granted:!0},include:{Permission:!0}}}}}}}}):null},k=async()=>{let a=await j();if(!a)return[];let b=a.AgencyMemberships.flatMap(a=>a.Role.Permissions.map(a=>a.Permission)),c=a.SubAccountMemberships.flatMap(a=>a.Role.Permissions.map(a=>a.Permission)),d={};for(let a of[...b,...c])d[a.key]=a;return Object.keys(d).map(a=>d[a])},l=async()=>(await k()).map(a=>a.key),m=async a=>{let b=a.trim();return(await l()).includes(b)},n=async a=>{let b=await j();if(!b)return[];let c=b.AgencyMemberships.find(b=>b.agencyId===a);return c?c.Role.Permissions.map(a=>a.Permission.key):[]},o=async a=>{let b=await j();if(!b)return[];let c=b.SubAccountMemberships.find(b=>b.subAccountId===a);return c?c.Role.Permissions.map(a=>a.Permission.key):[]},p=async(a,b)=>{let c=b.trim();return(await n(a)).includes(c)},q=async(a,b)=>{let c=b.trim();return(await o(a)).includes(c)},r=async(a,b)=>{let e=await (0,d.resolveEffectiveEntitlements)({scope:"SUBACCOUNT"===b?"SUBACCOUNT":"AGENCY",agencyId:a,subAccountId:null}),g="AGENCY"===b?["core.agency.","core.billing.","core.apps.","core.experimental.","crm.","fi."]:["core.subaccount.","crm.","fi."],h=f().filter(a=>g.some(b=>a.key.startsWith(b))).filter(a=>i(a.key,e));await c.db.permission.createMany({data:h.map(a=>({key:a.key,name:a.name,description:a.description,category:a.category,isSystem:a.isSystem})),skipDuplicates:!0});let j=await c.db.permission.findMany({where:{key:{in:h.map(a=>a.key)}},orderBy:[{category:"asc"},{key:"asc"}]}),k={};for(let a of j)k[a.category]||(k[a.category]=[]),k[a.category].push(a);return k},s=async(a,b)=>Object.values(await r(a,b)).flat().map(a=>a.key),t=async(a,b,c)=>{let d=new Set(await s(a,b)),e=c.filter(a=>!d.has(a));return{valid:0===e.length,invalidKeys:e}},u=async()=>{let a=await j();if(!a)return[];let b=[],c=new Map;for(let b of a.SubAccountMemberships){let a=b.SubAccount,d=a.agencyId,e={id:a.id,name:a.name,logo:a.subAccountLogo||void 0,type:"subaccount"};c.has(d)||c.set(d,[]),c.get(d).push(e)}for(let d of a.AgencyMemberships){let a=d.Agency,e=c.get(a.id)||[];b.push({id:a.id,name:a.name,logo:a.agencyLogo||void 0,type:"agency",subaccounts:e.length>0?e:void 0})}return b};a.s(["getAgencyPermissionKeys",0,n,"getAuthUserMemberships",0,j,"getEntitledPermissionKeys",0,s,"getEntitledPermissions",0,r,"getSubAccountPermissionKeys",0,o,"getUserAccessibleTeams",0,u,"getUserPermissionKeys",0,l,"getUserPermissions",0,k,"hasAgencyPermission",0,p,"hasPermission",0,m,"hasSubAccountPermission",0,q,"validatePermissionKeys",0,t],351728)}];

//# sourceMappingURL=src_lib_features_9683a952._.js.map