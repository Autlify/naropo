module.exports=[575043,a=>{"use strict";var b=a.i(137936),c=a.i(761469),d=a.i(577607),e=a.i(118558),f=a.i(53112),g=a.i(973831),h=a.i(829816),i=a.i(17764),j=a.i(713095);async function k(a){let b=await (0,g.resolveEffectiveEntitlements)({scope:a.scope,agencyId:a.agencyId,subAccountId:a.subAccountId});return new Set((0,h.getPermissionCatalogSeeds)().filter(a=>(0,i.isPermissionAssignable)(a.key,b)).map(a=>a.key))}async function l(a){let b=await c.db.permission.findMany({where:{id:{in:a.permissionIds}},select:{id:!0,key:!0}});if(b.length!==a.permissionIds.length)return{ok:!1,error:"One or more selected permissions are invalid."};let d=await k({agencyId:a.agencyId,subAccountId:a.subAccountId,scope:a.scope});return b.map(a=>a.key).filter(a=>!d.has(a)).length?{ok:!1,error:"Some selected permissions are not available under your current plan/add-ons."}:{ok:!0}}let m=f.z.object({name:f.z.string().min(2,"Name must be at least 2 characters").max(50),permissionIds:f.z.array(f.z.string()).min(1,"At least one permission required"),scope:f.z.enum(["AGENCY","SUBACCOUNT"]).default("AGENCY")}),n=f.z.object({name:f.z.string().min(2).max(50).optional(),permissionIds:f.z.array(f.z.string()).optional()}),o={Permissions:{include:{Permission:!0}},_count:{select:{AgencyMemberships:!0,SubAccountMemberships:!0}}};async function p(a){try{let b=await (0,d.auth)();if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let e=await c.db.role.findMany({where:{OR:[{isSystem:!0},{agencyId:a}]},include:o,orderBy:[{isSystem:"desc"},{name:"asc"}]});return{success:!0,data:e}}catch(a){return console.error("Error listing roles:",a),{success:!1,error:"Failed to load roles"}}}async function q(a){try{let b=await (0,d.auth)();if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let e=await c.db.role.findUnique({where:{id:a},include:o});if(!e)return{success:!1,error:"Role not found"};return{success:!0,data:e}}catch(a){return console.error("Error getting role:",a),{success:!1,error:"Failed to load role"}}}async function r(){try{let a=await c.db.permission.findMany({orderBy:{key:"asc"}});return{success:!0,data:a}}catch(a){return console.error("Error listing permissions:",a),{success:!1,error:"Failed to load permissions"}}}async function s(a,b){try{let f=await (0,d.auth)();if(!f?.user?.id)return{success:!1,error:"Unauthorized"};let g=m.safeParse(b);if(!g.success)return{success:!1,error:g.error.issues[0]?.message??"Invalid input"};if(await c.db.role.findFirst({where:{name:g.data.name,OR:[{isSystem:!0},{agencyId:a}]}}))return{success:!1,error:"A role with this name already exists"};let h=await l({agencyId:a,subAccountId:null,scope:g.data.scope,permissionIds:g.data.permissionIds});if(!h.ok)return{success:!1,error:h.error};let i=await c.db.$transaction(async b=>{let c=await b.role.create({data:{name:g.data.name,scope:g.data.scope,isSystem:!1,agencyId:a}});return await b.rolePermission.createMany({data:g.data.permissionIds.map(a=>({roleId:c.id,permissionId:a,granted:!0}))}),b.role.findUnique({where:{id:c.id},include:o})});if(!i)return{success:!1,error:"Failed to create role"};return(0,e.revalidatePath)(`/agency/${a}/settings/roles`),{success:!0,data:i}}catch(a){return console.error("Error creating role:",a),{success:!1,error:"Failed to create role"}}}async function t(a,b){try{let f=await (0,d.auth)();if(!f?.user?.id)return{success:!1,error:"Unauthorized"};let g=await c.db.role.findUnique({where:{id:a}});if(!g)return{success:!1,error:"Role not found"};if(g.isSystem)return{success:!1,error:"System roles cannot be modified"};let h=n.safeParse(b);if(!h.success)return{success:!1,error:h.error.issues[0]?.message??"Invalid input"};if(h.data.permissionIds){if(!g.agencyId)return{success:!1,error:"Missing agency context"};let a=await l({agencyId:g.agencyId,subAccountId:g.subAccountId??null,scope:g.scope,permissionIds:h.data.permissionIds});if(!a.ok)return{success:!1,error:a.error}}if(h.data.name&&h.data.name!==g.name&&await c.db.role.findFirst({where:{name:h.data.name,OR:[{isSystem:!0},{agencyId:g.agencyId}],NOT:{id:a}}}))return{success:!1,error:"A role with this name already exists"};let i=await c.db.$transaction(async b=>(h.data.name&&await b.role.update({where:{id:a},data:{name:h.data.name}}),h.data.permissionIds&&(await b.rolePermission.deleteMany({where:{roleId:a}}),await b.rolePermission.createMany({data:h.data.permissionIds.map(b=>({roleId:a,permissionId:b,granted:!0}))})),b.role.findUnique({where:{id:a},include:o})));if(!i)return{success:!1,error:"Failed to update role"};return(0,e.revalidatePath)(`/agency/${g.agencyId}/settings/roles`),{success:!0,data:i}}catch(a){return console.error("Error updating role:",a),{success:!1,error:"Failed to update role"}}}async function u(a){try{let b=await (0,d.auth)();if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=await c.db.role.findUnique({where:{id:a},include:{_count:{select:{AgencyMemberships:!0,SubAccountMemberships:!0}}}});if(!f)return{success:!1,error:"Role not found"};if(f.isSystem)return{success:!1,error:"System roles cannot be deleted"};let g=f._count.AgencyMemberships+f._count.SubAccountMemberships;if(g>0)return{success:!1,error:`Cannot delete role: ${g} user(s) are assigned to this role`};return await c.db.role.delete({where:{id:a}}),(0,e.revalidatePath)(`/agency/${f.agencyId}/settings/roles`),{success:!0,data:void 0}}catch(a){return console.error("Error deleting role:",a),{success:!1,error:"Failed to delete role"}}}async function v(a){try{if("string"==typeof a)return y(a);if(a?.agencyId||a?.subAccountId)return w(a);let b=(await c.db.permission.findMany({orderBy:{key:"asc"}})).reduce((a,b)=>{let c=b.key.split(".").slice(0,2).join(".");return a[c]||(a[c]=[]),a[c].push(b),a},{}),d=Object.entries(b).sort(([a],[b])=>a.localeCompare(b)).map(([a,b])=>({category:z(a),permissions:b}));return{success:!0,data:d}}catch(a){return console.error("Error getting permissions:",a),{success:!1,error:"Failed to load permissions"}}}async function w(a){try{let b=await (0,d.auth)();if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let e=a.agencyId??null,f=a.subAccountId??null;if(!e&&f){let a=await c.db.subAccount.findUnique({where:{id:f},select:{agencyId:!0}});e=a?.agencyId??null}if(!e)return{success:!1,error:"Missing agency context"};let j=f?"SUBACCOUNT":"AGENCY",k=await (0,g.resolveEffectiveEntitlements)({scope:j,agencyId:e,subAccountId:f}),l=(0,h.getPermissionCatalogSeeds)().filter(a=>(0,i.isPermissionAssignable)(a.key,k));await c.db.permission.createMany({data:l.map(a=>({key:a.key,name:a.name,description:a.description,category:a.category,isSystem:a.isSystem})),skipDuplicates:!0});let m=(await c.db.permission.findMany({where:{key:{in:l.map(a=>a.key)}},orderBy:{key:"asc"}})).reduce((a,b)=>{let c=b.key.split(".").slice(0,2).join(".");return a[c]||(a[c]=[]),a[c].push(b),a},{}),n=Object.entries(m).sort(([a],[b])=>a.localeCompare(b)).map(([a,b])=>({category:z(a),permissions:b}));return{success:!0,data:n}}catch(a){return console.error("Error getting context-aware permissions:",a),{success:!1,error:"Failed to load permissions"}}}async function x(a){return w({agencyId:a,subAccountId:null})}async function y(a){return w({subAccountId:a})}function z(a){return({"core.agency":"Core - Agency","core.subaccount":"Core - SubAccounts","core.billing":"Billing","core.apps":"Apps",crm:"CRM",fi:"FI","fi.general_ledger":"FI - General Ledger","fi.accounts_receivable":"FI - Accounts Receivable","fi.accounts_payable":"FI - Accounts Payable","fi.bank_ledger":"FI - Bank Ledger","co.controlling":"FI - Controlling","fi.advanced_reporting":"FI - Advanced Reporting",co:"CO - Controlling","co.cost_centers":"CO - Cost Centers","co.profit_centers":"CO - Profit Centers","co.internal_orders":"CO - Internal Orders","co.profitability":"CO - Profitability Analysis","co.budgets":"CO - Budgeting",iam:"IAM - Security"})[a]??a.replace(/\./g," - ").replace(/\b\w/g,a=>a.toUpperCase())}(0,j.ensureServerEntryExports)([p,q,r,s,t,u,v,w,x,y]),(0,b.registerServerReference)(p,"4058dd16912221e47a0e54216aa0630605d7010e35",null),(0,b.registerServerReference)(q,"409f71f693b0cc160f33a3d48a4870a8c238a815d5",null),(0,b.registerServerReference)(r,"00d17e12be283e5ca9341259453ff188dd97e575a3",null),(0,b.registerServerReference)(s,"6011a8992cb92945c217ee1eca1e244c9bf9fe7c6e",null),(0,b.registerServerReference)(t,"606d1b955de2203579b8b8270c5546fce95a1461c3",null),(0,b.registerServerReference)(u,"400a6a038a8108a9da1d56cec4b0de0a39efc5261b",null),(0,b.registerServerReference)(v,"407211c770e8ae4b42fae1866fa9494bcbe94c0003",null),(0,b.registerServerReference)(w,"409ad3b3d19f7e1e4b96a99490fd6a8f2f69159dfc",null),(0,b.registerServerReference)(x,"406c5fc4251144c4ed24b6fb601d2010b42f4f4a7e",null),(0,b.registerServerReference)(y,"40ac5af3373e707fb53a5046ad1b5bc92d948561f4",null),a.s(["createRole",()=>s,"deleteRole",()=>u,"getAvailablePermissions",()=>v,"getAvailablePermissionsForAgency",()=>x,"getAvailablePermissionsForContext",()=>w,"getAvailablePermissionsForSubAccount",()=>y,"getRole",()=>q,"listPermissions",()=>r,"listRoles",()=>p,"updateRole",()=>t])},135522,a=>{"use strict";var b=a.i(284293),c=a.i(432382),d=a.i(575043);a.s([],679215),a.i(679215),a.s(["00121e97931d9a4f99fbe5da76676391493c4ec18c",()=>b.verifyAndAcceptInvitation,"0085a00c6e3882da3f3532121d4d0f0c8e98e0ae91",()=>b.getContextCookie,"00d17e12be283e5ca9341259453ff188dd97e575a3",()=>d.listPermissions,"00d1e8c27b8f6f54414802ce4b8fc7cfdbce5b4072",()=>b.getAuthUserDetails,"00eb944583ea591ee145229315ee390560fc4be970",()=>b.getCurrentContext,"4000a997fefb2b5cd7eb5f4e1aace7ff799d2427d4",()=>b.getSubAccountTeamMembers,"4002ce7c5ea6735417b087e10031e0ea33f6838d22",()=>b.deleteUser,"40063e45a01fcbc9e1bad18991a61b168bb0aea8b1",()=>c.getSubscriptionData,"4006f01b4e847c437e1e92fb45879e9d2806c02495",()=>b.validateVerificationToken,"400a6a038a8108a9da1d56cec4b0de0a39efc5261b",()=>d.deleteRole,"400d5f4a1272855c23eaca0e9c3960ca2a9bfd3a10",()=>b.searchContacts,"400e4316b3f57301b5e594a2e827f77a092945f2fa",()=>b.getUserMemberships,"400e4d995979460cf4c84b25cb2d9f8149e51e230a",()=>b.getFunnels,"4014c9591be641133de4f09250ca37ca31dc6f9929",()=>b.getTagsForSubaccount,"4014e99c6800051bb437e2f35bba1024ed9917f9c2",()=>b.upsertContact,"40195b66d4003b3fdd3542076c1d8b58dddd07d62e",()=>b.getFunnelPageDetails,"402610482e5fc3d72c96aa6c8c6e018c70b5590893",()=>b.getUserPermissionsList,"402aba20b8841516050068f50a35c5452d70042696",()=>b.getPipelines,"402c32ae03922b8aff0b67716fb87605642af1473d",()=>b.saveActivityLogsNotification,"402f4e6ce146c6909eb3b7ac350029a26767d81841",()=>b.getNotificationAndUser,"40464f6453247197f55b96edcbb5a1d00b3b500f33",()=>b.updateUser,"404caad7b3e9672c996e73f2ca0dba9e342c170c8a",()=>b.updateTicketsOrder,"404ea5b9155dd902278d972e5c20db2bb448aeb133",()=>b.getAgencyDetails,"4058dd16912221e47a0e54216aa0630605d7010e35",()=>d.listRoles,"4063512e798b414bc92251ef0e143266d7d5e1c89a",()=>b.deletePipeline,"406c5fc4251144c4ed24b6fb601d2010b42f4f4a7e",()=>d.getAvailablePermissionsForAgency,"406c859da689cb2994938b20aed5761952acc99b95",()=>b.deleteSubAccount,"406cf1ec3523ce4da24b42101cb151145c5531068f",()=>b.getSidebarOptions,"407211c770e8ae4b42fae1866fa9494bcbe94c0003",()=>d.getAvailablePermissions,"407a743af356a29e451848f4baf3def27ed5b49195",()=>b.deleteTag,"407cda76255e4cfc5440d67e09584c5b9cdd24feb3",()=>b.upsertSubAccount,"4084e2731c3c7df9a62d352d4cbfcaa38c119f3981",()=>b.getDomainContent,"4088e95668949fec43518c05c26a99814bcea93bed",()=>b.getLanesWithTicketAndTags,"408c23a8863d2d78b2138161fdcb1bcb273da055d3",()=>b.getUser,"408eb7456c165ba4e15a848d097e769d44a35f473f",()=>b.getUserByEmail,"40946d547cd34a45dc3c88e75c0018904de1bb0e20",()=>b.getMedia,"409803f7ade07abe17217434dfcb1846bb0de68466",()=>b.deleteFunnelePage,"40996a5c4c000ca54c359410869f5ca450569b0664",()=>b.createAuthenticator,"409ad3b3d19f7e1e4b96a99490fd6a8f2f69159dfc",()=>d.getAvailablePermissionsForContext,"409f71f693b0cc160f33a3d48a4870a8c238a815d5",()=>d.getRole,"409feba97418d61bf67ccd13c453bb92e5e40e3d5f",()=>b.deleteMedia,"40a1e28a23207fcf3af24e3c3dc2f2a257e66e8663",()=>b._getTicketsWithAllRelations,"40a3af75e5658e63d0b03b53d5bdd7afe68b41d835",()=>b.deleteLane,"40ac5af3373e707fb53a5046ad1b5bc92d948561f4",()=>d.getAvailablePermissionsForSubAccount,"40ae9d6f949932572fabd4db4ffcad8fbb3c48c796",()=>b.deleteTicket,"40afefaeeec7e180b2150952c6245813a74f8c288b",()=>b.getPipelineDetails,"40b536b34e4d7b9cc6d45d0ce0d95966e871939849",()=>b.createTeamUser,"40b544198e1f7236e82f13511d1ea04dec8879cd8a",()=>b.getTicketsWithTags,"40b9f17856ba42589392b154988915b9e88c7677c4",()=>b.getSubaccountDetails,"40c8c52330fd70722632becec00a6fe0a45beaa5b9",()=>b.updateLanesOrder,"40cb32ccf449e1945ab2d6b68d0cb192c92a577eb0",()=>b.upsertPipeline,"40cd33cb60d2d463b6ce611d088999e488b8d98eaa",()=>b.getFunnel,"40ceed85dfe88eae70e19470ef9b072cf15ab6f7d5",()=>b.deleteVerificationToken,"40d54bd414469e40ff3b9278e05b5e53ff02ef900a",()=>b.hasPermission,"40dd9180ffa6d0eee7bcfe7b8cc08cae627050dbe2",()=>b.deleteAuthenticator,"40e51d68b438f17edf32546f9f97489656804bcef9",()=>b.getAuthenticator,"40e651e7eca04d15cef3549848ef79f97e7914e9da",()=>b.upsertLane,"40fce1e268ac6d8673a0cb6377fd8a39251144f6b3",()=>b.getVerificationToken,"40fdae98fa52de3fc80204287d341014b32b4e0853",()=>b.deleteAgency,"40fe3ff1c0ed56ee8308911a18787188c237167858",()=>b.getUsersWithAgencySubAccountPermissionsSidebarOptions,"6011a8992cb92945c217ee1eca1e244c9bf9fe7c6e",()=>d.createRole,"6024d28dd8c41bdfd82928362b40bbaec87712525d",()=>b.getRoles,"6048ac5f66daa971d848541856a363368cf449f79e",()=>b.getMemberships,"6061c914d9f381680be9fec9fcc85274d55a07362e",()=>b.upsertTicket,"6064f866a50c73160123a784f3c783f4dd84497763",()=>c.syncSubscriptionStatus,"606d1b955de2203579b8b8270c5546fce95a1461c3",()=>d.updateRole,"606e68984bfc7c4dd372fb7eaec13c366b6d7ea801",()=>b.updateFunnelProducts,"60760475caf56aba00693d5e265157d944e2584156",()=>b.updateAgencyDetails,"60992b8fda983bcd83ba33d1fd807d88959a461f70",()=>b.getRolePermissions,"609c9061f9a7176473d2ccc06f4250eeddf6f8e596",()=>b.updateAuthenticatorCounter,"60ae9e9ff5d91aa0a6f693f97d22098c5f6bc42625",()=>b.createMedia,"60c979ec615f4dd6cedab1c5229bbc9aa68416db12",()=>c.listDunningInvoices,"60dcf3e67b55ea387f7c9591b44ed0df3d6a403b82",()=>c.listInvoices,"60f7060127e2ca4c5b7c46c36c80b5a573f2ad01c7",()=>b.upsertTag,"60fe1d98610af4fb0b4d1bd574e6cd26a9d3a4edee",()=>b.upsertAgency,"703b820f754dbf26ce5a2eb3e694e89ed46e4746b4",()=>b.upsertFunnelPage,"7047958315d032829b8c444890acd418149a8c123a",()=>b.initUser,"704ec26aac1ae7f8cb08a0bd240a8a07e832cd2722",()=>b.upsertFunnel,"70a35c354b249ca8d4ec27566ac7e0441e1eb56ae7",()=>b.updateAgencyMemberRole,"70a3dcc70ad49bc7da68741623c689c11b8aedcb0e",()=>b.updateSubAccountMemberRole,"70b4a41a47ec38674b36f04a6549c4e13e752da1aa",()=>b.createVerificationToken,"70ed19aa243962c8037125bfca4be72749e6084eb1",()=>b.getRolesByScope,"78ad81a6e1de1868e437272fe4aa970da1f3fc95c1",()=>c.updateSubscriptionPlan,"7cb46d661f84facf408ef8a0892198195c87a636b7",()=>b.sendInvitation,"7ce77e2f8558484be720070be666097800d1d54b31",()=>b.changeUserPermissions,"7e223992728428fd80f797222fa917d6246279b867",()=>b.upsertRole],135522)}];

//# sourceMappingURL=_b4188dde._.js.map