module.exports=[346170,528355,a=>{"use strict";a.i(537150);var b=a.i(860023);b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.STARTER,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.BASIC,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.ADVANCED,b.PRICE_IDS.PRIORITY_SUPPORT,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_GL,b.PRICE_IDS.FI_AR,b.PRICE_IDS.FI_AP,b.PRICE_IDS.FI_BL,b.PRICE_IDS.FI_BL,b.PRICE_IDS.FI_FS,b.PRICE_IDS.CO_CCA,b.PRICE_IDS.CO_CCA,b.PRICE_IDS.CO_CCA,b.PRICE_IDS.CO_CCA,b.PRICE_IDS.CO_PCA,b.PRICE_IDS.CO_PCA,b.PRICE_IDS.CO_PCA,b.PRICE_IDS.CO_PA,b.PRICE_IDS.CO_PA,b.PRICE_IDS.CO_BUDGET,b.PRICE_IDS.CO_BUDGET,b.PRICE_IDS.CO_CCA,a.s([],346170),a.i(155781),a.i(570396);var c=a.i(673727),d=a.i(733199);a.i(577607),a.i(254799),a.i(761469);class e extends Error{constructor(a){super(a),this.name="AuthzError"}}let f=a=>a.trim(),g=(a,b,d)=>{if("notFound"===a&&(0,c.notFound)(),"throw"===a)throw new e(d);(0,c.redirect)(b)},h=async a=>{let b=a.failMode??"redirect",c=a.redirectTo??"/",d=a.permissionKeys.map(f),e=a.requiredKeys.map(f).filter(Boolean);e.every(a=>d.includes(a))||g(b,c,`Missing permissions: ${e.join(", ")}`)},i=async a=>{let b=a.failMode??"redirect",c=a.redirectTo??"/agency/sign-in",e=a.billingPermissionKey??"core.billing.account.view",f=await (0,d.resolveCurrentAgencyContext)({agencyId:a.agencyId});if(!f)return g(b,c,"No agency membership");let i=a.permissionKeys?.length?a.permissionKeys:a.permissionKey?[a.permissionKey]:["core.agency.account.read"];if(await h({permissionKeys:f?.permissionKeys||[],requiredKeys:i,failMode:b,redirectTo:c}),(a.requireActiveSubscription??!0)&&"ACTIVE"!==f.subscriptionState){let b=f.permissionKeys.includes(e);g("redirect",a.subscriptionRedirectTo?.({agencyId:f.agencyId,canManageBilling:b})??(b?`/agency/${f.agencyId}/billing?action=renew`:`/agency/${f.agencyId}/subscription`),"Inactive or missing subscription")}return f},j=async a=>{let b=a.failMode??"redirect",c=a.redirectTo??"/agency/sign-in",e=a.billingPermissionKey??"core.billing.account.view",f=await (0,d.resolveCurrentSubAccountContext)({subAccountId:a.subAccountId});if(!f)return g(b,c,"No subaccount membership");let i=a.permissionKeys?.length?a.permissionKeys:a.permissionKey?[a.permissionKey]:["core.subaccount.account.read"];if(await h({permissionKeys:f.permissionKeys,requiredKeys:i,failMode:b,redirectTo:c}),(a.requireActiveAgencySubscription??!0)&&"ACTIVE"!==await (0,d.getAgencySubscriptionState)(f.agencyId)){let b=await (0,d.resolveCurrentAgencyContext)({agencyId:f.agencyId}),c=!!b?.permissionKeys.includes(e);g("redirect",a.subscriptionRedirectTo?.({agencyId:f.agencyId,canManageBilling:c})??(c?`/agency/${f.agencyId}/billing?action=renew`:`/agency/${f.agencyId}/subscription`),"Inactive or missing agency subscription")}return f};a.s(["requireAgencyAccess",0,i,"requireSubAccountAccess",0,j],528355)},167541,a=>{"use strict";a.i(155781);var b=a.i(254799);a.i(659281);var c=a.i(761771),d=a.i(761469),e=a.i(973831);let f=[{key:"support",label:"Support Center",description:"Guided troubleshooting, diagnostics, and support tickets.",isCore:!0},{key:"integrations",label:"Integrations",description:"Connect providers, manage API keys, and configure outbound webhooks.",isCore:!0},{key:"webhooks",label:"Webhooks",description:"Outbound webhook subscriptions, deliveries, and replay tooling.",isCore:!0}];class g extends Error{status;code;constructor(a){super(a.message),this.name="AppServiceError",this.status=a.status,this.code=a.code}}let h=a=>f.find(b=>b.key===a)??null;async function i(a){return a.subAccountId?await d.db.$queryRaw(c.Prisma.sql`SELECT "appKey","status","installedAt","updatedAt"
                FROM "AppInstallation"
                WHERE "agencyId" = ${a.agencyId} AND "subAccountId" = ${a.subAccountId}`):await d.db.$queryRaw(c.Prisma.sql`SELECT "appKey","status","installedAt","updatedAt"
              FROM "AppInstallation"
              WHERE "agencyId" = ${a.agencyId} AND "subAccountId" IS NULL`)}async function j(a){let b=a.item.requiredFeatureKeys??[];if(0===b.length)return!0;let c=await (0,e.resolveEffectiveEntitlements)({agencyId:a.agencyId,subAccountId:a.subAccountId??null,scope:a.scope,planId:null,now:null}),d=Object.values(c);if(!c||0===d.length)return!1;let f=new Set(d.filter(a=>a.isEnabled).map(a=>a.featureKey));return!!b.some(a=>d.some(b=>b.featureKey===a))&&b.some(a=>f.has(a))}async function k(a){let b=new Map;try{let c=await i({agencyId:a.agencyId,subAccountId:a.subAccountId??null});b=new Map(c.map(a=>[String(a.appKey),a]))}catch{b=new Map}let c=[];for(let e of f){var d;let f=b.get(e.key);if(e.isCore){c.push({...e,state:"INSTALLED",installedAt:f?.installedAt??null,entitled:!0,canInstall:!1,canUninstall:!1});continue}let g=!1;try{g=await j({item:e,agencyId:a.agencyId,subAccountId:a.subAccountId??null,scope:a.meteringScope})}catch{g=!1}let h=f?.status??("integrations"===(d=e.key)||"webhooks"===d?"INSTALLED":"AVAILABLE");g&&f||(h="AVAILABLE"),c.push({...e,state:h,installedAt:f?.installedAt??null,entitled:g,canInstall:g&&"INSTALLED"!==h,canUninstall:"INSTALLED"===h})}return c}async function l(a){let e=h(a.appKey);if(!e)throw new g({status:404,code:"UNKNOWN_APP",message:`Unknown appKey: ${a.appKey}`});if(e.isCore)return{appKey:a.appKey,status:"INSTALLED"};if(await n(),!await j({item:e,agencyId:a.agencyId,subAccountId:a.subAccountId??null,scope:{subAccountId:a.subAccountId??null}.subAccountId?"SUBACCOUNT":"AGENCY"}))throw new g({status:402,code:"NOT_ENTITLED",message:"App is not included in current plan entitlements"});let f=b.default.randomUUID(),i=new Date,k="INSTALLED",l=a.subAccountId?c.Prisma.sql`"subAccountId" = ${a.subAccountId}`:c.Prisma.sql`"subAccountId" IS NULL`;return await d.db.$executeRaw(c.Prisma.sql`INSERT INTO "AppInstallation" ("id","appKey","agencyId","subAccountId","status","installedAt","createdAt","updatedAt")
              VALUES (${f}, ${a.appKey}, ${a.agencyId}, ${a.subAccountId??null}, ${k}, ${i}, ${i}, ${i})
              ON CONFLICT DO NOTHING`),await d.db.$executeRaw(c.Prisma.sql`UPDATE "AppInstallation"
              SET "status" = ${k},
                  "installedAt" = COALESCE("installedAt", ${i}),
                  "uninstalledAt" = NULL,
                  "updatedAt" = ${i}
              WHERE "agencyId" = ${a.agencyId}
                AND "appKey" = ${a.appKey}
                AND ${l}`),{appKey:a.appKey,status:"INSTALLED"}}async function m(a){let b=h(a.appKey);if(!b)throw new g({status:404,code:"UNKNOWN_APP",message:`Unknown appKey: ${a.appKey}`});if(b.isCore)throw new g({status:400,code:"CORE_APP",message:"Core apps cannot be uninstalled"});await n();let e=new Date,f=a.subAccountId?c.Prisma.sql`"subAccountId" = ${a.subAccountId}`:c.Prisma.sql`"subAccountId" IS NULL`;return await d.db.$executeRaw(c.Prisma.sql`UPDATE "AppInstallation"
              SET "status" = 'AVAILABLE',
                  "uninstalledAt" = ${e},
                  "updatedAt" = ${e}
              WHERE "agencyId" = ${a.agencyId}
                AND "appKey" = ${a.appKey}
                AND ${f}`),{appKey:a.appKey,status:"AVAILABLE"}}async function n(){let a=await d.db.$queryRaw(c.Prisma.sql`SELECT to_regclass('public."AppInstallation"') AS "reg"`);if(!(a?.[0]?.reg??a?.[0]?.Reg??a?.[0]?.REG))throw new g({status:500,code:"MIGRATION_MISSING",message:"AppInstallation table is not present. Apply migrations (prisma migrate) first."})}a.s(["AppServiceError",()=>g,"installApp",()=>l,"listAppsWithState",()=>k,"uninstallApp",()=>m],167541)},852875,a=>{"use strict";var b=a.i(137936),c=a.i(118558);a.i(570396);var d=a.i(673727);a.i(346170);var e=a.i(537150),f=a.i(528355),g=a.i(167541);let h=async function(a){let b=String(a.get("agencyId")||""),h=String(a.get("appKey")||"");if(b&&h){await (0,f.requireAgencyAccess)({agencyId:b,permissionKeys:[e.KEYS.core.apps.app.manage],requireActiveSubscription:!0,redirectTo:`/agency/${b}/apps`});try{await (0,g.installApp)({appKey:h,agencyId:b,subAccountId:null})}catch(a){throw a instanceof g.AppServiceError&&"NOT_ENTITLED"===a.code&&(0,d.redirect)(`/agency/${b}/billing?action=upgrade&app=${encodeURIComponent(h)}`),a}(0,c.revalidatePath)(`/agency/${b}/apps`),(0,c.revalidatePath)(`/agency/${b}/apps/${h}`)}};(0,b.registerServerReference)(h,"40735ae42c2a3cfecabf4ae9c1fa8b7d7a50bd7470",null);let i=async function(a){let b=String(a.get("agencyId")||""),d=String(a.get("appKey")||"");b&&d&&(await (0,f.requireAgencyAccess)({agencyId:b,permissionKeys:[e.KEYS.core.apps.app.manage],requireActiveSubscription:!0,redirectTo:`/agency/${b}/apps`}),await (0,g.uninstallApp)({appKey:d,agencyId:b,subAccountId:null}),(0,c.revalidatePath)(`/agency/${b}/apps`),(0,c.revalidatePath)(`/agency/${b}/apps/${d}`))};(0,b.registerServerReference)(i,"40e193c18f6f38789378711a58c1c70c79609a9dbc",null);let j=async function(a){let b=String(a.get("subAccountId")||""),h=String(a.get("appKey")||"");if(!b||!h)return;let i=await (0,f.requireSubAccountAccess)({subAccountId:b,permissionKeys:[e.KEYS.core.apps.app.manage],requireActiveAgencySubscription:!0,redirectTo:`/subaccount/${b}/apps`});try{await (0,g.installApp)({appKey:h,agencyId:i.agencyId,subAccountId:b})}catch(a){throw a instanceof g.AppServiceError&&"NOT_ENTITLED"===a.code&&(0,d.redirect)(`/agency/${i.agencyId}/billing?action=upgrade&app=${encodeURIComponent(h)}`),a}(0,c.revalidatePath)(`/subaccount/${b}/apps`),(0,c.revalidatePath)(`/subaccount/${b}/apps/${h}`)};(0,b.registerServerReference)(j,"409b28247151a308a790c31d7b19c5b69cbe330ceb",null);let k=async function(a){let b=String(a.get("subAccountId")||""),d=String(a.get("appKey")||"");if(!b||!d)return;let h=await (0,f.requireSubAccountAccess)({subAccountId:b,permissionKeys:[e.KEYS.core.apps.app.manage],requireActiveAgencySubscription:!0,redirectTo:`/subaccount/${b}/apps`});await (0,g.uninstallApp)({appKey:d,agencyId:h.agencyId,subAccountId:b}),(0,c.revalidatePath)(`/subaccount/${b}/apps`),(0,c.revalidatePath)(`/subaccount/${b}/apps/${d}`)};(0,b.registerServerReference)(k,"408c99a14936cc5e39d0f8f78a295f435c0b88063a",null),a.s(["$$RSC_SERVER_ACTION_0",0,h,"$$RSC_SERVER_ACTION_1",0,i,"$$RSC_SERVER_ACTION_2",0,j,"$$RSC_SERVER_ACTION_3",0,k,"installAppAgencyAction",()=>h,"installAppSubAccountAction",()=>j,"uninstallAppAgencyAction",()=>i,"uninstallAppSubAccountAction",()=>k])}];

//# sourceMappingURL=src_lib_f3a23fef._.js.map