module.exports=[907935,e=>{"use strict";var t=e.i(747909),n=e.i(174017),r=e.i(996250),i=e.i(759756),s=e.i(561916),a=e.i(174677),o=e.i(869741),c=e.i(316795),u=e.i(487718),d=e.i(995169),l=e.i(47587),p=e.i(666012),h=e.i(570101),b=e.i(626937),_=e.i(10372),m=e.i(193695);e.i(52474);var f=e.i(600220),g=e.i(843793),R=e.i(445147),w=e.i(89171);async function y(e){try{let{action:t,customerId:n,agencyId:r,priceId:i,coupon:s,paymentMethodId:a,trialEnabled:o,trialPeriodDays:c,prorationBehavior:u}=await e.json();if(!t||!n||!r)return w.NextResponse.json({error:"action, customerId, and agencyId are required"},{status:400});let d=await g.db.agency.findUnique({where:{id:r},include:{Subscription:!0}});if(!d)return w.NextResponse.json({error:"Agency not found"},{status:404});if(d.customerId!==n)return w.NextResponse.json({error:"Agency does not belong to this customer"},{status:403});switch(t){case"create":return await S({customerId:n,agencyId:r,priceId:i,coupon:s,paymentMethodId:a,trialEnabled:o,trialPeriodDays:c,existingSubscription:d.Subscription});case"update":return await x({customerId:n,agencyId:r,priceId:i,coupon:s,prorationBehavior:u,existingSubscription:d.Subscription});case"cancel":return await v({agencyId:r,existingSubscription:d.Subscription});default:return w.NextResponse.json({error:`Invalid action: ${t}. Must be 'create', 'update', or 'cancel'`},{status:400})}}catch(t){console.error("ðŸ”´ Subscription action error:",t);let e=t instanceof Error?t.message:"Unknown error";return w.NextResponse.json({error:"Failed to process subscription action",details:e},{status:500})}}async function S(e){let{customerId:t,agencyId:n,priceId:r,coupon:i,paymentMethodId:s,trialEnabled:a,trialPeriodDays:o,existingSubscription:c}=e;if(!r)return w.NextResponse.json({error:"priceId is required for create action"},{status:400});if(c)return w.NextResponse.json({error:"Agency already has a subscription. Use action=update to change plans."},{status:400});if(s){console.log("ðŸ’³ Attaching payment method to customer:",s);try{await R.stripe.paymentMethods.attach(s,{customer:t}),await R.stripe.customers.update(t,{invoice_settings:{default_payment_method:s}}),console.log("âœ… Payment method attached and set as default")}catch(e){console.error("âš ï¸ Failed to attach payment method:",e)}}console.log("âœ¨ Creating new subscription for agency:",n);let u=await R.stripe.subscriptions.create({customer:t,items:[{price:r}],payment_behavior:a?"default_incomplete":"error_if_incomplete",payment_settings:{save_default_payment_method:"on_subscription",payment_method_types:["card"]},metadata:{agencyId:n},expand:["latest_invoice.payment_intent","pending_setup_intent"],...i&&{coupon:i},...a&&o&&{trial_period_days:o}});if(console.log("ðŸ“ Subscription created:",{id:u.id,status:u.status,trialEnd:u.trial_end,agencyId:n}),u.trial_end&&u.trial_end>Math.floor(Date.now()/1e3)){let e=u.pending_setup_intent;return e?.client_secret?w.NextResponse.json({subscriptionId:u.id,clientSecret:e.client_secret,status:u.status,action:"create",requiresSetup:!0,trialEnd:u.trial_end}):w.NextResponse.json({subscriptionId:u.id,status:u.status,action:"create",message:`Trial started - free until ${new Date(1e3*(u.trial_end||0)).toLocaleDateString()}`,trialEnd:u.trial_end})}let d=u.latest_invoice,l=d?.payment_intent;if(l?.client_secret)return w.NextResponse.json({subscriptionId:u.id,clientSecret:l.client_secret,status:u.status,action:"create",requiresSetup:!1});if(d?.status==="paid"||d?.amount_due===0)return w.NextResponse.json({subscriptionId:u.id,status:u.status,action:"create",message:"Subscription activated without payment"});let p=await R.stripe.setupIntents.create({customer:t,payment_method_types:["card"],usage:"off_session"});return w.NextResponse.json({subscriptionId:u.id,clientSecret:p.client_secret,status:u.status,action:"create",requiresSetup:!0})}async function x(e){let{agencyId:t,priceId:n,coupon:r,prorationBehavior:i,existingSubscription:s}=e;if(!n)return w.NextResponse.json({error:"priceId is required for update action"},{status:400});if(!s?.subscritiptionId)return w.NextResponse.json({error:"No existing subscription found. Use action=create to start a subscription."},{status:400});let a=s.subscritiptionId;console.log("ðŸ”„ Updating subscription:",a,"to price:",n);let o=await R.stripe.subscriptions.retrieve(a),c=o.items.data[0]?.id;if(!c)return w.NextResponse.json({error:"Could not find subscription item to update"},{status:500});let u=await R.stripe.subscriptions.update(a,{items:[{id:c,price:n}],proration_behavior:i??"create_prorations",metadata:{agencyId:t},expand:["latest_invoice.payment_intent"],...r&&{coupon:r}});console.log("âœ… Subscription updated:",{id:u.id,status:u.status,newPrice:n});let d=u.latest_invoice,l=d?.payment_intent;return l?.client_secret&&"requires_payment_method"===l.status?w.NextResponse.json({subscriptionId:u.id,clientSecret:l.client_secret,status:u.status,action:"update",message:"Payment required for plan upgrade",requiresPayment:!0}):w.NextResponse.json({subscriptionId:u.id,status:u.status,action:"update",message:"Subscription plan updated successfully",prorationApplied:"none"!==i})}async function v(e){let{agencyId:t,existingSubscription:n}=e;if(!n?.subscritiptionId)return w.NextResponse.json({error:"No existing subscription found to cancel"},{status:400});let r=n.subscritiptionId;console.log("ðŸš« Cancelling subscription at period end:",r);let i=await R.stripe.subscriptions.update(r,{cancel_at_period_end:!0,metadata:{agencyId:t,cancelledAt:new Date().toISOString()}}),s=i.items.data[0]?.current_period_end||0;console.log("âœ… Subscription scheduled for cancellation:",{id:i.id,cancel_at_period_end:i.cancel_at_period_end,current_period_end:s}),await g.db.subscription.update({where:{agencyId:t},data:{cancelAtPeriodEnd:!0}});let a=new Date(1e3*s);return w.NextResponse.json({subscriptionId:i.id,status:i.status,action:"cancel",cancelAtPeriodEnd:!0,periodEndDate:a.toISOString(),message:`Subscription will remain active until ${a.toLocaleDateString()}. No refund will be issued.`})}async function E(e){let t=new URL(e.url).searchParams.get("agencyId");if(!t)return w.NextResponse.json({error:"agencyId is required"},{status:400});let n=await g.db.agency.findUnique({where:{id:t},include:{Subscription:!0}});if(!n)return w.NextResponse.json({error:"Agency not found"},{status:404});if(!n.Subscription?.subscritiptionId)return w.NextResponse.json({hasSubscription:!1,agencyId:t});try{let e=await R.stripe.subscriptions.retrieve(n.Subscription.subscritiptionId),r=e.items.data[0];return w.NextResponse.json({hasSubscription:!0,agencyId:t,subscription:{id:e.id,status:e.status,priceId:r?.price?.id,currentPeriodEnd:r?.current_period_end?new Date(1e3*r.current_period_end).toISOString():null,cancelAtPeriodEnd:e.cancel_at_period_end,trialEnd:e.trial_end?new Date(1e3*e.trial_end).toISOString():null}})}catch(e){return console.error("Error retrieving subscription from Stripe:",e),w.NextResponse.json({hasSubscription:!0,agencyId:t,subscription:{id:n.Subscription.subscritiptionId,status:n.Subscription.status,priceId:n.Subscription.priceId,currentPeriodEnd:n.Subscription.currentPeriodEndDate?.toISOString(),cancelAtPeriodEnd:n.Subscription.cancelAtPeriodEnd,error:"Could not sync with Stripe"}})}}e.s(["GET",()=>E,"POST",()=>y],27672);var N=e.i(27672);let I=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/stripe/subscription/route",pathname:"/api/stripe/subscription",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/stripe/subscription/route.ts",nextConfigOutput:"standalone",userland:N}),{workAsyncStorage:A,workUnitAsyncStorage:C,serverHooks:P}=I;function j(){return(0,r.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:C})}async function O(e,t,r){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/stripe/subscription/route";g=g.replace(/\/index$/,"")||"/";let R=await I.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:y,nextConfig:S,parsedUrl:x,isDraftMode:v,prerenderManifest:E,routerServerContext:N,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,resolvedPathname:P,clientReferenceManifest:j,serverActionsManifest:O}=R,T=(0,o.normalizeAppPath)(g),q=!!(E.dynamicRoutes[T]||E.routes[P]),D=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,x,!1):t.end("This page could not be found"),null);if(q&&!v){let e=!!E.routes[P],t=E.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await D();throw new m.NoFallbackError}}let U=null;!q||I.isDev||v||(U="/index"===(U=P)?"/":U);let H=!0===I.isDev||!q,M=q&&!H;O&&j&&(0,a.setManifestsSingleton)({page:g,clientReferenceManifest:j,serverActionsManifest:O});let k=e.method||"GET",$=(0,s.getTracer)(),F=$.getActiveScopeSpan(),K={params:y,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,i)=>I.onRequestError(e,t,r,i,N)},sharedContext:{buildId:w}},L=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let a=async e=>I.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=$.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${g}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var s,c;let u=async({previousCacheEntry:n})=>{try{if(!o&&A&&C&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let c=K.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let u=K.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(L,B,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[_.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},!1,N),t}},d=await I.handleResponse({req:e,nextConfig:S,cacheKey:U,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:o});if(!q)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&q||m.delete(_.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,b.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(L,B,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};F?await c(F):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${k} ${g}`,kind:s.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},c))}catch(t){if(t instanceof m.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},!1,N),q)throw t;return await (0,p.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>j,"routeModule",()=>I,"serverHooks",()=>P,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>C],907935)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_c2d90f83.js.map